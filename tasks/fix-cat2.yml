---
### RHEL-07-010030 | RHEL-07-010040 combined as related tasks in regards to a config file no other content will be in.
- name: "MEDIUM | RHEL-07-010030 | RHEL-07-010040 | PATCH | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a graphical user logon."
  copy:
    dest: /etc/dconf/db/local.d/01-banner-message
    content: |
        [org/gnome/login-screen]
        banner-message-enable=true
        banner-message-text='{{ rhel7stig_logon_banner | replace(newline, "\n") }}'
    mode: '0644'
  vars:
    newline: "\n"
  notify: dconf update
  when:
  - rhel7stig_dconf_available
  - rhel_07_010030
  - rhel_07_010040
  tags:
  - RHEL-07-010030
  - RHEL_07_010040
  - dod_logon_banner

- name: "MEDIUM | RHEL-07-010050 | PATCH | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a command line user logon."
  copy:
    content: "{{ rhel7stig_logon_banner }}"
    dest: "{{ item }}"
    owner: root
    group: root
    mode: 0644
  when:
  - rhel_07_010050
  - rhel7stig_ssh_required
  with_items:
  - /etc/issue
  - /etc/issue.net
  tags:
  - RHEL-07-010050
  - ssh
  - dod_logon_banner

- name: "MEDIUM | RHEL-07-010060 | PATCH | The Red Hat Enterprise Linux operating system must enable a user session lock until that user re-establishes access using established identification and authentication procedures."
  copy:
    dest: /etc/dconf/db/local.d/00-screensaver_rhel_07_010060
    content: |
      [org/gnome/desktop/screensaver]
      lock-enabled=true
    mode: '0644'
  notify: dconf update
  when:
  - rhel7stig_dconf_available
  - rhel_07_010060
  tags:
  - RHEL-07-010060

- name: "MEDIUM | RHEL-07-010061 | PATCH | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate users using multifactor authentication via a graphical user logon."
  copy:
    dest: /etc/dconf/db/local.d/00-defaults_rhel_07_010061
    content: |
      [org/gnome/login-screen]
      enable-smartcard-authentication=true
    mode: '0644'
  notify: dconf update
  when:
  - rhel7stig_dconf_available
  - rhel_07_010061
  tags:
  - RHEL-07-010061

- name: "MEDIUM | RHEL-07-010062 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver lock-enabled setting for the graphical user interface."
  copy:
    dest: /etc/dconf/db/local.d/locks/session_rhel_07_010062
    content: |
      /org/gnome/desktop/screensaver/lock-enabled
    mode: '0644'
  notify: dconf update
  when:
  - rhel7stig_dconf_available
  - rhel_07_010062
  tags:
  - RHEL-07-010062

- name: "MEDIUM | RHEL-07-010070 | PATCH | The Red Hat Enterprise Linux operating system must initiate a screensaver after a 15-minute period of inactivity for graphical user interfaces."
  copy:
    dest: /etc/dconf/db/local.d/00-screensaver_rhel_07_010070
    content: |
      [org/gnome/desktop/session]
      idle-delay=uint32 900
    mode: '0644'
  notify: dconf update
  when:
  - rhel7stig_dconf_available
  - rhel_07_010070
  tags:
  - RHEL-07-010070

- name: "MEDIUM | RHEL-07-010081 | PATCH | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver lock-delay setting for the graphical user interface."
  copy:
    dest: /etc/dconf/db/local.d/locks/session_rhel_07_010081
    content: |
      /org/gnome/desktop/screensaver/lock-delay
    mode: '0644'
  notify: dconf update
  when:
  - rhel7stig_dconf_available
  - rhel_07_010081
  tags:
  - RHEL-07-010081

- name: "MEDIUM | RHEL-07-010082 | PATCH | The Red Hat Enterprise Linux operating system must prevent a user from overriding the session idle-delay setting for the graphical user interface."
  copy:
    dest: /etc/dconf/db/local.d/locks/session_rhel_07_010082
    content: |
      /org/gnome/desktop/session/idle-delay
    mode: '0644'
  notify: dconf update
  when:
  - rhel7stig_dconf_available
  - rhel_07_010082
  tags:
  - RHEL-07-010082

- name: "MEDIUM | RHEL-07-010100 | PATCH | The Red Hat Enterprise Linux operating system must initiate a session lock for the screensaver after a period of inactivity for graphical user interfaces."
  copy:
    dest: /etc/dconf/db/local.d/00-screensaver_rhel_07_010100
    content: |
      [org/gnome/desktop/screensaver]
      idle-activation-enabled=true
    mode: '0644'
  notify: dconf update
  when:
  - rhel7stig_dconf_available
  - rhel_07_010100
  tags:
  - RHEL-07-010100

- name: "MEDIUM | RHEL-07-010101 | PATCH | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver idle-activation-enabled setting for the graphical user interface."
  copy:
    dest: /etc/dconf/db/local.d/locks/session_rhel_07_010101
    content: |
      /org/gnome/desktop/screensaver/idle-activation-enabled
    mode: '0644'
  notify: dconf update
  when:
  - rhel7stig_dconf_available
  - rhel_07_010101
  tags:
  - RHEL-07-010101

- name: "MEDIUM | RHEL-07-010110 | PATCH | The Red Hat Enterprise Linux operating system must initiate a session lock for graphical user interfaces when the screensaver is activated."
  copy:
    dest: /etc/dconf/db/local.d/00-screensaver_rhel_07_010110
    content: |
      [org/gnome/desktop/screensaver]
      lock-delay=uint32 900
    mode: '0644'
  register: rhel_07_010110
  notify: dconf update
  when:
  - rhel7stig_dconf_available
  - rhel_07_010110
  tags:
  - RHEL-07-010110

- name: "MEDIUM | RHEL-07-010118 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that /etc/pam.d/passwd implements /etc/pam.d/system-auth when changing passwords."
  lineinfile:
    path: /etc/pam.d/passwd
    regexp: '^password   substack     system-auth'
    line: 'password   substack     system-auth'
  when:
  - rh_07_010118
  - ansible_distribution == "OracleLinux"
  tags:
  - RHEL-07-010118
  - pamd

- name: "MEDIUM | RHEL-07-010119 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used."
  lineinfile:
    create: yes
    dest: /etc/pam.d/system-auth
    regexp: '^#?password required pam_pwquality.so retry'
    line: password required pam_pwquality.so retry=3
  when: rhel_07_010119
  tags:
  - RHEL-07-010119

- name: "MEDIUM | RHEL-07-010120 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one upper-case character."
  lineinfile:
    create: yes
    dest: /etc/security/pwquality.conf
    regexp: '^#?\s*ucredit'
    line: "ucredit = {{ rhel7stig_password_complexity.ucredit | default('-1') }}"
  when: rhel_07_010120
  tags:
  - RHEL-07-010120
  - pwquality

- name: "MEDIUM | RHEL-07-010130 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one lower-case character."
  lineinfile:
    create: yes
    dest: /etc/security/pwquality.conf
    regexp: '^#?\s*lcredit'
    line: "lcredit = {{ rhel7stig_password_complexity.lcredit | default('-1') }}"
  when: rhel_07_010130
  tags:
  - RHEL-07-010130
  - pwquality

- name: "MEDIUM | RHEL-07-010140 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are assigned, the new password must contain at least one numeric character."
  lineinfile:
    create: yes
    dest: /etc/security/pwquality.conf
    regexp: '^#?\s*dcredit'
    line: "dcredit = {{ rhel7stig_password_complexity.dcredit | default('-1') }}"
  when: rhel_07_010140
  tags:
  - RHEL-07-010140
  - pwquality

- name: "MEDIUM | RHEL-07-010150 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one special character."
  lineinfile:
    create: yes
    dest: /etc/security/pwquality.conf
    regexp: '^#?\s*ocredit'
    line: "ocredit = {{ rhel7stig_password_complexity.ocredit | default('-1') }}"
  when: rhel_07_010150
  tags:
  - RHEL-07-010150
  - pwquality

- name: "MEDIUM | RHEL-07-010160 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed a minimum of eight of the total number of characters must be changed."
  lineinfile:
    create: yes
    dest: /etc/security/pwquality.conf
    regexp: '^#?\s*difok'
    line: "difok = {{ rhel7stig_password_complexity.difok | default('8') }}"
  when: rhel_07_010160
  tags:
  - RHEL-07-010160
  - pwquality

- name: "MEDIUM | RHEL-07-010170 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed a minimum of four character classes must be changed."
  lineinfile:
    create: yes
    dest: /etc/security/pwquality.conf
    regexp: '^#?\s*minclass'
    line: "minclass = {{ rhel7stig_password_complexity.minclass | default('4') }}"
  when: rhel_07_010170
  tags:
  - RHEL-07-010170
  - pwquality

- name: "MEDIUM | RHEL-07-010180 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed the number of repeating consecutive characters must not be more than three characters."
  lineinfile:
    create: yes
    dest: /etc/security/pwquality.conf
    regexp: '^#?\s*maxrepeat'
    line: "maxrepeat = {{ rhel7stig_password_complexity.maxrepeat | default('3') }}"
  when: rhel_07_010180
  tags:
  - RHEL-07-010180
  - pwquality

- name: "MEDIUM | RHEL-07-010190 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed the number of repeating characters of the same character class must not be more than four characters."
  lineinfile:
    create: yes
    dest: /etc/security/pwquality.conf
    regexp: '^#?\s*maxclassrepeat'
    line: "maxclassrepeat = {{ rhel7stig_password_complexity.maxclassrepeat | default('4') }}"
  when: rhel_07_010190
  tags:
  - RHEL-07-010190
  - pwquality

- name: "MEDIUM | RHEL-07-010200 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the PAM system service is configured to store only encrypted representations of passwords."
  pamd:
    name: "{{ item[0] }}"
    state: "{{ item[1].state }}"
    type: password
    control: sufficient
    module_path: pam_unix.so
    module_arguments: "{{ item[1].args }}"
  with_nested:
  - [ 'system-auth', 'password-auth' ]
  -
    - state: args_present
      args:
      - "sha512"
    - state: args_absent
      args:
      - "md5"
      - "bigcrypt"
      - "sha256"
      - "blowfish"
  when: rhel_07_010200
  tags:
  - RHEL-07-010200
  - pamd

- name: "MEDIUM | RHEL-07-010210 | PATCH | The Red Hat Enterprise Linux operating system must be configured to use the shadow file to store only encrypted representations of passwords."
  lineinfile:
    dest: /etc/login.defs
    regexp: ^#?ENCRYPT_METHOD
    line: "ENCRYPT_METHOD {{ rhel7stig_login_defaults.encrypt_method | default('SHA512') }}"
  when: rhel_07_010210
  tags:
  - RHEL-07-010210
  - login

- name: "MEDIUM | RHEL-07-010220 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that user and group account administration utilities are configured to store only encrypted representations of passwords."
  lineinfile:
    dest: /etc/libuser.conf
    regexp: ^#?crypt_style
    line: crypt_style = sha512
  when: rhel_07_010220
  tags:
  - RHEL-07-010220

- name: "MEDIUM | RHEL-07-010230 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that passwords for new users are restricted to a 24 hours/1 day minimum lifetime."
  lineinfile:
    create: yes
    dest: /etc/login.defs
    regexp: ^#?PASS_MIN_DAYS
    line: "PASS_MIN_DAYS {{ rhel7stig_login_defaults.pass_min_days | default('1') }}"
  when: rhel_07_010230
  tags:
  - RHEL-07-010230
  - login

- name: "MEDIUM | RHEL-07-010240 | The Red Hat Enterprise Linux operating system must be configured so that passwords are restricted to a 24 hours/1 day minimum lifetime."
  block:
  - name: "MEDIUM | RHEL-07-010240 | AUDIT | Passwords must be restricted to a 24 hours/1 day minimum lifetime."
    command: "awk -F: '$1 !~ /^root$/ && $2 !~ /^[!*]/ && $4 < 1 {print $1}' /etc/shadow"
    check_mode: no
    changed_when: no
    register: rhel_07_010240_audit

  - name: "MEDIUM | RHEL-07-010240 | PATCH | Passwords must be restricted to a 24 hours/1 day minimum lifetime."
    command: chage -m 1 {{ item }}
    with_items: "{{ rhel_07_010240_audit.stdout_lines }}"
  when: rhel_07_010240
  tags:
  - RHEL-07-010240
  - password

- name: "MEDIUM | RHEL-07-010250 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that passwords for new users are restricted to a 60-day maximum lifetime."
  lineinfile:
    create: yes
    dest: /etc/login.defs
    regexp: ^#?PASS_MAX_DAYS
    line: "PASS_MAX_DAYS {{ rhel7stig_login_defaults.pass_max_days | default('60') }}"
  when: rhel_07_010250
  tags:
  - RHEL-07-010250
  - login

- name: "MEDIUM | RHEL-07-010260 | The Red Hat Enterprise Linux operating system must be configured so that existing passwords are restricted to a 60-day maximum lifetime."
  block:
  - name: "MEDIUM | RHEL-07-010260 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that existing passwords are restricted to a 60-day maximum lifetime."
    command: "awk -F: '$1 !~ /^root$/ && $2 !~ /^[!*]/ && $5 > 60 {print $1}' /etc/shadow"
    check_mode: no
    changed_when: rhel_07_010260_audit.stdout != ""
    register: rhel_07_010260_audit

  - name: "MEDIUM | RHEL-07-010260 | PATCH | Reset password timeout to prevent locking out user."
    command: chage -d '-1 day' {{ item }}
    check_mode: "{{ rhel7stig_disruptive_check_mode }}"
    with_items: "{{ rhel_07_010260_audit.stdout_lines }}"

  - name: "MEDIUM | RHEL-07-010260 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that existing passwords are restricted to a 60-day maximum lifetime."
    command: chage -M 60 {{ item }}
    check_mode: "{{ rhel7stig_disruptive_check_mode }}"
    with_items: "{{ rhel_07_010260_audit.stdout_lines }}"
  when:
  - rhel_07_010260
  - rhel7stig_disruptive
  tags:
  - RHEL-07-010260
  - disruption-high
  - password

- name: "MEDIUM | RHEL-07-010270 | The Red Hat Enterprise Linux operating system must be configured so that passwords are prohibited from reuse for a minimum of five generations."
  block:
  - name: "MEDIUM | RHEL-07-010270 | PATCH | Ensure pam_pwhistory rule exists"
    pamd:
      name: "{{ item }}"
      state: before
      type: password
      control: sufficient
      module_path: pam_unix.so
      new_type: password
      new_control: requisite
      new_module_path: pam_pwhistory.so
    with_items:
    - "system-auth"
    - "password-auth"

  # TODO: Remove temporary audit check to determine if the following pamd module task needs to be run since the module is not idempotent
  - name: "MEDIUM | RHEL-07-010270 | AUDIT | Check for existing password history reuse settings"
    command: "grep -iE '^password\\s+requisite\\s+pam_pwhistory.so\\s+use_authtok\\s+remember={{ rhel7stig_pam_pwhistory.remember | default(5) }}\\s+retry={{ rhel7stig_pam_pwhistory.retries | default(3) }}$' /etc/pam.d/{{ item }}"
    check_mode: no
    changed_when: no
    failed_when: rhel_07_010270_audit.rc > 1
    register: rhel_07_010270_audit
    with_items:
    - "system-auth"
    - "password-auth"

  # TODO: Once the pamd module is fixed (either args_present or updated) then remove the previous grep task and update the following.
  - name: "MEDIUM | RHEL-07-010270 | PATCH | Ensure pam_pwhistory module arguments are set"
    pamd:
      name: "{{ item.item }}"
      state: updated
      type: password
      control: requisite
      module_path: pam_pwhistory.so
      module_arguments:
      - use_authtok
      - remember={{ rhel7stig_pam_pwhistory.remember | default(5) }}
      - retry={{ rhel7stig_pam_pwhistory.retries | default(3) }}
    with_items: "{{ rhel_07_010270_audit.results }}"
    when: item.rc == 1

  when: 
  - rhel_07_010270
  tags:
  - RHEL-07-010270
  - pamd

- name: "MEDIUM | RHEL-07-010280 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that passwords are a minimum of 15 characters in length."
  lineinfile:
    create: yes
    dest: /etc/security/pwquality.conf
    regexp: '^#?\s*minlen'
    line: "minlen = {{ rhel7stig_password_complexity.minlen | default('15') }}"
  when: 
  - rhel_07_010280
  tags:
  - RHEL-07-010280
  - pwquality

- name: "MEDIUM | RHEL-07-010310 | PATCH | The Red Hat Enterprise Linux operating system must disable account identifiers (individuals, groups, roles, and devices) if the password expires."
  lineinfile:
    dest: /etc/default/useradd
    regexp: ^#?INACTIVE
    line: INACTIVE=0
  when: rhel_07_010310
  tags:
  - RHEL-07-010310

- name: |
    "MEDIUM | RHEL-07-010320 | Accounts on the Red Hat Enterprise Linux operating system that are subject to three unsuccessful logon attempts within 15 minutes must be locked for the maximum configurable period."
    "MEDIUM | RHEL-07-010330 | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
  block:
  - name: |
      "MEDIUM | RHEL-07-010320 | PATCH | Accounts on the Red Hat Enterprise Linux operating system that are subject to three unsuccessful logon attempts within 15 minutes must be locked for the maximum configurable period."
      "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
    pamd:
      name: "{{ item }}"
      state: before
      type: auth
      control: sufficient
      module_path: pam_unix.so
      new_type: auth
      new_control: required
      new_module_path: pam_faillock.so
    with_items:
    - "system-auth"
    - "password-auth"

    # TODO: Remove temporary audit check to determine if the following pamd module task needs to be run since the module is not idempotent
    - name: |
        "MEDIUM | RHEL-07-010320 | AUDIT | Check for existing account lockout settings"
        "MEDIUM | RHEL-07-010330 | AUDIT | Check for existing account lockout settings"
      command: "grep -iE '^auth\\s+required\\s+pam_faillock.so\\s+preauth\\s+silent\\s+audit\\s+deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }}\\s+unlock_time={{ rhel7stig_pam_faillock.unlock_time }}$' /etc/pam.d/{{ item }}"
      check_mode: no
      changed_when: no
      failed_when: rhel_07_010320_010330_preauth_audit.rc > 1
      register: rhel_07_010320_010330_preauth_audit
      with_items:
      - "system-auth"
      - "password-auth"

    # TODO: Once the pamd module is fixed (either args_present or updated) then remove the previous grep task and update the following.
    - name: |
        "MEDIUM | RHEL-07-010320 | PATCH | Accounts on the Red Hat Enterprise Linux operating system that are subject to three unsuccessful logon attempts within 15 minutes must be locked for the maximum configurable period."
        "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
      pamd:
        name: "{{ item.item }}"
        state: updated
        type: auth
        control: required
        module_path: pam_faillock.so
        module_arguments: "preauth silent audit deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }} unlock_time={{ rhel7stig_pam_faillock.unlock_time }}"
      with_items: "{{ rhel_07_010320_010330_preauth_audit.results }}"
      when: item.rc == 1

    - name: "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
      pamd:
        name: "{{ item }}"
        state: before
        type: auth
        control: required
        module_path: pam_deny.so
        new_type: auth
        new_control: "[default=die]"
        new_module_path: pam_faillock.so
      with_items:
      - "system-auth"
      - "password-auth"

    # TODO: Remove temporary audit check to determine if the following pamd module task needs to be run since the module is not idempotent
    - name: "MEDIUM | RHEL-07-010330 | AUDIT | Check for existing account lockout settings"
      command: "grep -iE '^auth\\s+\\[default=die\\]\\s+pam_faillock.so\\s+authfail\\s+audit\\s+deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }}\\s+unlock_time={{ rhel7stig_pam_faillock.unlock_time }}$' /etc/pam.d/{{ item }}"
      check_mode: no
      changed_when: no
      failed_when: rhel_07_010330_authfail_audit.rc > 1
      register: rhel_07_010330_authfail_audit
      with_items:
      - "system-auth"
      - "password-auth"

    # TODO: Once the pamd module is fixed (either args_present or updated) then remove the previous grep task and update the following.
    - name: "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
      pamd:
        name: "{{ item.item }}"
        state: updated
        type: auth
        control: "[default=die]"
        module_path: pam_faillock.so
        module_arguments: "authfail audit deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }} unlock_time={{ rhel7stig_pam_faillock.unlock_time }}"
      with_items: "{{ rhel_07_010330_authfail_audit.results }}"
      when: item.rc == 1

    - name: "MEDIUM | RHEL-07-010330 | PATCH | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
      pamd:
        name: "{{ item }}"
        state: before
        type: account
        control: required
        module_path: pam_unix.so
        new_type: account
        new_control: required
        new_module_path: pam_faillock.so
      with_items:
      - "system-auth"
      - "password-auth"

  when: 
  - rhel_07_010320 or rhel_07_010330
  tags:
  - RHEL-07-010320
  - RHEL-07-010330
  - pamd

- name: "MEDIUM | RHEL-07-010340 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that users must provide a password for privilege escalation."
  replace:
    path: "{{ item }}"
    regexp: '^([^#].*)NOPASSWD(.*)'
    replace: '\1PASSWD\2'
    validate: '/usr/sbin/visudo -cf %s'
  with_items: "{{ rhel7stig_sudoers_files.stdout_lines }}"
  when:
  - rhel7stig_using_password_auth
  - rhel_07_010340
  tags:
  - RHEL-07-010340
  - sudoers

- name: "MEDIUM | RHEL-07-010350 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that users must re-authenticate for privilege escalation."
  replace:
    path: "{{ item }}"
    regexp: '^([^#].*)!authenticate(.*)'
    replace: '\1authenticate\2'
    validate: '/usr/sbin/visudo -cf %s'
  with_items: "{{ rhel7stig_sudoers_files.stdout_lines }}"
  when:
  - rhel_07_010350
  - not ansible_distribution == "OracleLinux"
  tags:
  - RHEL-07-010350
  - sudoers

- name: "MEDIUM | RHEL-07-010430 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the delay between logon prompts following a failed console logon attempt is at least four seconds."
  lineinfile:
    dest: /etc/login.defs
    regexp: ^#?FAIL_DELAY
    line: "FAIL_DELAY {{ rhel7stig_login_defaults.fail_delay_secs | default('4') }}"
  when: rhel_07_010430
  tags:
  - RHEL-07-010430
  - login

- name: "MEDIUM | RHEL-07-010460 | PATCH | The Red Hat Enterprise Linux operating system must not allow users to override SSH environment variables."
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?PermitUserEnvironment"
    line: PermitUserEnvironment no
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_010460
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-010460
  - ssh

- name: "MEDIUM | RHEL-07-010470 | PATCH | The Red Hat Enterprise Linux operating system must not allow a non-certificate trusted host SSH logon to the system."
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?HostbasedAuthentication"
    line: HostbasedAuthentication no
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-010470
  - ssh

# TODO: A user can still override the authentication requirement for single user mode in a couple ways that the STIG misses.
# This fix block does not check for those methods. i.e.
# User can override the rescue.service unit by placing a copy at /etc/systemd/system/rescue.service
# User can override some settings of the rescue.service unit by placing the overridden lines in /etc/systemd/system/rescue.service.d/override.conf
# Additionally the user can provide the -e or --force options to /usr/sbin/sulogin which will provide a root shell without password if the
# password file is inaccessbile or the root password is non-existent, LOCKED, or damaged.
- name: "MEDIUM | RHEL-07-010481 | The Red Hat Enterprise Linux operating system must require authentication upon booting into single-user and maintenance modes."
  block:
  - name: "MEDIUM | RHEL-07-010481 | PATCH | Check if the packaged rescue.service file was edited directly"
    shell: "cat /usr/lib/systemd/system/rescue.service | grep 'ExecStart=.*/usr/sbin/sulogin'"
    changed_when: no
    failed_when: no
    check_mode: no
    register: systemd_rescue_unit_check

  - name: "MEDIUM | RHEL-07-010481 | PATCH | Force reinstall systemd package to replace edited /usr/lib/systemd/system/rescue.service"
    shell: yum -y reinstall systemd
    when: systemd_rescue_unit_check.rc == 1
  when: 
  - rhel_07_010481
  tags:
  - RHEL-07-010481
  - rescue

- name: "MEDIUM | RHEL-07-010500 | PATCH | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate organizational users (or processes acting on behalf of organizational users) using multifactor authentication."
  block:
  # This task checks to test if pamd is enabled for pkcs11
  - name: MEDIUM | RHEL-07-010500 | PATCH | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate organizational users (or processes acting on behalf of organizational users) using multifactor authentication.
    shell: authconfig --test | grep "pam_pkcs11 is enabled"
    register: rhel_07_010500pkcs11output

  # This task gathers output so we can test if smartcard removal action is enabled
  - name: MEDIUM | RHEL-07-010500 | PATCH | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate organizational users (or processes acting on behalf of organizational users) using multifactor authentication.
    shell: authconfig --test | grep "smartcard removal action"
    register: rhel_07_010500scremovaloutput

  # This task gathers output so we can test if smartcard module is enabled
  - name: MEDIUM | RHEL-07-010500 | PATCH | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate organizational users (or processes acting on behalf of organizational users) using multifactor authentication.
    shell: authconfig --test | grep "smartcard module"
    register: rhel_07_010500scenabledoutput

  # This is to remediate if pam_pkcs11 is not installed.
  - name: MEDIUM | RHEL-07-010500 | PATCH | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate organizational users (or processes acting on behalf of organizational users) using multifactor authentication.
    package:
      name: "{{ item }}"
      state: present
      with_items:
      - pam_pkcs11
      - pcsc-lite-libs
    args:
      ansible_python_interpreter: "{{ python2_bin }}"
    register: rhel_07_010500pkcs11install
    when: 
    - rhel_07_010500pkcs11output.stdout != 'pam_pkcs11 is enabled'

  # This task will remediate the smartcard login setting
  - name: MEDIUM | RHEL-07-010500 | PATCH | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate organizational users (or processes acting on behalf of organizational users) using multifactor authentication.
    shell: authconfig --enablesmartcard --smartcardaction=0 --update
    when: 
    - rhel_07_010500scenabledoutput.stdout == ' smartcard module = \"\"' or rhel_07_010500scremovaloutput.stdout == ' smartcard removal action = \"\"'

  # This task will remediate the smartcard login setting
  - name: MEDIUM | RHEL-07-010500 | PATCH | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate organizational users (or processes acting on behalf of organizational users) using multifactor authentication.
    shell: authconfig --enablerequiresmartcard --update
    when: rhel_07_010500scenabledoutput.stdout == ' smartcard module = \"\"' or rhel_07_010500scremovaloutput.stdout == ' smartcard removal action = \"\"'

  # This remediates the screensaver settings for smartcard authentication
  - name: MEDIUM | RHEL-07-010500 | PATCH | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate organizational users (or processes acting on behalf of organizational users) using multifactor authentication.
    lineinfile:
      create: yes
      dest: /etc/pam_pkcs11/pkcs11_eventmgr.conf
      regexp: '^#?/usr/X11R6/bin/xscreensaver-command -lock'
      line: "/usr/X11R6/bin/xscreensaver-command -lock"
  
  # This remediates the pam_pkcs11.conf file to enforce the cackey usage for smartcard authentication
  ### NOTE:  If you have custom rules for /etc/pam_pkcs11/pam_pkcs11.conf then change the template pam_pkcs11.conf.j2
  - name: MEDIUM | RHEL-07-010500 | PATCH | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate organizational users (or processes acting on behalf of organizational users) using multifactor authentication.
    template:
      src: pam_pkcs11.conf.j2
      dest: /etc/pam_pkcs11/pam_pkcs11.conf
      owner: root
      group: root
      mode: 0644
    when: 
    - rhel_07_010500pkcs11install is changed
  when:
  - rhel_07_010500
  - rhel7stig_gui
  - rhel7stig_smartcard
  tags:
  - RHEL-07-010500

##############################
#########   20000  ###########
##############################

- name: "MEDIUM | RHEL-07-020019 | AUDIT | The Red Hat Enterprise Linux operating system must have a host-based intrusion detection tool installed."
  debug:
      msg:
      - "Please install and enable the latest McAfee HIPS package, available from USCYBERCOM."
      - "If the system does not support the McAfee HIPS package, install and enable a supported intrusion detection system application and document its use with the Authorizing Official."
  when:
  - rhel_07_020019
  tags:
  - audit
  - RHEL-07-020019


- name: "MEDIUM | RHEL-07-020020 | The Red Hat Enterprise Linux operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures."
  block:
      # is a HBSS installed?
  - name: "MEDIUM | RHEL-07-020020 | AUDIT | The Red Hat Enterprise Linux operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures."
    stat:
      path: "{{ rhel_07_020020_HBSS_path }}"
    register: rhel_07_020020_HBSS_check
    when:
    - rhel_07_020020
    - rhel7stig_disruption_high
    - rhel7stig_audit_disruptive
    tags:
    - RHEL-07-020020
      # is a HIPS installed?
  - name: "MEDIUM | RHEL-07-020020 | AUDIT | The Red Hat Enterprise Linux operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures."
    stat:
      path: "{{ rhel_07_020020_HIPS_path }}"
    register: rhel_07_020020_HIPS_check
    when:
    - rhel_07_020020
    - rhel7stig_disruption_high
    - rhel7stig_audit_disruptive
    tags:
    - RHEL-07-020020
  
  # This is an include to conditionally loop through users to selinux mappings
  - name: "MEDIUM | RHEL-07-020020 | AUDIT | The Red Hat Enterprise Linux operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures."
    include_tasks: audit_selinuxlocaluserdefs.yml
    when:
    - rhel_07_020020
    - not rhel_07_020020_HBSS_check.stat.exists and not rhel_07_020020_HIPS_check.stat.exists
    - rhel7stig_disruption_high
    - rhel7stig_audit_disruptive
    tags:
    - RHEL-07-020020
  when:
  - rhel_07_020020
  - rhel7stig_disruption_high
  - rhel7stig_audit_disruptive
  tags:
  - RHEL-07-020020

- name: |
    "MEDIUM | RHEL-07-020030 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that a file integrity tool verifies the baseline operating system configuration at least weekly."
    "MEDIUM | RHEL-07-020040 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that designated personnel are notified if baseline configurations are changed in an unauthorized manner."
  cron:
    name: 'Run AIDE integrity check {{ rhel7stig_aide_cron.special_time }}'
    user: "{{ rhel7stig_aide_cron.user }}"
    cron_file: "{{ rhel7stig_aide_cron.cron_file }}"
    job: "{{ rhel7stig_aide_cron.job + ((rhel7stig_aide_cron.notify_by_mail) | ternary(rhel7stig_aide_cron.notify_cmd,'')) }}"
    minute: "{{ rhel7stig_aide_cron.minute | default((rhel7stig_cron_special_disable and
            rhel7stig_aide_cron.special_time in ['hourly', 'daily', 'weekly', 'monthly']) |
            ternary('0', omit)) | default(omit) }}"
    hour: "{{ rhel7stig_aide_cron.hour | default((rhel7stig_cron_special_disable and
          rhel7stig_aide_cron.special_time in ['daily', 'weekly', 'monthly']) |
          ternary('0', omit)) | default(omit) }}"
    weekday: "{{ rhel7stig_aide_cron.weekday | default((rhel7stig_cron_special_disable and
              rhel7stig_aide_cron.special_time in ['weekly']) |
              ternary('0', omit)) | default(omit) }}"
    day: "{{ rhel7stig_aide_cron.day | default((rhel7stig_cron_special_disable and
          rhel7stig_aide_cron.special_time in ['monthly']) |
          ternary('1', omit)) | default(omit) }}"
    special_time: "{{ (rhel7stig_cron_special_disable and
                  rhel7stig_aide_cron.special_time in ['hourly', 'daily', 'weekly', 'monthly']) |
                  ternary(omit, rhel7stig_aide_cron.special_time) }}"
  when: 
  - rhel_07_020030 or rhel_07_020040
  tags:
  - RHEL-07-020030
  - RHEL-07-020040
  - aide

- name: "MEDIUM | RHEL-07-020100 | PATCH | The Red Hat Enterprise Linux operating system must be configured to disable USB mass storage."
  lineinfile:
    dest: "{{ item.file }}"
    insertafter: "{{ item.insertafter }}"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    create: yes
    owner: root
    group: root
    mode: "0644"
  with_items:
  - file: /etc/modprobe.d/blacklist.conf
    insertafter: "^#blacklist usb-storage(\\s+|$)"
    regexp: "^blacklist usb-storage(\\s+|$)"
    line: 'blacklist usb-storage'
  - file: /etc/modprobe.d/usb-storage.conf
    insertafter: "^#install usb-storage"
    regexp: "^install usb-storage"
    line: install usb-storage /bin/true
  when: 
  - rhel_07_020100
  tags:
  - RHEL-07-020100
  - usb_devices

- name: "MEDIUM | RHEL-07-020101 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the Datagram Congestion Control Protocol (DCCP) kernel module is disabled unless required."
  lineinfile:
    dest: "{{ item.file }}"
    insertafter: "{{ item.insertafter }}"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    create: yes
    owner: root
    group: root
    mode: "0644"
  with_items:
  - file: /etc/modprobe.d/blacklist.conf
    insertafter: ^#blacklist dccp
    regexp: ^blacklist dccp(\s+|$)
    line: blacklist dccp
  - file: /etc/modprobe.d/dccp.conf
    insertafter: ^#install dccp
    regexp: "^install dccp "
    line: install dccp /bin/true
  when: rhel_07_020101
  tags:
      - RHEL-07-020101
      - dccp

- name: "MEDIUM | RHEL-07-020110 | PATCH | The Red Hat Enterprise Linux operating system must disable the file system automounter unless required."
  block:
  - name: "MEDIUM | RHEL-07-020110 | PATCH | The Red Hat Enterprise Linux operating system must disable the file system automounter unless required."
    shell: "systemctl show autofs | grep LoadState | cut -d = -f 2"
    register: rhel_07_020110_autofs_service_status
    changed_when: no
    check_mode: no

  - name: "MEDIUM | RHEL-07-020110 | PATCH | The Red Hat Enterprise Linux operating system must disable the file system automounter unless required."
    service:
      name: autofs
      enabled: no
      state: stopped
    when:
    - rhel_07_020110_autofs_service_status == "loaded"
    - not rhel7stig_autofs_required
  when:
  - rhel_07_020110
  tags:
  - RHEL-07-020110

- name: "MEDIUM | RHEL-07-020111 | PATCH | The Red Hat Enterprise Linux operating system must disable the graphical user interface automounter unless required."
  copy:
    dest: /etc/dconf/db/local.d/00-No-Automount
    content: |
      [org/gnome/desktop/media-handling]
      automount=false
      automount-open=false
      automount-never=true
    mode: '0644'
  notify: dconf update
  when:
  - rhel7stig_dconf_available
  - rhel_07_020111
  tags:
  - RHEL-07-020111

- name: "MEDIUM | RHEL-07-020210 | PATCH | The Red Hat Enterprise Linux operating system must enable SELinux.|
         MEDIUM | RHEL-07-020220 | PATCH | The Red Hat Enterprise Linux operating system must enable SELinux targeted policy."
  selinux:
    state: enforcing
    policy: targeted
  check_mode: "{{ ansible_check_mode or rhel7stig_system_is_chroot }}"
  when:
  - rhel_07_020210
  - not rhel7stig_system_is_container
  tags:
  - RHEL-07-020210
  - selinux


- name: "MEDIUM | RHEL-07-020240 | PATCH | The Red Hat Enterprise Linux operating system must define default permissions for all authenticated users in such a way that the user can only read and modify their own files."
  lineinfile:
    dest: /etc/login.defs
    regexp: ^#?UMASK
    line: "UMASK {{ rhel7stig_login_defaults.umask | default('077') }}"
  when: rhel_07_020240
  tags:
  - RHEL-07-020240
  - login
  - umask

- name: "MEDIUM | RHEL-07-020260 | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date."
  yum:
    name: '*'
    state: latest
  args:
    ansible_python_interpreter: "{{ python2_bin }}"
  when: rhel_07_020260
  tags:
  - RHEL-07-020260
  - packaging

- name: "MEDIUM | RHEL-07-020270 | AUDIT | The Red Hat Enterprise Linux operating system must not have unnecessary accounts."
  block:
  - name: "MEDIUM | RHEL-07-020270 | AUDIT | The Red Hat Enterprise Linux operating system must not have unnecessary accounts."
    command: "grep '^{{ item }}:' /etc/passwd"
    check_mode: no
    failed_when: rhel_07_020270_audit.rc > 1
    changed_when: rhel_07_020270_audit.rc == 0
    register: rhel_07_020270_audit
    with_items: "{{ rhel7stig_unnecessary_accounts }}"

  - name: "MEDIUM | RHEL-07-020270 | PATCH | The Red Hat Enterprise Linux operating system must not have unnecessary accounts."
    user:
      name: "{{ item }}"
      state: absent
      remove: "{{ rhel7stig_remove_unnecessary_user_files }}"
    register: rhel_07_020270_patch
    with_items: "{{ rhel7stig_unnecessary_accounts }}"

  - name: "MEDIUM | RHEL-07-020270 | AUDIT | Re-parse /etc/passwd since it changed."
    include_tasks: parse_etc_passwd.yml
    vars:
      rhel7stig_passwd_tasks: "RHEL-07-020270"
    when: rhel_07_020270_patch is changed
  when: 
  - rhel_07_020270
  tags:
  - RHEL-07-020270

- name: "MEDIUM | RHEL-07-020320 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid owner."
  block:
  - name: "MEDIUM | RHEL-07-020320 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid owner."
    command: find "{{ item.mount }}" -xdev -nouser
    check_mode: no
    register: rhel_07_020320_audit
    failed_when: no
    changed_when: no
    when: item['device'].startswith('/dev') and not 'bind' in item['options']
    with_items: "{{ ansible_mounts }}"

  - name: "MEDIUM | RHEL-07-020320 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid owner."
    debug:
      msg: "Manual intervention is required -- missing owner on items in {{ item.item.mount }}: {{ item.stdout_lines | join(', ') }}"
    changed_when:
    - rhel7stig_audit_complex
    when:
    - item.stdout_lines is defined
    - item.stdout_lines | length > 0
    with_items: "{{ rhel_07_020320_audit.results }}"
  when:
  - rhel_07_020320
  - rhel7stig_complex
  tags:
  - RHEL-07-020320
  - complexity-high

- name: "MEDIUM | RHEL-07-020330 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid group owner."
  block:
  - name: "MEDIUM | RHEL-07-020330 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid group owner."
    command: find "{{ item.mount }}" -xdev -nogroup
    check_mode: no
    register: rhel_07_020330_audit
    failed_when: no
    changed_when: no
    when: item['device'].startswith('/dev') and not 'bind' in item['options']
    with_items: "{{ ansible_mounts }}"

  - name: "MEDIUM | RHEL-07-020330 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid group owner."
    debug:
      msg: "Manual intervention is required -- missing group on items in {{ item.item.mount }}: {{ item.stdout_lines | join(', ') }}"
    changed_when:
    - rhel7stig_audit_complex
    when:
    - item.stdout_lines is defined
    - item.stdout_lines | length > 0
    with_items: "{{ rhel_07_020330_audit.results }}"
  when:
  - rhel_07_020330
  - rhel7stig_complex
  tags:
  - RHEL-07-020330
  - complexity-high

- name: "MEDIUM | RHEL-07-020600 | The Red Hat Enterprise Linux operating system must be configured so that all local interactive users have a home directory assigned in the /etc/passwd file."
  block:
  - name: capture audit task for missing homedirs
    block: &r7s_homedir_audit
    - name: "MEDIUM | RHEL-07-020600 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local interactive users have a home directory assigned in the /etc/passwd file."
      shell: set -o pipefail ; pwck -r | grep -P {{ ld_regex | quote }}
      check_mode: no
      register: rhel7stig_users_missing_home
      changed_when: rhel7stig_07_20600_audit | length > 0
      # failed_when: 0: success, 1: no grep match, 2: pwck found something
      failed_when: rhel7stig_users_missing_home.rc not in [0,1,2]
    when:
    - rhel7stig_disruptive
    tags:
    - disruption-high

  ### NOTE: due to https://github.com/ansible/ansible/issues/24862 This is a shell command, and is quite frankly less than ideal.
  - name: "MEDIUM | RHEL-07-020600 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive users have a home directory assigned in the /etc/passwd file."
    command: "mkhomedir_helper {{ item }}"
    check_mode: "{{ rhel7stig_disruptive_check_mode }}"
    with_items: "{{ rhel7stig_07_20600_audit | map(attribute='id') | list }}"
    when:
    - rhel7stig_users_missing_home is changed
    - rhel7stig_disruptive  # not technically required
    tags:
    - disruption-high
  ### NOTE: Now we need to address that SELINUX will not let mkhomedir_helper create home directories for UUID < 500, so the ftp user will still show up in a pwck. Not sure this is needed, as the ftp user is removed in rhel7stig_unnecessary_accounts. However these next two tasks won't make any changes if the system accounts are removed previously in RHEL-07-020270.
  ### ^ Likely doesn't matter as 020620 defines "local interactive users" as those w/ uid 1000-4999
  - name: replay audit task
    block: *r7s_homedir_audit
    when:
    - rhel7stig_complex
    tags:
    - complexity-high
  # CAUTION: debug loops don't show changed since 2.4:
  # Fix: https://github.com/ansible/ansible/pull/59958
  - name: "MEDIUM | RHEL-07-020600 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local interactive users have a home directory assigned in the /etc/passwd file."
    debug: msg="You will need to mkdir -p {{ item }} and chown properly to the correct owner and group."
    with_items: "{{ rhel7stig_07_20600_audit | map(attribute='dir') | list }}"
    changed_when: rhel7stig_audit_complex
    when:
    - rhel7stig_users_missing_home is changed
    - rhel7stig_complex  # not technically required
    tags:
    - complexity-high
  vars:
    ld_regex: >-
        ^user '(?P<user>.*)': directory '(?P<dir>.*)' does not exist$
    ld_users: "{{ rhel7stig_users_missing_home.stdout_lines | map('regex_replace', ld_regex, '\\g<user>') | list }}"
    rhel7stig_07_20600_audit: "{{ rhel7stig_passwd | selectattr('uid', '>=', rhel7stig_int_gid) | selectattr('id', 'in', ld_users) | list }}"
  when:
  - rhel_07_020600
  - ansible_distribution_file_variety == "RedHat"

- name: "MEDIUM | RHEL-07-020610 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user accounts, upon creation, are assigned a home directory."
  lineinfile:
    dest: /etc/login.defs
    regexp: ^#?CREATE_HOME
    line: "CREATE_HOME {{ rhel7stig_login_defaults.create_home | default('yes') }}"
  when: rhel_07_020610
  tags:
  - RHEL-07-020610
  - login
  - home

- name: "MEDIUM | RHEL-07-020620 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user home directories are defined in the /etc/passwd file."
  file:
    path: "{{ item.dir }}"
    state: directory
  with_items: "{{ rhel7stig_passwd }}"
  loop_control:
    label: "{{ rhel7stig_passwd_label }}"
  when:
  - rhel_07_020620
  - item.uid >= rhel7stig_int_gid
  tags:
  - RHEL-07-020620

- name: "MEDIUM | RHEL-07-020630 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user home directories have mode 0750 or less permissive."
  file:
    path: "{{ item.dir }}"
    mode: "{{ rhel7stig_homedir_mode }}"
    state: directory
  with_items: "{{ rhel7stig_passwd }}"
  loop_control:
    label: "{{ rhel7stig_passwd_label }}"
  when:
  - rhel_07_020630
  - item.uid >= rhel7stig_int_gid
  tags:
  - RHEL-07-020630

- name: "MEDIUM | RHEL-07-020640 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user home directories are owned by their respective users."
  file:
    path: "{{ item.dir }}"
    owner: "{{ item.id }}"
    state: directory
  with_items: "{{ rhel7stig_passwd }}"
  loop_control:
    label: "{{ rhel7stig_passwd_label }}"
  when:
  - rhel_07_020640
  - item.uid >= rhel7stig_int_gid
  tags:
  - RHEL-07-020640

- name: "MEDIUM | RHEL-07-020650 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user home directories are group-owned by the home directory owners primary group."
  file:
    path: "{{ item.dir }}"
    group: "{{ item.gid }}"
    state: directory
  with_items: "{{ rhel7stig_passwd }}"
  loop_control:
    label: "{{ rhel7stig_passwd_label }}"
  when:
  - rhel_07_020650
  - item.uid >= rhel7stig_int_gid
  tags:
  - RHEL-07-020650

- name: "MEDIUM | RHEL-07-020660 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are owned by the owner of the home directory."
  block:
  - name: "MEDIUM | RHEL-07-020660 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are owned by the owner of the home directory."
    command: "{{ find_command_base }} -print -quit"
    check_mode: no
    changed_when: rhel_07_020660_audit.stdout != ""
    register: rhel_07_020660_audit
    with_items: "{{ rhel7stig_passwd }}"
    loop_control:
      label: "{{ rhel7stig_passwd_label }}"
    when:
    - this_item.uid >= rhel7stig_int_gid
    vars:
      this_item: "{{ item }}"

  - name: "MEDIUM | RHEL-07-020660 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are owned by the owner of the home directory."
    command: "{{ find_command_base }} -exec chown {{ this_item.uid }} {} +"
    with_items: "{{ rhel_07_020660_audit.results }}"
    loop_control:
      label: "{{ rhel7stig_passwd_label }}"
    when:
    - item is changed
    vars:
      this_item: "{{ item.item }}"
  vars:
    find_command_base: 'find "{{ this_item.dir }}" -mindepth 1
           ( -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*" -type f ) -o
           -not -user {{ this_item.uid }}'
  when: 
  - rhel_07_020660
  tags:
  - RHEL-07-020660

- name: "MEDIUM | RHEL-07-020670 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are group-owned by a group of which the home directory owner is a member."
  block:
  - name: "MEDIUM | RHEL-07-020670 | AUDIT | Get all GIDs for each user."
    command: id -G "{{ item.id }}"
    check_mode: no
    changed_when: no
    register: rhel_07_all_gid_audit
    with_items: "{{ rhel7stig_passwd }}"
    loop_control:
      label: "{{ rhel7stig_passwd_label }}"

  - name: "MEDIUM | RHEL-07-020670 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are group-owned by a group of which the home directory owner is a member."
    command: "{{ find_command_base }} -print -quit"
    check_mode: no
    changed_when: rhel_07_020670_audit.stdout != ""
    register: rhel_07_020670_audit
    with_items: "{{ rhel_07_all_gid_audit.results }}"
    loop_control:
      label: "{{ rhel7stig_passwd_label }}"
    when:
    - this_item.uid >= rhel7stig_int_gid
    vars:
      this_item: "{{ item.item }}"
      this_result: "{{ item }}"

  - name: "MEDIUM | RHEL-07-020670 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are group-owned by a group of which the home directory owner is a member."
    command: "{{ find_command_base }} -exec chgrp {{ this_item.gid }} {} +"
    with_items: "{{ rhel_07_020670_audit.results }}"
    loop_control:
      label: "{{ rhel7stig_passwd_label }}"
    when:
    - item is changed
    vars:
      this_item: "{{ item.item.item }}"
      this_result: "{{ item.item }}"
  vars:
    find_command_base: 'find "{{ this_item.dir }}" -mindepth 1
            ( -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*" -type f ) -o
            -not -group {{ this_result.stdout.split(" ") | join(" -not -group ") }}'
  when: 
  - rhel_07_020670
  tags:
  - RHEL-07-020670

- name: "MEDIUM | RHEL-07-020680 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
  block:
  - name: "MEDIUM | RHEL-07-020680 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
    stat:
      path: "{{ item }}"
    with_items: "{{ rhel7stig_passwd | selectattr('uid', '>=', rhel7stig_int_gid) | selectattr('uid', '!=', 65534) | map(attribute='dir') | list }}"
    register: rhel_07_020680_audit

  - name: "MEDIUM | RHEL-07-020680 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
    command: find -H {{ item.0 | quote }} -not -type l -perm /027
    check_mode: no
    register: rhel_07_020680_patch_audit
    changed_when: rhel_07_020680_patch_audit.stdout != ""
    when:
    - ansible_check_mode
    - item.1.exists
    with_together:
    - "{{ rhel_07_020680_audit.results | map(attribute='item') | list }}"
    - "{{ rhel_07_020680_audit.results | map(attribute='stat') | list }}"
    loop_control:
      label: "{{ item.0 }}"

  - name: "MEDIUM | RHEL-07-020680 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
    file:
      path: "{{ item.0 }}"
      recurse: yes
      mode: a-st,g-w,o-rwx
    register: rhel_07_020680_patch
    when:
    - not ansible_check_mode
    - item.1.exists
    with_together:
    - "{{ rhel_07_020680_audit.results | map(attribute='item') | list }}"
    - "{{ rhel_07_020680_audit.results | map(attribute='stat') | list }}"
    loop_control:
      label: "{{ item.0 }}"

  # set default ACLs so the homedir has an effective umask of 0027
  - name: "MEDIUM | RHEL-07-020680 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
    acl:
      path: "{{ item.0 }}"
      default: yes
      state: present
      recursive: yes
      etype: "{{ item.1.etype }}"
      permissions: "{{ item.1.mode }}"
    when: 
    - not rhel7stig_system_is_container
    with_nested:
    - "{{ (ansible_check_mode | ternary(rhel_07_020680_patch_audit, rhel_07_020680_patch)).results |
      rejectattr('skipped', 'defined') | map(attribute='item') | map('first') | list }}"
    -
        - etype: group
          mode: rx
        - etype: other
          mode: '0'
  when:
  - rhel_07_020680
  tags:
  - RHEL-07-020680

- name: "MEDIUM | RHEL-07-020690 | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for interactive users are owned by the home directory user or root."
  block:
  - name: "MEDIUM | RHEL-07-020690 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for interactive users are owned by the home directory user or root."
    command: "{{ find_command_base }} -print -quit"
    check_mode: no
    changed_when: rhel_07_020690_audit.stdout != ""
    register: rhel_07_020690_audit
    with_items: "{{ rhel7stig_passwd }}"
    loop_control:
      label: "{{ rhel7stig_passwd_label }}"
    when:
    - this_item.uid >= rhel7stig_int_gid
    vars:
      this_item: "{{ item }}"

  - name: "MEDIUM | RHEL-07-020690 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for interactive users are owned by the home directory user or root."
    command: "{{ find_command_base }} -exec chown {{ this_item.uid }} {} +"
    with_items: "{{ rhel_07_020690_audit.results }}"
    loop_control:
      label: "{{ rhel7stig_passwd_label }}"
    when:
    - item is changed
    vars:
      this_item: "{{ item.item }}"
  vars:
    find_command_base: 'find "{{ this_item.dir }}" -mindepth 1 -type f
            -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*"
            -not ( -user {{ this_item.uid }} -o -user root )'
  when: 
  - rhel_07_020690
  tags:
  - RHEL-07-020690

- name: "MEDIUM | RHEL-07-020700 | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for local interactive users are be group-owned by the users primary group or root."
  block:
  - name: "MEDIUM | RHEL-07-020700 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for local interactive users are be group-owned by the users primary group or root."
    command: "{{ find_command_base }} -print -quit"
    check_mode: no
    changed_when: rhel_07_020700_audit.stdout != ""
    register: rhel_07_020700_audit
    with_items: "{{ rhel7stig_passwd }}"
    loop_control:
      label: "{{ rhel7stig_passwd_label }}"
    when:
    - this_item.uid >= rhel7stig_int_gid
    vars:
      this_item: "{{ item }}"

  - name: "MEDIUM | RHEL-07-020700 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for local interactive users are be group-owned by the users primary group or root."
    command: "{{ find_command_base }} -exec chgrp {{ this_item.gid }} {} +"
    with_items: "{{ rhel_07_020700_audit.results }}"
    loop_control:
      label: "{{ rhel7stig_passwd_label }}"
    when:
    - item is changed
    vars:
      this_item: "{{ item.item }}"
  vars:
    find_command_base: 'find "{{ this_item.dir }}" -mindepth 1 -type f
            -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*"
            -not ( -group {{ this_item.gid }} -o -group root )'
  when: 
  - rhel_07_020700
  tags:
  - RHEL-07-020700

- name: "MEDIUM | RHEL-07-020710 | RHEL-07-020720 | RHEL-07-020730 | AUDIT | Find ini files for interactive users."
  shell: find "{{ item }}" -maxdepth 1 -type f | awk -F"/" '$NF ~ /^\..*$/ {print $NF}' | grep -v history
  with_items: "{{ rhel_07_stig_interactive_homedir_results }}"
  register: rhel_07_020710_ini_file_list
  changed_when: no
  failed_when: false
  when:
  - rhel_07_stig_interactive_homedir_results is defined
  - rhel_07_020710
  - rhel_07_020720
  - rhel_07_020730
  - rhel7stig_disruption_high
  tags:
  - RHEL-07-020710
  - RHEL-07-020720
  - RHEL-07-020730
  - complexity-high

- name: "MEDIUM | RHEL-07-020710 | RHEL-07-020720 | RHEL-07-020730 | Set fact for home directory paths for interactive users"
  set_fact:
    rhel_07_stig_interactive_homedir_inifiles: "{{ rhel_07_020710_ini_file_list.results | map(attribute='stdout_lines') | list }}"
  when:
  - rhel_07_stig_interactive_homedir_results is defined
  - rhel_07_020710
  - rhel_07_020720
  - rhel_07_020730
  - rhel7stig_disruption_high
  tags:
  - RHEL-07-020680
  - RHEL-07-020710
  - RHEL-07-020720
  - RHEL-07-020730
  - complexity-high

- name: "MEDIUM | RHEL-07-020710 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user initialization files must have mode 0740 or less permissive."
  file:
    path: "{{ item }}"
    mode: '0640'
    state: touch
  with_items: "{{ rhel_07_stig_interactive_homedir_inifiles }}"
  when:
  - rhel_07_stig_interactive_homedir_inifiles is defined
  - rhel_07_020710
  - rhel7stig_disruption_high
  tags:
  - RHEL-07-020710
  - complexity-high

- name: "MEDIUM | RHEL-07-020720 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user initialization files executable search paths contain only paths that resolve to the users home directory."
  block:
  - name: "MEDIUM | RHEL-07-020720 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user initialization files executable search paths contain only paths that resolve to the users home directory."
    shell: find "{{ item }}" -maxdepth 1 -type f | xargs grep "PATH=" | cut -d':' -f1 | xargs realpath
    with_items: "{{ rhel_07_stig_interactive_homedir_results }}"
    register: rhel_07_020710_ini_path_grep_list
    changed_when: no
    failed_when: false
    when:
    - rhel_07_stig_interactive_homedir_results is defined
     - rhel_07_stig_interactive_homedir_inifiles is defined
  
  - name: "MEDIUM | RHEL-07-020720 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user initialization files executable search paths contain only paths that resolve to the users home directory."
    debug:
      msg: You will need to audit and correct executable paths set in "{{ item }}" to contain only paths that resolve to the user's home directory.
    with_items:
    - "{{ rhel_07_020710_ini_path_grep_list.results | map(attribute='stdout_lines') | list }}"
  
  - name: "MEDIUM | RHEL-07-020720 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user initialization files executable search paths contain only paths that resolve to the users home directory."
    lineinfile:
      path: "{{ item }}"
      regexp: "^PATH="
      line: "{{ rhel_07_020720_user_path }}"
    with_items:
    - "{{ rhel_07_020710_ini_path_grep_list.results | map(attribute='stdout_lines') | list }}"
    when:
    - rhel7stig_change_user_path
  when:
  - rhel_07_020720
  - rhel7stig_disruption_high
  tags:
  - RHEL-07-020720
  - complexity-high

- name: "MEDIUM | RHEL-07-020730 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that local initialization files do not execute world-writable programs."
  block:
  # Let's find any progerams with world-writable permissions.
  - name: "MEDIUM | RHEL-07-020730 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that local initialization files do not execute world-writable programs."
    shell: find / -xdev -perm -002 -type f -exec ls -ld {} \;
    failed_when: false
    changed_when: false
    register: rhel_07_020730_perms_results

  # Now let's see if those come up in any interactive users' home directory ini files.
  - name: "MEDIUM | RHEL-07-020730 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that local initialization files do not execute world-writable programs."
    debug:
      msg: "Good news! We have not found any world-writable exeutable programs on your system."
    failed_when: false
    changed_when: false
    when:
    - rhel_07_020730_perms_results.stdout_lines is not defined
  
  - name: "MEDIUM | RHEL-07-020730 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that local initialization files do not execute world-writable programs."
    include_tasks: audit_homedirinifiles.yml
    loop:
    - "{{ rhel_07_stig_interactive_homedir_inifiles }}"
    loop_control:
      loop_var: ini_item
    when:
    - rhel_07_020730_perms_results.stdout_lines is defined
 
  - name: "MEDIUM | RHEL-07-020730 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that local initialization files do not execute world-writable programs."
    file:
      path: "{{ item }}"
      mode: '0755'
      state: touch
    with_items: "{{ rhel_07_020730_perms_results.stdout_lines }}"
    when:
    - rhel_07_020730_perms_results.stdout_lines is defined
    - rhel_07_020730_WWP_Change
  when:
  - rhel_07_020730
  - rhel7stig_disruption_high
  - rhel_07_stig_interactive_homedir_inifiles is defined
  tags:
  - RHEL-07-020730
  - complexity-high

- name: "MEDIUM | RHEL-07-020900 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all system device files are correctly labeled to prevent unauthorized modification."
  setup:
    gather_subset: selinux,!min,!all
    filter: ansible_selinux
  when:
  - rhel_07_020900
  - rhel7stig_complex
  - ansible_selinux is not defined
  tags:
  - RHEL-07-020900
  - complexity-high

- name: "MEDIUM | RHEL-07-020900 | The Red Hat Enterprise Linux operating system must be configured so that all system device files are correctly labeled to prevent unauthorized modification."
  block:
  - name: "MEDIUM | RHEL-07-020900 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all system device files are correctly labeled to prevent unauthorized modification."
    command: find {{ rhel7stig_local_mounts | join(' ') }} -xdev ( -context *:device_t:* -o -context *:unlabeled_t:* ) ( -type c -o -type b ) -printf '%p %Z\n'
    changed_when: no
    check_mode: no
    register: rhel_07_020900_audit

  - name: "MEDIUM | RHEL-07-020900 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all system device files are correctly labeled to prevent unauthorized modification."
    debug:
      msg: "{{ rhel_07_020900_audit.stdout_lines }}"
    changed_when:
    - rhel7stig_audit_complex
    when:
    - rhel_07_020900_audit.stdout_lines | length > 0
  when:
  - rhel_07_020900
  - rhel7stig_complex
  - ansible_selinux.status == "enabled"
  tags:
  - RHEL-07-020900
  - complexity-high

- name: "MEDIUM | RHEL-07-021000 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that file systems containing user home directories are mounted to prevent files with the setuid and setgid bit set from being executed."
  mount:
    path: /home
    state: mounted
    src: "{{ home_mount.device }}"
    fstype: "{{ home_mount.fstype }}"
    opts: "{{ home_mount.options }},nosuid"
  when:
  - rhel_07_021000
  - ansible_mounts | selectattr('mount', 'match', '^/home$') | list | length != 0
  - "'nosuid' not in home_mount.options"
  vars:
    home_mount: "{{ ansible_mounts | json_query('[?mount == `/home`] | [0]') }}"
  tags:
  - RHEL-07-021000

- name: "MEDIUM | RHEL-07-021010 | AUDIT | The Red Hat Enterprise Linux operating system must prevent files with the setuid and setgid bit set from being executed on file systems that are used with removable media."
  block:
  - name: "MEDIUM | RHEL-07-021010 | AUDIT | The Red Hat Enterprise Linux operating system must prevent files with the setuid and setgid bit set from being executed on file systems that are used with removable media."
    mount:
      path: /media
      state: mounted
      src: "{{ removable_mount.device }}"
      fstype: "{{ removable_mount.fstype }}"
      opts: "{{ removable_mount.options }},nosuid"
    when:
    - ansible_mounts | selectattr('mount', 'match', '^/media$') | list | length != 0
    - "'nosuid' not in home_mount.options"
    vars:
      removable_mount: "{{ ansible_mounts | json_query('[?mount == `/media`] | [0]') }}"

 
  - name: "MEDIUM | RHEL-07-021010 | AUDIT | The Red Hat Enterprise Linux operating system must prevent files with the setuid and setgid bit set from being executed on file systems that are used with removable media."
    mount:
      path: /mnt
      state: mounted
      src: "{{ removable_mount2.device }}"
      fstype: "{{ removable_mount2.fstype }}"
      opts: "{{ removable_mount2.options }},nosuid"
    when:
    - ansible_mounts | selectattr('mount', 'match', '^/mnt$') | list | length != 0
    - "'nosuid' not in home_mount.options"
    vars:
      removable_mount2: "{{ ansible_mounts | json_query('[?mount == `/mnt`] | [0]') }}"

  when:
  - rhel_07_021010
  - not (rhel7stig_system_is_chroot and rhel7stig_system_is_container)
  tags:
  - RHEL-07-021010

- name: "MEDIUM | RHEL-07-021020 | PATCH | The Red Hat Enterprise Linux operating system must prevent files with the setuid and setgid bit set from being executed on file systems that are being imported via Network File System (NFS)."
  mount:
    path: "{{ item }}"
    src: "{{ ansible_mounts | json_query(device_query) }}"
    fstype: "{{ ansible_mounts | json_query(fstype_query) }}"
    opts: "{{ ansible_mounts | json_query(options_query) }},nosuid"
    state: mounted
  vars:
    device_query: '[?mount == `{{ item }}`] | [0].device'
    fstype_query: '[?mount == `{{ item }}`] | [0].fstype'
    options_query: '[?mount == `{{ item }}`] | [0].options'
  with_items: "{{ rhel7stig_nfs_mounts }}"
  when:
  - rhel_07_021020
  - "'nosuid' not in (ansible_mounts | json_query(options_query))"
  tags:
  - RHEL-07-021020

- name: "MEDIUM | RHEL-07-021021 | PATCH | The Red Hat Enterprise Linux operating system must prevent binary files from being executed on file systems that are being imported via Network File System (NFS)."
  mount:
    path: "{{ item }}"
    src: "{{ ansible_mounts | json_query(device_query) }}"
    fstype: "{{ ansible_mounts | json_query(fstype_query) }}"
    opts: "{{ ansible_mounts | json_query(options_query) }},noexec"
    state: mounted
  vars:
    device_query: '[?mount == `{{ item }}`] | [0].device'
    fstype_query: '[?mount == `{{ item }}`] | [0].fstype'
    options_query: '[?mount == `{{ item }}`] | [0].options'
  with_items: "{{ rhel7stig_nfs_mounts }}"
  when:
  - rhel_07_021021
  - "'noexec' not in (ansible_mounts | json_query(options_query))"
  tags:
  - RHEL-07-021021

- name: "MEDIUM | RHEL-07-021030 | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are group-owned by root, sys, bin, or an application group."
  block:
  - name: "MEDIUM | RHEL-07-021030 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are group-owned by root, sys, bin, or an application group."
    command: find {{ rhel7stig_local_mounts | join(' ') }} -xdev -type d -perm -002 -gid +999
    changed_when: rhel_07_021030_audit.stdout != ""
    check_mode: no
    register: rhel_07_021030_audit

  - name: "MEDIUM | RHEL-07-021030 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are group-owned by root, sys, bin, or an application group."
    file:
      path: "{{ item }}"
      group: root
    check_mode: "{{ rhel7stig_disruptive_check_mode }}"
    with_items: "{{ rhel_07_021030_audit.stdout_lines }}"
  when:
  - rhel_07_021030
  - rhel7stig_disruptive
  tags:
  - RHEL-07-021030
  - disruption-high

- name: "MEDIUM | RHEL-07-021031 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are owned by root, sys, bin, or an application user."
  block:
  - name: "MEDIUM | RHEL-07-021031 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are owned by root, sys, bin, or an application user. | Get world-writable files"
    shell: "find {{ item.mount }} -xdev -type d -perm -0002 -uid +999 -print"
    changed_when: false
    failed_when: false
    register: rhel_07_021031_world_writable_files
    with_items:
    - "{{ ansible_facts.mounts }}"
      
  - name: "MEDIUM | RHEL-07-021031 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are owned by root, sys, bin, or an application user. | Flatten results"
    set_fact:
      rhel_07_021031_world_writable_files_flat: "{{ ol_07_021031_world_writable_files.results | map(attribute='stdout_lines') | flatten }}"

  - name: "MEDIUM | RHEL-07-021031 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are owned by root, sys, bin, or an application user. | List world-writable files"
    debug:
      msg:
        - "Below are the world-writable files"
        - "{{ rhel_07_021031_world_writable_files_flat }}"
    when: 
    - rhel_07_021031_world_writable_files_flat != []

  - name: "MEDIUM | RHEL-07-021031 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are owned by root, sys, bin, or an application user. | Alert on no world-writable files"
    debug:
      msg:
        - "Good News! No world-writable files detected"
    when: 
    - rhel_07_021031_world_writable_files_flat == []

  - name: "MEDIUM | RHEL-07-021031 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are owned by root, sys, bin, or an application user. | Adjust world-writable files"
    file:
      path: "{{ item }}"
      owner: root
    with_items:
    - "{{ rhel_07_021031_world_writable_files_flat }}"
    when:
    - rhel7stig_world_write_files_owner_root
    - rhel_07_021031_world_writable_files_flat != []
  when:
  - rhel_07_021031
  tags:
  - RHEL-07-021031
  - fileperms

- name: "MEDIUM | RHEL-07-021040 | PATCH | The Red Hat Enterprise Linux operating system must set the umask value to 077 for all local interactive user accounts."
  file:
    path: "{{ item }}"
    mode: '0700'
    state: touch
  with_items: "{{ rhel_07_stig_interactive_homedir_inifiles }}"
  changed_when: no
  when:
  - rhel_07_021040
  - rhel_07_stig_interactive_homedir_inifiles is defined
  tags:
  - RHEL-07-021040

- name: "MEDIUM | RHEL-07-021100 | PATCH | The Red Hat Enterprise Linux operating system must have cron logging implemented."
  lineinfile:
    path: /etc/rsyslog.conf
    state: present
    regexp: '^cron\.\*[ \t]+/var/log/cron$'
    line: 'cron.*                                                  /var/log/cron'
    insertafter: '#### RULES ####'
  register: result
  failed_when:
  - result is failed
  - result.rc != 257
  when: 
  - rhel_07_021100
  tags:
  - RHEL-07-021100

- name: |
      MEDIUM | RHEL-07-021110 | The Red Hat Enterprise Linux operating system must be configured so that the cron.allow file, if it exists, is owned by root.
      MEDIUM | RHEL-07-021120 | The Red Hat Enterprise Linux operating system must be configured so that the cron.allow file, if it exists, is group-owned by root.
  block:
  - name: "MEDIUM | RHEL-07-021110, RHEL-07-021120 | PATCH | Check if cron.allow file exists"
    stat:
      path: /etc/cron.allow
    register: cron_allow_file_check

  - name: "MEDIUM | RHEL-07-021110, RHEL-07-021120 | PATCH | Set cron.allow file owner and group-owner to root"
    file:
      dest: /etc/cron.allow
      state: file
      owner: root
      group: root
      mode: 0600
    when: cron_allow_file_check.stat.exists
  when:
  - rhel_07_021110
  - rhel_07_021120
  tags:
  - RHEL-07-021110
  - RHEL-07-021120
  - cron

- name: "MEDIUM | RHEL-07-021300 | The Red Hat Enterprise Linux operating system must disable Kernel core dumps unless needed."
  block:
  - name: "MEDIUM | RHEL-07-021300 | PATCH | The Red Hat Enterprise Linux operating system must disable Kernel core dumps unless needed."
    shell: "systemctl show kdump | grep LoadState | cut -d = -f 2"
    register: rhel_07_021300_kdump_service_status
    changed_when: no
    check_mode: no

  - name: "MEDIUM | RHEL-07-021300 | PATCH | The Red Hat Enterprise Linux operating system must disable Kernel core dumps unless needed."
    service:
      name: kdump
      enabled: no
      state: stopped
    when:
    - rhel_07_021300_kdump_service_status.stdout == "loaded"
    - not rhel7stig_kdump_required
  when: 
  - rhel_07_021300
  tags:
  - RHEL-07-021300

- name: "MEDIUM | RHEL-07-021620 | The Red Hat Enterprise Linux operating system must use a file integrity tool that is configured to use FIPS 140-2 approved cryptographic hashes for validating file contents and directories."
  block:
  - name: "Replace sha256+sha512 entries with sha512"
    replace:
      path: /etc/aide.conf
      regexp: '([A-Z]+ = .*)(sha256\+sha512)(.*)'
      replace: '\1sha512\3'
    register: rhel_07_021620_sha256_512_result
    notify: "{{ rhel7stig_aide_handler }}"

  - name: "Replace sha256 entries with sha512"
    replace:
      path: /etc/aide.conf
      regexp: '([A-Z]+ = .*)(sha256)(.*)'
      replace: '\1sha512\3'
    register: rhel_07_021620_sha256_result
    notify: "{{ rhel7stig_aide_handler }}"

  when: 
  - rhel_07_021620
  tags:
  - aide
  - RHEL-07-021620

- name: "MEDIUM | RHEL-07-021700 | AUDIT | The Red Hat Enterprise Linux operating system must not allow removable media to be used as the boot loader unless approved."
  block:
  # Let's see what is configured in grub.
  - name: "MEDIUM | RHEL-07-021700 | AUDIT | The Red Hat Enterprise Linux operating system must not allow removable media to be used as the boot loader unless approved."
    shell: grep "set root" "{{ rhel7stig_grub_cfg_path }}"
    register: rhel7stig_grub_cfg_mediacheck
    changed_when: false
    failed_when: false
  
  # Set the fact, even if the return was empty/nonexistant
  - name: "MEDIUM | RHEL-07-021700 | AUDIT | The Red Hat Enterprise Linux operating system must not allow removable media to be used as the boot loader unless approved."
    set_fact:
      rhel7stig_grub_bootloader_checkorder: "{{ rhel7stig_grub_cfg_mediacheck.stdout_lines | default(rhel7stig_grub_bootloader_validorder | list) | unique }}"
  
  # Report on the bootloader list
  - name: "MEDIUM | RHEL-07-021700 | AUDIT | The Red Hat Enterprise Linux operating system must not allow removable media to be used as the boot loader unless approved."
    debug:
      msg: "The grub2 bootloader is configured to set root for menu entries as follows: {{ item }}. The configured expected entry is \"{{ rhel7stig_grub_bootloader_validorder }}\". If the system is using an alternate boot loader on removable media, and documentation does not exist approving the alternate configuration, this is a finding. You can set this comparison list in default vars as 'rhel7stig_grub_bootloader_validorder'"
    changed_when: true
    with_items:
    - "{{ rhel7stig_grub_bootloader_checkorder }}"
    when: rhel7stig_grub_bootloader_validorder != rhel7stig_grub_bootloader_checkorder

  when:
  - rhel_07_021700
  - not rhel7stig_system_is_chroot
  - not rhel7stig_system_is_container
  tags:
  - RHEL-07-021700
  - grub
  - bootloader

######################
####### 030000 #######
######################

- name: "MEDIUM | RHEL-07-030000 | The Red Hat Enterprise Linux operating system must be configured so that auditing is configured to produce records containing information to establish what type of events occurred, where the events occurred, the source of the events, and the outcome of the events. These audit records must also identify individual identities of group account users."
  block:
  - name: "MEDIUM | RHEL-07-030000 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that auditing is configured to produce records containing information to establish what type of events occurred, where the events occurred, the source of the events, and the outcome of the events. These audit records must also identify individual identities of group account users."
    yum:
      name: audit
      state: present
    args:
      ansible_python_interpreter: "{{ python2_bin }}"  

  - name: "MEDIUM | RHEL-07-030000 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that auditing is configured to produce records containing information to establish what type of events occurred, where the events occurred, the source of the events, and the outcome of the events. These audit records must also identify individual identities of group account users."
    service:
      name: auditd
      state: "{{ rhel7stig_service_started }}"
      enabled: yes
    when:
    - not rhel7stig_system_is_container
  when:
  - rhel_07_030000
  tags:
  - RHEL-07-030000
  - auditd

- name: "MEDIUM | RHEL-07-030010 | PATCH | The Red Hat Enterprise Linux operating system must shut down upon audit processing failure, unless availability is an overriding concern. If availability is a concern, the system must alert the designated staff (System Administrator [SA] and Information System Security Officer [ISSO] at a minimum) in the event of an audit processing failure."
  lineinfile:
    path: /etc/audit/rules.d/audit.rules
    regexp: "^-f "
    line: "-f {{ rhel7stig_auditd_failure_flag }}"
  notify: update running audit failure mode
  when: 
  - rhel_07_030010
  tags:
  - auditd
  - RHEL-07-030010

- name: "MEDIUM | OL-07-030201 | PATCH | The Red Hat Enterprise Linux operating system must be configured to off-load audit logs onto a different system or storage media from the system being audited."
  lineinfile:
    path: /etc/audisp/plugins.d/au-remote.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    create: yes
  notify: restart auditd
  with_items:
  - { regexp: '^direction =', line: 'direction = out' }
  - { regexp: '^path =', line: 'path = /sbin/audisp-remote' }
  - { regexp: '^type =', line: 'type = always' }
  when:
  - rhel_07_030201
  tags:
  - RHEL-07-030201
  - auditd

- name: "MEDIUM | OL-07-030210 | PATCH | The Red Hat Enterprise Linux operating system must take appropriate action when the remote logging buffer is full."
  lineinfile:
    path: /etc/audisp/audispd.conf
    regexp: '^overflow_action ='
    line: "overflow_action = syslog"
  notify: restart auditd
  when:
  - rhel_07_030210
  tags:
  - auditd

- name: "MEDIUM | OL-07-030211 | PATCH | The Red Hat Enterprise Linux operating system must label all off-loaded audit logs before sending them to the central log server."
  lineinfile:
    path: /etc/audisp/audispd.conf
    regexp: '^name_format ='
    line: name_format = hostname
  notify: restart auditd
  when:
  - rhel_07_030211
  tags:
  - RHEL-07-030211
  - auditd

- name: "MEDIUM | RHEL-07-030300 | PATCH | The Red Hat Enterprise Linux operating system must off-load audit records onto a different system or media from the system being audited."
  lineinfile:
    path: /etc/audisp/audisp-remote.conf
    regexp: ^remote_server *=
    line: remote_server = {{ rhel7stig_audisp_remote_server }}
  when: 
  - rhel_07_030300 and rhel7stig_audisp_remote_server
  tags:
  - auditd
  - RHEL-07-030300

- name: "MEDIUM | RHEL-07-030310 | PATCH | The Red Hat Enterprise Linux operating system must encrypt the transfer of audit records off-loaded onto a different system or media from the system being audited."
  lineinfile:
    path: /etc/audisp/audisp-remote.conf
    regexp: ^enable_krb5 +=
    line: enable_krb5 = yes
  when: 
  - rhel_07_030310
  tags:
  - auditd
  - RHEL-07-030310

- name: "MEDIUM | RHEL-07-030320 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the audit system takes appropriate action when the audit storage volume is full."
  lineinfile:
    path: /etc/audisp/audisp-remote.conf
    regexp: ^disk_full_action +=
    line: "disk_full_action = {{ rhel7stig_audisp_disk_full_action }}"
  when: 
  - rhel_07_030320
  tags:
  - auditd
  - RHEL-07-030320

- name: "MEDIUM | RHEL-07-030321 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the audit system takes appropriate action when there is an error sending audit records to a remote system."
  lineinfile:
    path: /etc/audisp/audisp-remote.conf
    regexp: ^network_failure_action +=
    line: "network_failure_action = {{ rhel7stig_audisp_network_failure_action }}"
  when: 
  - rhel_07_030321
  tags:
  - auditd
  - RHEL-07-030321

- name: "MEDIUM | RHEL-07-030330 | PATCH | The Red Hat Enterprise Linux operating system must initiate an action to notify the System Administrator (SA) and Information System Security Officer ISSO, at a minimum, when allocated audit record storage volume reaches 75% of the repository maximum audit record storage capacity."
  lineinfile:
    path: /etc/audit/auditd.conf
    regexp: ^space_left +=
    line: "space_left = {{ [rhel7stig_auditd_space_left | int, 51] | max }}"
  when: 
  - rhel_07_030330
  tags:
  - auditd
  - RHEL-07-030330

- name: "MEDIUM | RHEL-07-030340 | PATCH | The Red Hat Enterprise Linux operating system must immediately notify the System Administrator (SA) and Information System Security Officer (ISSO) (at a minimum) via email when the threshold for the repository maximum audit record storage capacity is reached."
  lineinfile:
    path: /etc/audit/auditd.conf
    regexp: ^space_left_action +=
    line: "space_left_action = email"
  register: rhel7stig_auditd_space_left_action_result
  failed_when:
  - rhel7stig_auditd_space_left_action_result is failed
  - rhel7stig_auditd_space_left_action_result.rc != 257
  when: 
  - rhel_07_030340
  tags:
  - auditd
  - RHEL-07-030340

- name: "MEDIUM | RHEL-07-030350 | PATCH | The Red Hat Enterprise Linux operating system must immediately notify the System Administrator (SA) and Information System Security Officer (ISSO) (at a minimum) when the threshold for the repository maximum audit record storage capacity is reached."
  lineinfile:
    path: /etc/audit/auditd.conf
    regexp: ^action_mail_acct +=
    line: "action_mail_acct = {{ rhel7stig_auditd_mail_acct }}"
  register: rhel7stig_auditd_action_mail_acct_result
  failed_when:
  - rhel7stig_auditd_action_mail_acct_result is failed
  - rhel7stig_auditd_action_mail_acct_result.rc != 257
  when: 
  - rhel_07_030350
  tags:
  - auditd
  - RHEL-07-030350

- name: "MEDIUM | RHEL-07-030360 | The Red Hat Enterprise Linux operating system must audit all executions of privileged functions."
  block:
  - name: "MEDIUM | RHEL-07-030360 | PATCH | The Red Hat Enterprise Linux operating system must audit all executions of privileged functions. (Delete obsolete suid/sgid rules)"
    file:
      path: "/etc/audit/rules.d/rhel7stig_suid_sgid_commands.rules"
      state: absent

  - name: "MEDIUM | RHEL-07-030360 | PATCH | The Red Hat Enterprise Linux operating system must audit all executions of privileged functions. (Audit rules for execve calls)"
    lineinfile:
      path: "/etc/audit/rules.d/rhel7stig_execve_calls.rules"
      create: yes
      owner: root
      group: root
      mode: 0600
      line: "{{ item }}"
      state: present
    with_items:
    - "-a always,exit -F arch=b32 -S execve -C uid!=euid -F euid=0 -k setuid"
    - "-a always,exit -F arch=b64 -S execve -C uid!=euid -F euid=0 -k setuid"
    - "-a always,exit -F arch=b32 -S execve -C gid!=egid -F egid=0 -k setgid"
    - "-a always,exit -F arch=b64 -S execve -C gid!=egid -F egid=0 -k setgid"
    notify: restart auditd

  when: 
  - rhel_07_030360
  tags:
  - audit-rules
  - RHEL-07-030360

- name: "MEDIUM | Auditing system calls"
  include_tasks: audit_system_call.yml
  with_items:
  - id: "030370"
    call: "chown"
    key: "perm_mod"
  - id: "030380"
    call: "fchown"
    key: "perm_mod"
  - id: "030390"
    call: "lchown"
    key: "perm_mod"
  - id: "030400"
    call: "fchownat"
    key: "perm_mod"
  - id: "030410"
    call: "chmod"
    key: "perm_mod"
  - id: "030420"
    call: "fchmod"
    key: "perm_mod"
  - id: "030430"
    call: "fchmodat"
    key: "perm_mod"
  - id: "030440"
    call: "setxattr"
    key: "perm_mod"
  - id: "030450"
    call: "fsetxattr"
    key: "perm_mod"
  - id: "030460"
    call: "lsetxattr"
    key: "perm_mod"
  - id: "030470"
    call: "removexattr"
    key: "perm_mod"
  - id: "030480"
    call: "fremovexattr"
    key: "perm_mod"
  - id: "030490"
    call: "lremovexattr"
    key: "perm_mod"
  - id: "030500"
    call: "creat"
    extra_fields: "-F exit=-EPERM"
    key: "access"
  - id: "030500"
    call: "creat"
    extra_fields: "-F exit=-EACCES"
    key: "access"
  - id: "030510"
    call: "open"
    extra_fields: "-F exit=-EPERM"
    key: "access"
  - id: "030510"
    call: "open"
    extra_fields: "-F exit=-EACCES"
    key: "access"
  - id: "030520"
    call: "openat"
    extra_fields: "-F exit=-EPERM"
    key: "access"
  - id: "030520"
    call: "openat"
    extra_fields: "-F exit=-EACCES"
    key: "access"
  - id: "030530"
    call: "open_by_handle_at"
    extra_fields: "-F exit=-EPERM"
    key: "access"
  - id: "030530"
    call: "open_by_handle_at"
    extra_fields: "-F exit=-EACCES"
    key: "access"
  - id: "030540"
    call: "truncate"
    extra_fields: "-F exit=-EACCES"
    key: "access"
  - id: "030540"
    call: "truncate"
    extra_fields: "-F exit=-EPERM"
    key: "access"
  - id: "030550"
    call: "ftruncate"
    extra_fields: "-F exit=-EACCES"
    key: "access"
  - id: "030550"
    call: "ftruncate"
    extra_fields: "-F exit=-EPERM"
    key: "access"
  - id: "030740"
    call: "mount"
    key: "privileged-mount"
  - id: "030819"
    call: "create_module"
    include_all_auids: yes
    key: "module-change"
  - id: "030820"
    call: "init_module"
    include_all_auids: yes
    key: "module-change"
  - id: "030821"
    call: "finit_module"
    include_all_auids: yes
    key: "module-change"
  - id: "030830"
    call: "delete_module"
    include_all_auids: yes
    key: "module-change"
  - id: "030880"
    call: "rename"
    key: "delete"
  - id: "030890"
    call: "renameat"
    key: "delete"
  - id: "030900"
    call: "rmdir"
    key: "delete"
  - id: "030910"
    call: "unlink"
    key: "delete"
  - id: "030920"
    call: "unlinkat"
    key: "delete"
  tags:
  - audit-rules

- name: "MEDIUM | Auditing commands"
  include_tasks: audit_command.yml
  with_items:
  - id: "030560"
    path: "/usr/sbin/semanage"
    key: "privileged-priv_change"
    no_perm_x_filter: true
  - id: "030570"
    path: "/usr/sbin/setsebool"
    key: "privileged-priv_change"
    no_perm_x_filter: true
  - id: "030580"
    path: "/usr/bin/chcon"
    key: "privileged-priv_change"
    no_perm_x_filter: true
  - id: "030590"
    path: "/usr/sbin/setfiles"
    key: "privileged-priv_change"
    no_perm_x_filter: true
  - id: "030630"
    path: "/usr/bin/passwd"
    key: "privileged-passwd"
  - id: "030640"
    path: "/usr/sbin/unix_chkpwd"
    key: "privileged-passwd"
    no_perm_x_filter: true
  - id: "030650"
    path: "/usr/bin/gpasswd"
    key: "privileged-passwd"
  - id: "030660"
    path: "/usr/bin/chage"
    key: "privileged-passwd"
  - id: "030670"
    path: "/usr/sbin/userhelper"
    key: "privileged-passwd"
  - id: "030680"
    path: "/usr/bin/su"
    key: "privileged-priv_change"
    no_perm_x_filter: true
  - id: "030690"
    path: "/usr/bin/sudo"
    key: "privileged-priv_change"
    no_perm_x_filter: true
  - id: "030710"
    path: "/usr/bin/newgrp"
    key: "privileged-priv_change"
    no_perm_x_filter: true
  - id: "030720"
    path: "/usr/bin/chsh"
    key: "privileged-priv_change"
    no_perm_x_filter: true
  - id: "030740"
    path: "/usr/bin/mount"
    key: "privileged-mount"
    no_perm_x_filter: true
  - id: "030750"
    path: "/usr/bin/umount"
    key: "privileged-mount"
    no_perm_x_filter: true
  - id: "030760"
    path: "/usr/sbin/postdrop"
    key: "privileged-postfix"
    no_perm_x_filter: true
  - id: "030770"
    path: "/usr/sbin/postqueue"
    key: "privileged-postfix"
    no_perm_x_filter: true
  - id: "030780"
    path: "/usr/libexec/openssh/ssh-keysign"
    key: "privileged-ssh"
    no_perm_x_filter: true
  - id: "030800"
    path: "/usr/bin/crontab"
    key: "privileged-cron"
    no_perm_x_filter: true
  - id: "030810"
    path: "/usr/sbin/pam_timestamp_check"
    key: "privileged-pam"
    no_perm_x_filter: true
  - id: "030840"
    path: "/usr/bin/kmod"
    trivial: yes
    key: "module-change"
  tags:
  - audit-rules

- name: "MEDIUM | Auditing files"
  include_tasks: audit_file.yml
  with_items:
  - id: "030610"
    path: "/var/run/faillock"
    description: "unsuccessful account access events"
    key: "logins"
  - id: "030620"
    path: "/var/log/lastlog"
    description: "successful account access events"
    key: "logins"
  - id: "030700"
    path: "/etc/sudoers"
    description: "modifications to sudoers"
    key: "privileged-actions"
  - id: "030700"
    path: "/etc/sudoers.d/"
    description: "modifications to sudoers"
    key: "privileged-actions"
  - id: "030870"
    path: "/etc/passwd"
    description: "account creations, modifications, disabling, and termination events that affect /etc/passwd"
    key: "identity"
  - id: "030871"
    path: "/etc/group"
    description: "account creations, modifications, disabling, and termination events that affect /etc/group"
    key: "identity"
  - id: "030872"
    path: "/etc/gshadow"
    description: "account creations, modifications, disabling, and termination events that affect /etc/gshadow"
    key: "identity"
  - id: "030873"
    path: "/etc/shadow"
    description: "account creations, modifications, disabling, and termination events that affect /etc/shadow"
    key: "identity"
  - id: "030874"
    path: "/etc/security/opasswd"
    description: "account creations, modifications, disabling, and termination events that affect /etc/security/opasswd"
    key: "identity"
  tags:
  - audit-rules

- name: "MEDIUM | RHEL-07-031000 | PATCH | The Red Hat Enterprise Linux operating system must send rsyslog output to a log aggregation server."
  blockinfile:
    path: /etc/rsyslog.conf
    state: present
    block: |
        $ActionQueueFileName rhel-07-031000  # unique name prefix for spool files
        $ActionQueueMaxDiskSpace 1g    # 1gb space limit (use as much as possible)
        $ActionQueueSaveOnShutdown on  # save messages to disk on shutdown
        $ActionQueueType LinkedList    # run asynchronously
        $ActionResumeRetryCount -1     # infinite retries if host is down
        # remote host is: name/ip:port, e.g. 192.168.0.1:514, port optional
        *.* @@{{ rhel7stig_log_aggregation_server }}
    insertafter: EOF
  register: result
  failed_when:
  - result is failed
  - result.rc != 257
  when:
  - rhel_07_031000
  - rhel7stig_log_aggregation_server is defined
  tags:
  - RHEL-07-031000
  - rsyslog

- name: "MEDIUM | RHEL-07-031010 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the rsyslog daemon does not accept log messages from other servers unless the server is being used for log aggregation."
  replace:
    path: /etc/rsyslog.conf
    regexp: '({{ item }})'
    replace: '# \1'
  with_items:
  - '^(\$ModLoad imtcp)'
  - '^(\$ModLoad imudp)'
  - '^(\$ModLoad imrelp)'
  #- '^(\$UDPServerRun)'
  #- '^(\$InputTCPServerRun)'
  when:
  - rhel_07_031010
  - not rhel7stig_system_is_log_aggregator
  register: result
  failed_when:
  - result is failed
  - result.rc != 257
  tags:
  - RHEL-07-031010
  - rsyslog

######################
####### 040000 #######
######################

# NOTE: 040520 has to come before 040100 because the naming conventions of STIG do not lend themselves to ordered operations. IE: I need to start the service before I can audit incoming ports to what zones, etc.
- name: "MEDIUM | RHEL-07-040520 | PATCH | The Red Hat Enterprise Linux operating system must enable an application firewall, if available."
  block:
  - name: "MEDIUM | RHEL-07-040520 | PATCH | The Red Hat Enterprise Linux operating system must enable an application firewall, if available."
    yum:
      name: firewalld
      state: present
    args:
      ansible_python_interpreter: "{{ python2_bin }}"
    when:
    - rhel_07_040520
    - rhel7stig_firewall_service == "firewalld"
    - not (rhel7stig_system_is_chroot and rhel7stig_system_is_container)
    tags:
    - RHEL-07-040520
    - firewall
    
  - name: "MEDIUM | RHEL-07-040520 | PATCH | The Red Hat Enterprise Linux operating system must enable an application firewall, if available."
    yum:
      name: iptables-services
      state: present
    args:
      ansible_python_interpreter: "{{ python2_bin }}"
    when:
    - rhel_07_040520
    - rhel7stig_firewall_service == "iptables"
    - not (rhel7stig_system_is_chroot and rhel7stig_system_is_container)
    tags:
    - RHEL-07-040520
    - firewall
    
  - name: "MEDIUM | RHEL-07-040520 | PATCH | The Red Hat Enterprise Linux operating system must enable an application firewall, if available."
    service:
      name: "{{ rhel7stig_firewall_service }}"
      state: "{{ rhel7stig_service_started }}"
      enabled: yes
    when:
    - rhel_07_040520
    - not (rhel7stig_system_is_chroot and rhel7stig_system_is_container)
    - rhel7stig_start_firewall_service
    tags:
    - RHEL-07-040520
    - firewall
  when:
  - rhel_07_040520
  - rhel7stig_firewall_service == 'firewalld' or rhel7stig_firewall_service == 'iptables'
  - not (rhel7stig_system_is_chroot and rhel7stig_system_is_container)
  - rhel7stig_disruptive
  - not ansible_distribution == "OracleLinux"
  tags:
  - RHEL-07-040520
  - firewall
  - disruption-high

- name: "MEDIUM | RHEL-07-040100 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
  block:
  - name: "MEDIUM | RHEL-07-040100 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
    block:
    - name: "MEDIUM | RHEL-07-040100 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
      shell: firewall-cmd --list-all | grep services | cut -d ':' -f 2 | tr " " "\n" | sed '/^$/d' | sort -u
      register: rhel7stig_PPSM_CLSA_check_firewalld
      changed_when: false
      failed_when: false
      check_mode: no
      when:
      - rhel_07_040100
      tags:
      - RHEL-07-040100
      - firewall
  
    - name: "MEDIUM | RHEL-07-040100 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
      debug:
        msg: "The following task output is what firewalld is accepting on service ports to {{ ansible_hostname }}."
      changed_when: true
      when:
      - rhel_07_040100
      - rhel7stig_PPSM_CLSA_check_firewalld.stdout_lines is defined
      tags:
      - RHEL-07-040100
      - firewall
  
    - name: "MEDIUM | RHEL-07-040100 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
      debug: var=rhel7stig_PPSM_CLSA_check_firewalld.stdout_lines
      changed_when: true
      when:
      - rhel_07_040100
      - rhel7stig_PPSM_CLSA_check_firewalld.stdout_lines is defined
      tags:
      - RHEL-07-040100
      - firewall
    when:
    - rhel_07_040100
    - not rhel7stig_system_is_chroot
    - not rhel7stig_system_is_container
    - rhel7stig_firewall_service == "firewalld"
    - rhel7stig_start_firewall_service
    tags:
    - RHEL-07-040100
    - firewall
   
  - name: "MEDIUM | RHEL-07-040100 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
    block:
    - name: "MEDIUM | RHEL-07-040100 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
      shell: iptables-save | grep -i accept | grep -i input
      register: rhel7stig_PPSM_CLSA_check_iptables
      changed_when: false
      failed_when: false
      check_mode: no
      when: 
      - rhel_07_040100
      tags:
      - RHEL-07-040100
      - firewall
    
    - name: "MEDIUM | RHEL-07-040100 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
      debug:
        msg: "The following task output is what iptabes is accepting on service ports to {{ ansible_hostname }}."
      changed_when: true
      when:
      - rhel_07_040100
      - rhel7stig_PPSM_CLSA_check_iptables.stdout_lines is defined
      tags:
      - RHEL-07-040100
      - firewall
    
    - name: "MEDIUM | RHEL-07-040100 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
      debug: var=rhel7stig_PPSM_CLSA_check_iptables.stdout_lines
      changed_when: true
      when:
      - rhel_07_040100
      - rhel7stig_PPSM_CLSA_check_iptables.stdout_lines is defined
      tags:
      - RHEL-07-040100
      - firewall
    when:
    - rhel_07_040100
    - not rhel7stig_system_is_chroot
    - not rhel7stig_system_is_container
    - rhel7stig_firewall_service == "iptables"
    - rhel7stig_start_firewall_service
    tags:
    - RHEL-07-040100
    - firewall

  - name: "MEDIUM | RHEL-07-040100 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
    debug:
      msg: "Your configured firewall service is {{ rhel7stig_firewall_service }}, but you have set the variable rhel7stig_start_firewall_service to false. We cannot audit control RHEL-07-040100 - The Red Hat Enterprise Linux operating system must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
      changed_when: true
      when:
      - rhel_07_040100
      - not rhel7stig_start_firewall_service
      tags:
      - RHEL-07-040100
      - firewall
  when:
  - rhel_07_040100
  - not rhel7stig_system_is_chroot
  - not rhel7stig_system_is_container
  - rhel7stig_disruptive
  tags:
  - RHEL-07-040100
  - firewall
  - disruption-high

- name: "MEDIUM | RHEL-07-040110 | PATCH | The Red Hat Enterprise Linux operating system must use a FIPS 140-2 approved cryptographic algorithm for SSH communications."
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?Ciphers"
    line: Ciphers aes128-ctr,aes192-ctr,aes256-ctr
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040110
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040110
  - ssh

- name: "MEDIUM | RHEL-07-040160 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all network connections associated with a communication session are terminated at the end of the session or after 10 minutes of inactivity from the user at a command prompt, except to fulfill documented and validated mission requirements."
  blockinfile:
    create: yes
    mode: 0644
    dest: "{{ item.dest }}"
    state: "{{ item.state }}"
    marker: "# {mark} ANSIBLE MANAGED"
    block: |
      # Set session timeout - STIG ID RHEL-07-040160
      TMOUT={{ rhel7stig_shell_session_timeout.timeout }}
      readonly TMOUT
      export TMOUT
  with_items:
  - dest: "{{ rhel7stig_shell_session_timeout.file }}"
    state: present
  - dest: /etc/profile
    state: "{{ (rhel7stig_shell_session_timeout.file == '/etc/profile') | ternary('present', 'absent') }}"
  when: 
  - rhel_07_040160
  tags:
  - RHEL-07-040160
  - profile

- name: "MEDIUM | RHEL-07-040170 | PATCH | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner immediately prior to, or as part of, remote access logon prompts."
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?Banner"
    line: Banner /etc/issue
    validate: /usr/sbin/sshd -tf %s
  notify: restart sshd
  when:
  - rhel_07_040170
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040170
  - ssh
  - dod_logon_banner

- name: "MEDIUM | RHEL-07-040180 | RHEL-07-040190 | RHEL-07-040200 | The Red Hat Enterprise Linux operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) authentication communications."
  block:
  - name: "MEDIUM | RHEL-07-040180 | RHEL-07-040190 | RHEL-07-040200 | AUDIT | The Red Hat Enterprise Linux operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) authentication communications."
    shell: systemctl status sssd.service | grep "Active" | cut -d ':' -f1 | tr " " "\n" | sed '/^$/d'
    check_mode: no
    register: rhel_07_040180_audit
    failed_when: no
    changed_when: false
    when:
    - rhel_07_040180 or
      rhel_07_040190 or
      rhel_07_040200
    tags:
    - RHEL-07-040180
    - RHEL-07-040190
    - RHEL-07-040200
    - ldap
  
  - name: "MEDIUM | RHEL-07-040180 | RHEL-07-040190 | RHEL-07-040200 | AUDIT | The Red Hat Enterprise Linux operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) authentication communications."
    stat:
      path: /etc/sssd/sssd.conf
      register: rhel_07_040180_LDAPconf_audit
    changed_when: no
    when:
    - rhel_07_040180 or
      rhel_07_040190 or
      rhel_07_040200
    - rhel_07_040180_audit.stdout == "Active"
    tags:
    - RHEL-07-040180
    - RHEL-07-040190
    - RHEL-07-040200
    - ldap
  
  - name: "MEDIUM | RHEL-07-040180 | RHEL-07-040190 | RHEL-07-040200 | PATCH | The Red Hat Enterprise Linux operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) authentication communications."
    blockinfile:
      block: |
          ldap_id_use_start_tls = true
          ldap_tls_reqcert = demand
          ldap_tls_cacert = "{{ rhel_07_040200_cabundle_path }}"
      path: /etc/sssd/sssd.conf
      insertafter: "^ldap_search_base*"
      create: yes
    when:
    - rhel_07_040180 or
      rhel_07_040190 or
      rhel_07_040200
    - rhel_07_040180_audit.stdout == "Active"
    tags:
    - RHEL-07-040180
    - RHEL-07-040190
    - RHEL-07-040200
    - ldap
  when:
  - rhel_07_040180 or
    rhel_07_040190 or
    rhel_07_040200
  tags:
  - RHEL-07-040180
  - RHEL-07-040190
  - RHEL-07-040200
  - ldap

- name: "MEDIUM | RHEL-07-040201 | PATCH | The Red Hat Enterprise Linux operating system must implement virtual address space randomization."
  sysctl:
    name: kernel.randomize_va_space
    value: 2
    state: present
    reload: "{{ rhel7stig_sysctl_reload }}"
    sysctl_set: yes
    ignoreerrors: yes
  when: rhel_07_040201
  tags:
  - RHEL-07-040201
  - sysctl

- name: "MEDIUM | RHEL-07-040300 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all networked systems have SSH installed."
  yum:
    name:
    - openssh-clients
    - openssh-server
    state: present
  args:
      ansible_python_interpreter: "{{ python2_bin }}"
  when:
  - rhel_07_040300
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040300
  - ssh

- name: "MEDIUM | RHEL-07-040310 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all networked systems use SSH for confidentiality and integrity of transmitted and received information as well as information during preparation for transmission."
  service:
    name: sshd
    state: "{{ rhel7stig_service_started }}"
    enabled: yes
  when:
  - rhel_07_040310
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040310
  - ssh

- name: "MEDIUM | RHEL-07-040320 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all network connections associated with SSH traffic are terminated at the end of the session or after 10 minutes of inactivity, except to fulfill documented and validated mission requirements."
  lineinfile:
    create: yes
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?ClientAliveInterval"
    line: ClientAliveInterval {{ rhel7stig_ssh_session_timeout }}
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040320
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040320
  - ssh

- name: "MEDIUM | RHEL-07-040330 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using RSA rhosts authentication."
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?RhostsRSAAuthentication"
    line: RhostsRSAAuthentication no
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040330
  - rhel7stig_ssh_required
  - ansible_distribution_version is not version_compare('7.4', '>=')
  tags:
  - RHEL-07-040330
  - ssh

- name: "MEDIUM | RHEL-07-040340 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all network connections associated with SSH traffic terminate after a period of inactivity."
  lineinfile:
    create: yes
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?ClientAliveCountMax"
    line: ClientAliveCountMax 0
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040340
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040340
  - ssh

- name: "MEDIUM | RHEL-07-040350 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using rhosts authentication."
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?IgnoreRhosts"
    line: IgnoreRhosts yes
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040350
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040350
  - ssh

- name: "MEDIUM | RHEL-07-040360 | PATCH | The Red Hat Enterprise Linux operating system must display the date and time of the last successful account logon upon an SSH logon."
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?PrintLastLog"
    line: PrintLastLog yes
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040360
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040360
  - ssh

- name: "MEDIUM | RHEL-07-040370 | PATCH | The Red Hat Enterprise Linux operating system must not permit direct logons to the root account using remote access via SSH."
  lineinfile:
    create: yes
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?PermitRootLogin"
    line: PermitRootLogin no
    insertafter: '(?i)^#?authentication'
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040370
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040370
  - ssh

- name: "MEDIUM | RHEL-07-040380 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using known hosts authentication."
  lineinfile:
    create: yes
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?IgnoreUserKnownHosts"
    line: IgnoreUserKnownHosts yes
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040380
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040380
  - ssh

- name: "MEDIUM | RHEL-07-040400 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon is configured to only use Message Authentication Codes (MACs) employing FIPS 140-2 approved cryptographic hash algorithms."
  lineinfile:
    create: yes
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?MACs"
    line: MACs hmac-sha2-512,hmac-sha2-256
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040400
  - rhel7stig_ssh_required
  tags:
  - ssh
  - RHEL-07-040400

- name: "MEDIUM | RHEL-07-040410 | The Red Hat Enterprise Linux operating system must be configured so that the SSH public host key files have mode 0644 or less permissive."
  block:
  - name: "MEDIUM | RHEL-07-040410 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that the SSH public host key files have mode 0644 or less permissive."
    find:
      paths: /etc/ssh
      recurse: yes
      file_type: file
      patterns: 'ssh_host*_key.pub'
      hidden: true
    failed_when: no
    changed_when: no
    register: rhel_07_040410_audit

  - name: "MEDIUM | RHEL-07-040410 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH public host key files have mode 0644 or less permissive."
    file:
      dest: "{{ item.path }}"
      mode: a-stx,go-w
      state: file
    with_items: "{{ rhel_07_040410_audit.files | default([]) }}"
  when:
  - rhel_07_040410
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040410
  - ssh

- name: "MEDIUM | RHEL-07-040420 | The Red Hat Enterprise Linux operating system must be configured so that the SSH private host key files have mode 0640 or less permissive."
  block:
  - name: "MEDIUM | RHEL-07-040420 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that the SSH private host key files have mode 0640 or less permissive."
    find:
      paths: /etc/ssh
      recurse: yes
      file_type: file
      patterns: 'ssh_host*_key'
      hidden: true
    failed_when: no
    changed_when: no
    register: rhel_07_040420_audit

  - name: "MEDIUM | RHEL-07-040420 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH private host key files have mode 0640 or less permissive."
    file:
      dest: "{{ item.path }}"
      mode: a-stx,go-w,o-r
      state: file
    with_items: "{{ rhel_07_040420_audit.files | default([]) }}"
  when:
  - rhel_07_040420
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040420
  - ssh

- name: "MEDIUM | RHEL-07-040430 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not permit Generic Security Service Application Program Interface (GSSAPI) authentication unless needed."
  lineinfile:
    create: yes
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?GSSAPIAuthentication"
    line: GSSAPIAuthentication no
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040430
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040430
  - ssh

- name: "MEDIUM | RHEL-07-040440 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not permit Kerberos authentication unless needed."
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?KerberosAuthentication"
    line: KerberosAuthentication no
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040440
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040440
  - ssh

- name: "MEDIUM | RHEL-07-040450 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon performs strict mode checking of home directory configuration files."
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?StrictModes"
    line: StrictModes yes
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040450
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040450
  - ssh

- name: "MEDIUM | RHEL-07-040460 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon uses privilege separation."
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?UsePrivilegeSeparation"
    line: UsePrivilegeSeparation sandbox
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040460
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040460
  - ssh

- name: "MEDIUM | RHEL-07-040470 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow compression or only allows compression after successful authentication."
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?Compression"
    line: Compression no
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
  - rhel_07_040470
  - rhel7stig_ssh_required
  tags:
  - RHEL-07-040470
  - ssh

- name: "MEDIUM | OL-07-040480 | PATCH | The operating system must request and perform data origin authentication verification and data integrity verification on the name/address resolution responses the system receives from authoritative sources."
  block:
  - name: "MEDIUM | OL-07-040480 | PATCH | The operating system must request and perform data origin authentication verification and data integrity verification on the name/address resolution responses the system receives from authoritative sources. | Install unbound"
    yum:
      name: unbound
      state: present

  - name: "MEDIUM | OL-07-040480 | PATCH | The operating system must request and perform data origin authentication verification and data integrity verification on the name/address resolution responses the system receives from authoritative sources. | Start service"
    service:
      name: unbound
      enabled: true
  when:
  - ol_07_040480
  - ansible_distribution == "OracleLinux"
  tags:
  - OL-07-040480
  - OracleLinux
  - unbound

- name: "MEDIUM | RHEL-07-040500 | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
  block:
  - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
    yum:
      name: chrony
      state: absent
    args:
      ansible_python_interpreter: "{{ python2_bin }}"
    
  - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
    yum:
      name: ntp
      state: present
    args:
      ansible_python_interpreter: "{{ python2_bin }}"

  - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
    lineinfile:
      create: yes
      dest: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].conf }}"
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
    notify: restart {{ rhel7stig_time_service }}
    with_items: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].lines }}"
  when:
  - rhel7stig_time_service == 'ntpd'
  - rhel_07_040500
  tags:
  - RHEL-07-040500
  - ntp
  - ntpd

- name: "MEDIUM | RHEL-07-040500 | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
  block:
  - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
    yum:
      name: ntp
      state: absent
    args:
      ansible_python_interpreter: "{{ python2_bin }}"

  - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
    yum:
      name: chrony
      state: present
    args:
      ansible_python_interpreter: "{{ python2_bin }}"

  - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
    replace:
      dest: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].conf }}"
      regexp: '^server \S+( \w+)?$'
    notify: restart {{ rhel7stig_time_service }}
  when:
  - rhel7stig_time_service == 'chronyd'
  - rhel_07_040500
  tags:
  - RHEL-07-040500
  - chronyd

- name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
  blockinfile:
    insertbefore: BOF
    dest: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].conf }}"
    block: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].block }}"
    state: present
  notify: restart {{ rhel7stig_time_service }}
  when:
  - rhel7stig_time_service == 'chronyd'
  - rhel_07_040500
  tags:
  - RHEL-07-040500
  - chronyd

- name: "MEDIUM | OL-07-040510 | PATCH | The Oracle Linux operating system must protect against or limit the effects of Denial of Service (DoS) attacks by validating the operating system is implementing rate-limiting measures on impacted network interfaces."
  sysctl:
    name: net.ipv4.tcp_invalid_ratelimit
    value: "{{ ol7stig_ipv4_tcp_invalid_ratelimit }}"
    state: present
    reload: "{{ rhel7stig_sysctl_reload }}"
  when:
  - ol_07_040510
  - ansible_distribution == "OracleLinux"
  tags:
  - OL-07-040510
  - OracleLinux
  - sysctl
  - ipv4

- name: "MEDIUM | RHEL-07-040520 | PATCH | The Red Hat Enterprise Linux operating system must protect against or limit the effects of Denial of Service (DoS) attacks by validating the operating system is implementing rate-limiting measures on impacted network interfaces."
  yum:
    name: "{{ rhel7stig_firewall_service }}"
    state: present
  args:
      ansible_python_interpreter: "{{ python2_bin }}"
  when: 
  - rhel_07_040520
  tags:
      - RHEL-07-040520
      - firewall

- name: "MEDIUM | RHEL-07-040610 | PATCH | The Red Hat Enterprise Linux operating system must not forward Internet Protocol version 4 (IPv4) source-routed packets."
  sysctl:
    name: net.ipv4.conf.all.accept_source_route
    state: present
    value: 0
    reload: "{{ rhel7stig_sysctl_reload }}"
    ignoreerrors: yes
  when: 
  - rhel_07_040610
  tags:
  - RHEL-07-040610
  - ipv4

- name: "MEDIUM | RHEL-07-040611 | PATCH | The Red Hat Enterprise Linux operating system must use a reverse-path filter for IPv4 network traffic when possible on all interfaces."
  sysctl:
    name: net.ipv4.conf.all.rp_filter
    value: 1
    state: present
    reload: "{{ ol7stig_sysctl_reload }}"
  when:
  - rhel_07_040611
  tags:
  - RHEL-07-040611
  - sysctl
  - ipv4

- name: "MEDIUM | RHEL-07-040612 | PATCH | The Red Hat Enterprise Linux operating system must use a reverse-path filter for IPv4 network traffic when possible by default."
  sysctl:
    name: net.ipv4.conf.default.rp_filter
    state: present
    value: 1
    reload: "{{ ol7stig_sysctl_reload }}"
  when:
  - rhel_07_040612
  tags:
  - RHEL-07-040612
  - sysctl
  - ipv4

- name: "MEDIUM | RHEL-07-040620 | PATCH | The Red Hat Enterprise Linux operating system must not forward Internet Protocol version 4 (IPv4) source-routed packets by default."
  sysctl:
    name: net.ipv4.conf.default.accept_source_route
    state: present
    value: 0
    reload: "{{ rhel7stig_sysctl_reload }}"
    ignoreerrors: yes
  when: 
  - rhel_07_040620
  tags:
  - RHEL-07-040620
  - ipv4

- name: "MEDIUM | RHEL-07-040630 | PATCH | The Red Hat Enterprise Linux operating system must not respond to Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) echoes sent to a broadcast address."
  sysctl:
    name: net.ipv4.icmp_echo_ignore_broadcasts
    state: present
    value: 1
    sysctl_set: yes
    reload: "{{ rhel7stig_sysctl_reload }}"
    ignoreerrors: yes
  when: 
  - rhel_07_040630
  tags:
  - RHEL-07-040630
  - ipv4

- name: "MEDIUM | RHEL-07-040640 | PATCH | The Red Hat Enterprise Linux operating system must prevent Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages from being accepted."
  sysctl:
    name: net.ipv4.conf.default.accept_redirects
    state: present
    value: 0
    reload: "{{ rhel7stig_sysctl_reload }}"
    ignoreerrors: yes
  when: 
  - rhel_07_040640
  tags:
  - RHEL-07-040640
  - ipv4

- name: "MEDIUM | RHEL-07-040641 | PATCH | The Red Hat Enterprise Linux operating system must ignore Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages"
  sysctl:
    name: net.ipv4.conf.all.accept_redirects
    state: present
    value: 0
    reload: "{{ rhel7stig_sysctl_reload }}"
    ignoreerrors: yes
  when: 
  - rhel_07_040641
  tags:
  - RHEL-07-040641
  - ipv4

- name: "MEDIUM | RHEL-07-040650 | PATCH |  The Red Hat Enterprise Linux operating system must not allow interfaces to perform Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirects by default."
  sysctl:
    name: net.ipv4.conf.default.send_redirects
    state: present
    value: 0
    reload: "{{ rhel7stig_sysctl_reload }}"
    ignoreerrors: yes
  when: 
  - rhel_07_040650
  tags:
  - RHEL-07-040650
  - ipv4

- name: "MEDIUM | RHEL-07-040660 | PATCH | The Red Hat Enterprise Linux operating system must not send Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirects."
  sysctl:
    name: net.ipv4.conf.all.send_redirects
    state: present
    value: 0
    reload: "{{ rhel7stig_sysctl_reload }}"
    ignoreerrors: yes
  when: 
  - rhel_07_040660
  tags:
  - RHEL-07-040660
  - ipv4

- name: "MEDIUM | RHEL-07-040670 | Network interfaces configured on the Red Hat Enterprise Linux operating system must not be in promiscuous mode."
  block:
  - name: "MEDIUM | RHEL-07-040670 | PATCH | Network interfaces configured on the Red Hat Enterprise Linux operating system must not be in promiscuous mode."
    shell: "ip link | grep -i promisc | cut -d ':' -f 2"
    check_mode: no
    failed_when: no
    changed_when: rhel_07_040670_promisc_check.stdout != ''
    ignore_errors: yes
    register: rhel_07_040670_promisc_check

  - name: "MEDIUM | RHEL-07-040670 | PATCH | Network interfaces configured on the Red Hat Enterprise Linux operating system must not be in promiscuous mode."
    shell: "ip link set dev {{ item }} promisc off"
    with_items: "{{ rhel_07_040670_promisc_check.stdout_lines }}"

  when:
  - rhel_07_040670
  - not rhel7stig_net_promisc_mode_required
  tags:
  - RHEL-07-040670

- name: "MEDIUM | RHEL-07-040680 | The Red Hat Enterprise Linux operating system must be configured to prevent unrestricted mail relaying."
  block:
  - name: "MEDIUM | RHEL-07-040680 | AUDIT | Check if postfix is installed."
    command: rpm -q postfix
    failed_when: no
    check_mode: no
    changed_when: no
    register: rhel_07_040680_rpm_audit

  - name: "MEDIUM | RHEL-07-040680 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prevent unrestricted mail relaying."
    command: "/usr/sbin/postconf -n smtpd_client_restrictions"
    check_mode: no
    changed_when: no
    register: rhel_07_040680_postconf_audit
    when: rhel_07_040680_rpm_audit.rc == 0

  - name: "MEDIUM | RHEL-07-040680 | PATCH | The Red Hat Enterprise Linux operating system must be configured to prevent unrestricted mail relaying."
    command: "/usr/sbin/postconf -e 'smtpd_client_restrictions=permit_mynetworks, reject'"
    when:
    - rhel_07_040680_rpm_audit.rc == 0
    - rhel_07_040680_postconf_audit.stdout != 'smtpd_client_restrictions = permit_mynetworks, reject'
  when: 
  - rhel_07_040680
  tags:
  - RHEL-07-040680

- name: "MEDIUM | RHEL-07-040720 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that if the Trivial File Transfer Protocol (TFTP) server is required, the TFTP daemon is configured to operate in secure mode."
  lineinfile:
    path: /etc/xinetd.d/tftp
    regexp: "(?i)^.*server_args.*="
    line: "\tserver_args\t\t= -s /var/lib/tftpboot"
    insertafter: "\tserver\t\t\t="
    state: present
  register: result
  failed_when:
  - result is failed
  - result.rc != 257
  when:
  - rhel7stig_tftp_required
  - rhel_07_040720
  tags:
  - RHEL-07-040720

- name: "MEDIUM | RHEL-07-040730 | PATCH | The Red Hat Enterprise Linux operating system must not have an X Windows display manager installed unless approved."
  yum:
    name:
    - "@x11"
    - xorg-x11-server-common
    state: absent
  args:
    ansible_python_interpreter: "{{ python2_bin }}" 
  when:
  - not rhel7stig_gui
  - rhel_07_040730
  tags:
  - RHEL-07-040730
  - x11

- name: "MEDIUM | RHEL-07-040740 | PATCH | The Red Hat Enterprise Linux operating system must not be performing packet forwarding unless the system is a router."
  sysctl:
    name: net.ipv4.ip_forward
    state: present
    value: 0
    reload: "{{ rhel7stig_sysctl_reload }}"
    ignoreerrors: yes
  when:
  - not rhel7stig_system_is_router
  - rhel_07_040740
  tags:
  - RHEL-07-040740
  - ipv4

- name: "MEDIUM | RHEL-07-040750 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the Network File System (NFS) is configured to use RPCSEC_GSS."
  block:
  - name: "MEDIUM | RHEL-07-040750 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the Network File System (NFS) is configured to use RPCSEC_GSS."
    shell: cat /etc/fstab | grep nfs
    register: rhel_07_040750_nfssec_check
    changed_when: false
    failed_when: false
    check_mode: no
    when: 
    - rhel_07_040750
    tags:
    - RHEL-07-040750

  - name: "MEDIUM | RHEL-07-040750 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the Network File System (NFS) is configured to use RPCSEC_GSS."
    debug:
        msg: "There were no applicable NFS mounts found to audit per RHEL-07-040750."
    changed_when: true
    when:
    - rhel_07_040750
    - rhel_07_040750_nfssec_check.stdout_lines is not defined
    tags:
    - RHEL-07-040750

  - name: "MEDIUM | RHEL-07-040750 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the Network File System (NFS) is configured to use RPCSEC_GSS."
    debug:
        msg: "The following NFS mount is required to be audited per RHEL-07-040750: {{ item }} - If the system is mounting file systems via NFS and has the sec option without the 'krb5:krb5i:krb5p' settings, the 'sec' option has the 'sys' setting, or the 'sec' option is missing, this is a finding."
    with_items:
    - "{{ rhel_07_040750_nfssec_check.stdout_lines }}"
    changed_when: true
    when:
    - rhel_07_040750
    - rhel_07_040750_nfssec_check.stdout_lines is defined
    tags:
    - RHEL-07-040750

  when: 
  - rhel_07_040750
  tags:
  - RHEL-07-040750

- name: "MEDIUM | RHEL-07-040810 | AUDIT | The Red Hat Enterprise Linux operating system access control program must be configured to grant or deny system access to specific hosts and services."
  block:
  - name: "MEDIUM | RHEL-07-040810 | AUDIT | The Red Hat Enterprise Linux operating system access control program must be configured to grant or deny system access to specific hosts and services."
    include_tasks: audit_firewalld.yml
    when:
    - rhel_07_040810
    - rhel7stig_firewall_service == "firewalld"
    tags:
    - RHEL-07-040810
    - firewall
  
  - name: "MEDIUM | RHEL-07-040810 | AUDIT | The Red Hat Enterprise Linux operating system access control program must be configured to grant or deny system access to specific hosts and services."
    include_tasks: audit_iptables.yml
    when:
    - rhel_07_040810
    - rhel7stig_firewall_service != "firewalld"
    tags:
    - RHEL-07-040810
    - firewall
  
  - name: "MEDIUM | RHEL-07-040810 | AUDIT | The Red Hat Enterprise Linux operating system access control program must be configured to grant or deny system access to specific hosts and services."
    debug:
      msg: "Your configured firewall service is {{ rhel7stig_firewall_service }}, but you have set the variable rhel7stig_start_firewall_service to false. We cannot audit control RHEL-07-040810. Please set the variable rhel7stig_start_firewall_service to true in the defaults file of this role and re-run the playbook."
    changed_when: true
    when:
    - not rhel7stig_start_firewall_service
    tags:
    - RHEL-07-040810
    - firewall
  when:
  - rhel_07_040810
  - rhel7stig_disruptive
  tags:
  - RHEL-07-040810
  - firewall
  - disruption-high

- name: "MEDIUM | RHEL-07-040820 | PATCH | The Red Hat Enterprise Linux operating system must not have unauthorized IP tunnels configured."
  yum:
    name:
    - libreswan
    state: absent
    args:
      ansible_python_interpreter: "{{ python2_bin }}"
  when: 
  - rhel_07_040820
  tags:
  - RHEL-07-040820

- name: "MEDIUM | RHEL-07-040830 | PATCH | The Red Hat Enterprise Linux operating system must not forward IPv6 source-routed packets."
  sysctl:
    name: net.ipv6.conf.all.accept_source_route
    state: present
    value: 0
    reload: "{{ rhel7stig_sysctl_reload }}"
    ignoreerrors: yes
  when: 
  - rhel_07_040830
  tags:
  - RHEL-07-040830
  - ipv6

- name: "MEDIUM | RHEL-07-041001 | The Red Hat Enterprise Linux operating system must have the required packages for multifactor authentication installed."
  block:
  - name: "MEDIUM | RHEL-07-041001 | PATCH | The Red Hat Enterprise Linux operating system must have the required packages for multifactor authentication installed."
    yum:
      name:
      - esc
      - authconfig-gtk
      state: present
    args:
      ansible_python_interpreter: "{{ python2_bin }}"
    when: 
    - rhel7stig_gui

  - name: "MEDIUM | RHEL-07-041001 | PATCH | The Red Hat Enterprise Linux operating system must have the required packages for multifactor authentication installed."
    yum:
      name: pam_pkcs11
      state: present
    args:
      ansible_python_interpreter: "{{ python2_bin }}"

  when: 
  - rhel_07_041001
  tags:
  - RHEL-07-041001
  - multifactor

- name: "MEDIUM | RHEL-07-041002 | The Red Hat Enterprise Linux operating system must implement multifactor authentication for access to privileged accounts via pluggable authentication modules (PAM)."
  block:
  - name: "MEDIUM | RHEL-07-041002 | AUDIT | Check if pam service is configured in sssd file"
    command: 'grep -E "^\s*services\s*=.*pam" /etc/sssd/sssd.conf'
    check_mode: no
    changed_when:
    - sssd_services_check.rc == 1
    - not rhel7stig_skip_for_travis
    failed_when: no
    # todo: only run if sssd installed and config file present
    # failed_when: sssd_services_check.rc > 1
    register: sssd_services_check

  - name: "MEDIUM | RHEL-07-041002 | PATCH | The Red Hat Enterprise Linux operating system must implement multifactor authentication for access to privileged accounts via pluggable authentication modules (PAM)."
    debug:
      msg: "WARNING: SSSD is in use and /etc/sssd/sssd.conf is not configured to use the PAM service (services = nss, pam)"
    changed_when:
    - rhel7stig_audit_complex
    when: sssd_services_check.rc == 1
  when:
  - rhel7stig_auth_settings.use_sssd
  - rhel7stig_complex
  - rhel_07_041002
  tags:
  - RHEL-07-041002
  - complexity-high
  - sssd

- name: "MEDIUM | RHEL-07-041003 | The Red Hat Enterprise Linux operating system must implement certificate status checking for PKI authentication."
  replace:
    path: /etc/pam_pkcs11/pam_pkcs11.conf
    regexp: (?im)^([ \t]*cert_policy[ \t]*=(?:[^ \t\n]|[ \t](?!ocsp_on,))*?)(?:[ \t]ocsp_on,[ \t]*)?[ \t]*((?:[^,\n]|,(?![ \t]*ocsp_on,))*?)(?:,[ \t]*ocsp_on)?;$
    replace: '\1 ocsp_on, \2;'
  when: 
  - rhel_07_041003
  tags:
  - RHEL-07-041003

- name: "MEDIUM | RHEL-07-041010 | The Red Hat Enterprise Linux operating system must be configured so that all wireless network adapters are disabled."
  block:
  - name: "MEDIUM | RHEL-07-041010 | AUDIT | check if nmcli command is available"
    command: rpm -q NetworkManager
    args:
      warn: no
    check_mode: no
    changed_when: no
    register: rhel_07_nmcli_available
    failed_when: no

  - name: "MEDIUM | RHEL-07-041010 | AUDIT | check if wifi is enabled"
    command: nmcli radio wifi
    register: rhel_07_wifi_enabled
    check_mode: no
    changed_when: rhel_07_wifi_enabled.stdout != "disabled"
    when: rhel_07_nmcli_available.rc == 0

  - name: "MEDIUM | RHEL-07-041010 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all wireless network adapters are disabled."
    command: nmcli radio wifi off
    when: 
    - rhel_07_wifi_enabled is changed
  when: 
  - rhel_07_041010
  tags:
  - RHEL-07-041010

- name: "MEDIUM | RHEL-07-910055 | PATCH | The Red Hat Enterprise Linux operating system must protect audit information from unauthorized read, modification, or deletion"
  block:
  - name: "MEDIUM | RHEL-07-910055 | AUDIT | The Red Hat EnterpriseLinux operating system must protect audit information from unauthorized read, modification, or deletion | Get log files"
    find:
      paths: /var/log/audit 
    register: rhel_07_910055_audit_log_files

  - name: "MEDIUM | RHEL-07-910055 | PATCH | The Red Hat EnterpriseLinux operating system must protect audit information from unauthorized read, modification, or deletion | Apply permissions"
    file:
      path: "{{ item.path }}"
      owner: root
      group: root
      mode: 0600
    with_items:
    - "{{ rhel_07_910055_audit_log_files.files }}"
  when:
  - rhel_07_910055
  tags:
  - RHEL-07-910055
  - logs