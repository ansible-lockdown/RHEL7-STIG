---
- name: "MEDIUM | RHEL-07-010030 | PATCH | The operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a graphical user logon."
  command: "true"
  changed_when: no
  when:
      - rhel7stig_gui
      - rhel_07_010030
  tags:
      - RHEL-07-010030
      - dod_logon_banner
      - notimplemented

- name: "MEDIUM | RHEL-07-010040 | PATCH | The operating system must display the approved Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a graphical user logon."
  command: "true"
  changed_when: no
  when:
      - rhel7stig_gui
      - rhel_07_010040
  tags:
      - RHEL-07-010040
      - dod_logon_banner
      - notimplemented

- name: "MEDIUM | RHEL-07-010050 | PATCH | The operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a command line user logon."
  copy:
      content: "{{ rhel7stig_logon_banner }}"
      dest: "{{ item }}"
      owner: root
      group: root
      mode: 0644
  when:
      - rhel_07_010050
      - rhel7stig_ssh_required
  with_items:
      - /etc/issue
      - /etc/issue.net
  tags:
      - RHEL-07-010050
      - ssh
      - dod_logon_banner

- name: "MEDIUM | RHEL-07-010060 | PATCH | The operating system must enable a user session lock until that user re-establishes access using established identification and authentication procedures."
  command: "true"
  changed_when: no
  when:
      - rhel7stig_gui
      - rhel_07_010060
  tags:
      - RHEL-07-010060
      - notimplemented

- name: "MEDIUM | RHEL-07-010061 | PATCH | The operating system must uniquely identify and must authenticate users using multifactor authentication via a graphical user logon."
  command: "true"
  changed_when: no
  when:
      - rhel7stig_gui
      - rhel_07_010061
  tags:
      - RHEL-07-010061
      - notimplemented

- name: "MEDIUM | RHEL-07-010062 | PATCH | The operating system must prevent a user from overriding the screensaver lock-enabled setting for the graphical user interface."
  command: "true"
  changed_when: no
  when:
      - rhel7stig_gui
      - rhel_07_010062
  tags:
      - RHEL-07-010062
      - notimplemented

- name: "MEDIUM | RHEL-07-010070 | PATCH | The operating system must initiate a screensaver after a 15-minute period of inactivity for graphical user interfaces."
  command: "true"
  changed_when: no
  when:
      - rhel7stig_gui
      - rhel_07_010070
  tags:
      - RHEL-07-010070
      - notimplemented

- name: "MEDIUM | RHEL-07-010081 | PATCH | The operating system must set the lock delay setting for all connection types."
  command: "true"
  changed_when: no
  when:
      - rhel7stig_gui
      - rhel_07_010081
  tags:
      - RHEL-07-010081
      - notimplemented

- name: "MEDIUM | RHEL-07-010082 | PATCH | The operating system must set the session idle delay setting for all connection types."
  command: "true"
  changed_when: no
  when:
      - rhel7stig_gui
      - rhel_07_010082
  tags:
      - RHEL-07-010082
      - notimplemented

- name: "MEDIUM | RHEL-07-010090 | PATCH | The operating system must have the screen package installed."
  yum:
      name: screen
      state: present
  when: rhel_07_010090
  tags:
      - RHEL-07-010090

- name: "MEDIUM | RHEL-07-010100 | PATCH | The operating system must initiate a session lock for the screensaver after a period of inactivity for graphical user interfaces."
  command: "true"
  changed_when: no
  when:
      - rhel7stig_gui
      - rhel_07_010100
  tags:
      - RHEL-07-010100
      - notimplemented

- name: "MEDIUM | RHEL-07-010101 | PATCH | The operating system must prevent a user from overriding the screensaver idle-activation-enabled setting for the graphical user interface."
  command: "true"
  changed_when: no
  when:
      - rhel7stig_gui
      - rhel_07_010101
  tags:
      - RHEL-07-010101
      - notimplemented

- name: "MEDIUM | RHEL-07-010110 | PATCH | The operating system must initiate a session lock for graphical user interfaces when the screensaver is activated."
  command: "true"
  changed_when: no
  when:
      - rhel7stig_gui
      - rhel_07_010110
  tags:
      - RHEL-07-010110
      - notimplemented

- name: "MEDIUM | RHEL-07-010119 | PATCH | When passwords are changed or new passwords are established, pwquality must be used"
  lineinfile:
      create: yes
      dest: /etc/pam.d/passwd
      regexp: '^#?password required pam_pwquality.so retry'
      line: password required pam_pwquality.so retry=3
  when: rhel_07_010119
  tags:
      - RHEL-07-010119

- name: "MEDIUM | RHEL-07-010120 | PATCH | When passwords are changed or new passwords are established, the new password must contain at least one upper-case character."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*ucredit'
      line: "ucredit = {{rhel7stig_password_complexity.ucredit|default('-1')}}"
  when: rhel_07_010120
  tags:
      - RHEL-07-010120
      - pwquality

- name: "MEDIUM | RHEL-07-010130 | PATCH | When passwords are changed or new passwords are established, the new password must contain at least one lower-case character."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*lcredit'
      line: "lcredit = {{rhel7stig_password_complexity.lcredit|default('-1')}}"
  when: rhel_07_010130
  tags:
      - RHEL-07-010130
      - pwquality

- name: "MEDIUM | RHEL-07-010140 | PATCH | When passwords are changed or new passwords are assigned, the new password must contain at least one numeric character."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*dcredit'
      line: "dcredit = {{rhel7stig_password_complexity.dcredit|default('-1')}}"
  when: rhel_07_010140
  tags:
      - RHEL-07-010140
      - pwquality

- name: "MEDIUM | RHEL-07-010150 | PATCH | When passwords are changed or new passwords are assigned, the new password must contain at least one special character."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*ocredit'
      line: "ocredit = {{rhel7stig_password_complexity.ocredit|default('-1')}}"
  when: rhel_07_010150
  tags:
      - RHEL-07-010150
      - pwquality

- name: "MEDIUM | RHEL-07-010160 | PATCH | When passwords are changed a minimum of eight of the total number of characters must be changed."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*difok'
      line: "difok = {{rhel7stig_password_complexity.difok|default('8')}}"
  when: rhel_07_010160
  tags:
      - RHEL-07-010160
      - pwquality

- name: "MEDIUM | RHEL-07-010170 | PATCH | When passwords are changed a minimum of four character classes must be changed."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*minclass'
      line: "minclass = {{rhel7stig_password_complexity.minclass|default('4')}}"
  when: rhel_07_010170
  tags:
      - RHEL-07-010170
      - pwquality

- name: "MEDIUM | RHEL-07-010180 | PATCH | When passwords are changed the number of repeating consecutive characters must not be more than three characters."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*maxrepeat'
      line: "maxrepeat = {{rhel7stig_password_complexity.maxrepeat|default('3')}}"
  when: rhel_07_010180
  tags:
      - RHEL-07-010180
      - pwquality

- name: "MEDIUM | RHEL-07-010190 | PATCH | When passwords are changed the number of repeating characters of the same character class must not be more than four characters."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*maxclassrepeat'
      line: "maxclassrepeat = {{rhel7stig_password_complexity.maxclassrepeat|default('4')}}"
  when: rhel_07_010190
  tags:
      - RHEL-07-010190
      - pwquality

- name: "MEDIUM | RHEL-07-010200 | PATCH | The PAM system service must be configured to store only encrypted representations of passwords."
  pamd:
      name: system-auth
      state: "{{ item.state }}"
      type: password
      control: sufficient
      module_path: pam_unix.so
      module_arguments: "{{ item.args }}"
  with_items:
      - state: args_present
        args:
            - "sha512"
      - state: args_absent
        args:
            - "md5"
            - "bigcrypt"
            - "sha256"
            - "blowfish"
  when: rhel_07_010200
  tags:
      - RHEL-07-010200
      - pamd

- name: "MEDIUM | RHEL-07-010210 | PATCH | The shadow file must be configured to store only encrypted representations of passwords."
  lineinfile:
      dest: /etc/login.defs
      regexp: ^#?ENCRYPT_METHOD
      line: "ENCRYPT_METHOD {{rhel7stig_login_defaults.encrypt_method|default('SHA512')}}"
  when: rhel_07_010210
  tags:
      - RHEL-07-010210
      - login

- name: "MEDIUM | RHEL-07-010220 | PATCH | User and group account administration utilities must be configured to store only encrypted representations of passwords."
  lineinfile:
      dest: /etc/libuser.conf
      regexp: ^#?crypt_style
      line: crypt_style = sha512
  when: rhel_07_010220
  tags:
      - RHEL-07-010220

- name: "MEDIUM | RHEL-07-010230 | PATCH | Passwords for new users must be restricted to a 24 hours/1 day minimum lifetime."
  lineinfile:
      create: yes
      dest: /etc/login.defs
      regexp: ^#?PASS_MIN_DAYS
      line: "PASS_MIN_DAYS {{rhel7stig_login_defaults.pass_min_days|default('1')}}"
  when: rhel_07_010230
  tags:
      - RHEL-07-010230
      - login

- name: "MEDIUM | RHEL-07-010240 | Passwords must be restricted to a 24 hours/1 day minimum lifetime."
  block:
      - name: "MEDIUM | RHEL-07-010240 | AUDIT | Passwords must be restricted to a 24 hours/1 day minimum lifetime."
        command: "awk -F: '$1 !~ /^root$/ && $2 !~ /^[!*]/ && $4 < 1 {print $1}' /etc/shadow"
        check_mode: no
        changed_when: no
        register: rhel_07_010240_audit

      - name: "MEDIUM | RHEL-07-010240 | PATCH | Passwords must be restricted to a 24 hours/1 day minimum lifetime."
        command: chage -m 1 {{ item }}
        with_items: "{{ rhel_07_010240_audit.stdout_lines }}"
  when: rhel_07_010240
  tags:
      - RHEL-07-010240
      - password

- name: "MEDIUM | RHEL-07-010250 | PATCH | Passwords for new users must be restricted to a 60-day maximum lifetime."
  lineinfile:
      create: yes
      dest: /etc/login.defs
      regexp: ^#?PASS_MAX_DAYS
      line: "PASS_MAX_DAYS {{rhel7stig_login_defaults.pass_max_days|default('60')}}"
  when: rhel_07_010250
  tags:
      - RHEL-07-010250
      - login

- name: "MEDIUM | RHEL-07-010260 | Existing passwords must be restricted to a 60-day maximum lifetime."
  block:
      - name: "MEDIUM | RHEL-07-010260 | AUDIT | Existing passwords must be restricted to a 60-day maximum lifetime."
        command: "awk -F: '$1 !~ /^root$/ && $2 !~ /^[!*]/ && $5 > 60 {print $1}' /etc/shadow"
        check_mode: no
        changed_when: rhel_07_010260_audit.stdout != ""
        register: rhel_07_010260_audit

      - name: "MEDIUM | RHEL-07-010260 | PATCH | Reset password timeout to prevent locking out user."
        command: chage -d '-1 day' {{ item }}
        with_items: "{{ rhel_07_010260_audit.stdout_lines }}"

      - name: "MEDIUM | RHEL-07-010260 | PATCH | Existing passwords must be restricted to a 60-day maximum lifetime."
        command: chage -M 60 {{ item }}
        with_items: "{{ rhel_07_010260_audit.stdout_lines }}"
  when: rhel_07_010260
  tags:
      - RHEL-07-010260
      - password

- name: "MEDIUM | RHEL-07-010270 | PATCH | Passwords must be prohibited from reuse for a minimum of five generations."
  pamd:
      name: system-auth
      state: args_present
      type: password
      control: sufficient
      module_path: pam_unix.so
      module_arguments: "remember=5"
  when: rhel_07_010270
  tags:
      - RHEL-07-010270
      - pamd

- name: "MEDIUM | RHEL-07-010280 | PATCH | Passwords must be a minimum of 15 characters in length."
  lineinfile:
      create: yes
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*minlen'
      line: "minlen = {{rhel7stig_password_complexity.minlen|default('15')}}"
  when: rhel_07_010280
  tags:
      - RHEL-07-010280
      - pwquality

- name: "MEDIUM | RHEL-07-010310 | PATCH | The operating system must disable account identifiers (individuals, groups, roles, and devices) if the password expires."
  lineinfile:
      dest: /etc/default/useradd
      regexp: ^#?INACTIVE
      line: INACTIVE=0
  when: rhel_07_010310
  tags:
      - RHEL-07-010310

- block:
      - name: |
              "MEDIUM | RHEL-07-010320 | PATCH | Accounts subject to three unsuccessful login attempts within 15 minutes must be locked for the maximum configurable period."
              "MEDIUM | RHEL-07-010330 | PATCH | If three unsuccessful logon attempts within 15 minutes occur the associated account must be locked."
        pamd:
            name: "{{ item }}"
            state: before
            type: auth
            control: sufficient
            module_path: pam_unix.so
            new_type: auth
            new_control: required
            new_module_path: pam_faillock.so
            module_arguments: "preauth silent audit deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }} unlock_time={{ rhel7stig_pam_faillock.unlock_time }}"
        with_items:
            - "system-auth"
            - "password-auth"

      - name: "MEDIUM | RHEL-07-010330 | PATCH | If three unsuccessful logon attempts within 15 minutes occur the associated account must be locked."
        pamd:
            name: "{{ item }}"
            state: after
            type: auth
            control: sufficient
            module_path: pam_unix.so
            new_type: auth
            new_control: "[default=die]"
            new_module_path: pam_faillock.so
            module_arguments: "authfail audit deny={{ rhel7stig_pam_faillock.attempts }}{{ (rhel7stig_pam_faillock.fail_for_root) | ternary(' even_deny_root ',' ') }}fail_interval={{ rhel7stig_pam_faillock.interval }} unlock_time={{ rhel7stig_pam_faillock.unlock_time }}"
        with_items:
            - "system-auth"
            - "password-auth"

      - name: "MEDIUM | RHEL-07-010330 | PATCH | If three unsuccessful logon attempts within 15 minutes occur the associated account must be locked."
        pamd:
            name: "{{ item }}"
            state: before
            type: account
            control: required
            module_path: pam_unix.so
            new_type: account
            new_control: required
            new_module_path: pam_faillock.so
        with_items:
            - "system-auth"
            - "password-auth"

  when: rhel_07_010320 or rhel_07_010330
  tags:
      - RHEL-07-010320
      - RHEL-07-010330
      - pamd

- name: "MEDIUM | RHEL-07-010340 | PATCH | Users must provide a password for privilege escalation."
  replace:
      path: "{{ item }}"
      regexp: '^([^#].*)NOPASSWD(.*)'
      replace: '\1PASSWD\2'
      validate: '/usr/sbin/visudo -cf %s'
  with_items: "{{ rhel7stig_sudoers_files.stdout_lines }}"
  when:
      - rhel7stig_using_password_auth
      - rhel_07_010340
  tags:
      - RHEL-07-010340
      - sudoers

- name: "MEDIUM | RHEL-07-010350 | PATCH | Users must re-authenticate for privilege escalation."
  replace:
      path: "{{ item }}"
      regexp: '^([^#].*)!authenticate(.*)'
      replace: '\1authenticate\2'
      validate: '/usr/sbin/visudo -cf %s'
  with_items: "{{ rhel7stig_sudoers_files.stdout_lines }}"
  when: rhel_07_010350
  tags:
      - RHEL-07-010350
      - sudoers

- name: "MEDIUM | RHEL-07-010430 | PATCH | The delay between logon prompts following a failed console logon attempt must be at least four seconds."
  lineinfile:
      dest: /etc/login.defs
      regexp: ^#?FAIL_DELAY
      line: "FAIL_DELAY {{rhel7stig_login_defaults.fail_delay_secs|default('4')}}"
  when: rhel_07_010430
  tags:
      - RHEL-07-010430
      - login

- name: "MEDIUM | RHEL-07-010460 | PATCH | The operating system must not allow users to override SSH environment variables."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?PermitUserEnvironment"
      line: PermitUserEnvironment no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_010460
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-010460
      - ssh

- name: "MEDIUM | RHEL-07-010470 | PATCH | The operating system must not allow a non-certificate trusted host SSH logon to the system."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?HostbasedAuthentication"
      line: HostbasedAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-010470
      - ssh

# TODO: A user can still override the authentication requirement for single user mode in a couple ways that the STIG misses.
# This fix block does not check for those methods. i.e.
# User can override the rescue.service unit by placing a copy at /etc/systemd/system/rescue.service
# User can override some settings of the rescue.service unit by placing the overridden lines in /etc/systemd/system/rescue.service.d/override.conf
# Additionally the user can provide the -e or --force options to /usr/sbin/sulogin which will provide a root shell without password if the
# password file is inaccessbile or the root password is non-existent, LOCKED, or damaged.
- name: "MEDIUM | RHEL-07-010481 | PATCH | The operating system must require authentication upon booting into single-user and maintenance modes."
  block:
      - name: "MEDIUM | RHEL-07-010481 | PATCH | Check if the packaged rescue.service file was edited directly"
        shell: "cat /usr/lib/systemd/system/rescue.service | grep 'ExecStart=.*/usr/sbin/sulogin'"
        changed_when: no
        failed_when: no
        check_mode: no
        register: systemd_rescue_unit_check

      - name: "MEDIUM | RHEL-07-010481 | PATCH | Force reinstall systemd package to replace edited /usr/lib/systemd/system/rescue.service"
        shell: yum -y reinstall systemd
        when: systemd_rescue_unit_check.rc == 1
  when: rhel_07_010481
  tags:
      - RHEL-07-010481
      - rescue

- name: "MEDIUM | RHEL-07-010500 | PATCH | The operating system must uniquely identify and must authenticate organizational users (or processes acting on behalf of organizational users) using multifactor authentication."
  command: "true"
  changed_when: no
  when: rhel_07_010500
  tags:
      - RHEL-07-010500
      - notimplemented

- name: "MEDIUM | RHEL-07-020020 | PATCH | The operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures."
  command: "true"
  changed_when: no
  when: rhel_07_020020
  tags:
      - RHEL-07-020020
      - notimplemented

- name: |
        "MEDIUM | RHEL-07-020030 | PATCH | A file integrity tool must verify the baseline operating system configuration at least weekly."
        "MEDIUM | RHEL-07-020040 | PATCH | Designated personnel must be notified if baseline configurations are changed in an unauthorized manner."
  cron:
      name: 'Run AIDE integrity check {{ rhel7stig_aide_cron.special_time }}'
      user: "{{ rhel7stig_aide_cron.user }}"
      cron_file: "{{ rhel7stig_aide_cron.cron_file }}"
      job: "{{ rhel7stig_aide_cron.job + ((rhel7stig_aide_cron.notify_by_mail) | ternary(rhel7stig_aide_cron.notify_cmd,'')) }}"
      minute: "{{ rhel7stig_aide_cron.minute | default((rhel7stig_cron_special_disable and
              rhel7stig_aide_cron.special_time in ['hourly', 'daily', 'weekly', 'monthly']) |
              ternary('0', omit)) | default(omit) }}"
      hour: "{{ rhel7stig_aide_cron.hour | default((rhel7stig_cron_special_disable and
              rhel7stig_aide_cron.special_time in ['daily', 'weekly', 'monthly']) |
              ternary('0', omit)) | default(omit) }}"
      weekday: "{{ rhel7stig_aide_cron.weekday | default((rhel7stig_cron_special_disable and
              rhel7stig_aide_cron.special_time in ['weekly']) |
              ternary('0', omit)) | default(omit) }}"
      day: "{{ rhel7stig_aide_cron.day | default((rhel7stig_cron_special_disable and
              rhel7stig_aide_cron.special_time in ['monthly']) |
              ternary('1', omit)) | default(omit) }}"
      special_time: "{{ (rhel7stig_cron_special_disable and
              rhel7stig_aide_cron.special_time in ['hourly', 'daily', 'weekly', 'monthly']) |
              ternary(omit, rhel7stig_aide_cron.special_time) }}"
  when: rhel_07_020030 or rhel_07_020040
  tags:
      - RHEL-07-020030
      - RHEL-07-020040
      - aide

- name: "MEDIUM | RHEL-07-020100 | PATCH | USB mass storage must be disabled."
  lineinfile:
      dest: /etc/modprobe.d/blacklist.conf
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
      create: yes
      owner: root
      group: root
      mode: "0644"
  with_items:
      - regexp: "^(#)?blacklist usb-storage(\\s|$)"
        line: 'blacklist usb-storage'
      - regexp: "^(#)?install usb-storage"
        line: 'install usb-storage /bin/false'
  when: rhel_07_020100
  tags:
      - RHEL-07-020100
      - usb_devices

- name: "MEDIUM | RHEL-07-020101 | PATCH | The Datagram Congestion Control Protocol (DCCP) kernel module must be disabled unless required."
  lineinfile:
      dest: /etc/modprobe.d/nodccp.conf
      regexp: "^(#)?install dccp /bin/true(\\s|$)"
      line: 'install dccp /bin/true'
      create: yes
      owner: root
      group: root
      mode: "0644"
  when: rhel_07_020101
  tags:
      - RHEL-07-020101
      - dccp

- name: "MEDIUM | RHEL-07-020110 | PATCH | File system automounter must be disabled unless required."
  shell: "systemctl show autofs | grep LoadState | cut -d = -f 2"
  register: rhel_07_020110_autofs_service_status
  changed_when: no
  check_mode: no
  when:
      - rhel_07_020110
  tags:
      - RHEL-07-020110

- name: "MEDIUM | RHEL-07-020110 | PATCH | File system automounter must be disabled unless required."
  service:
      name: autofs
      enabled: no
      state: stopped
  when:
      - rhel_07_020110
      - rhel_07_020110_autofs_service_status == "loaded"
      - not rhel7stig_autofs_required
  tags:
      - RHEL-07-020110

- name: "MEDIUM | RHEL-07-020240 | PATCH | The operating system must define default permissions for all authenticated users in such a way that the user can only read and modify their own files."
  lineinfile:
      dest: /etc/login.defs
      regexp: ^#?UMASK
      line: "UMASK {{rhel7stig_login_defaults.umask|default('077')}}"
  when: rhel_07_020240
  tags:
      - RHEL-07-020240
      - login
      - umask

- name: "MEDIUM | RHEL-07-020260 | PATCH | Vendor packaged system security patches and updates must be installed and up to date."
  block:
      - name: "MEDIUM | RHEL-07-020260 | AUDIT | Check RHEL type"
        command: rpm -q redhat-release-workstation
        check_mode: no
        changed_when: no
        failed_when: no
        register: rhel_07_020260_rhel_type

      - block:
            - name: "MEDIUM | RHEL-07-020260 | PATCH | Vendor packaged system security patches and updates must be installed and up to date. | Install yum-cron"
              yum:
                  name: yum-cron
                  state: "{{ (rhel7stig_auto_package_updates.enabled) | ternary('present','absent')}}"
                  enablerepo: "{{ (ansible_distribution == 'RedHat') | ternary('rhel-7-' +
                          (rhel_07_020260_rhel_type.rc == 0) | ternary('workstation', 'server') +
                          '-optional-rpms','') }}"
        rescue:
              # Might be an AWS RHEL instance, try it...
            - name: "MEDIUM | RHEL-07-020260 | PATCH | Vendor packaged system security patches and updates must be installed and up to date. | Install yum-cron"
              yum:
                  name: yum-cron
                  state: "{{ (rhel7stig_auto_package_updates.enabled) | ternary('present','absent')}}"
                  enablerepo: rhui-REGION-rhel-server-optional

      - name: "MEDIUM | RHEL-07-020260 | PATCH | Vendor packaged system security patches and updates must be installed and up to date. | Verify yum-cron config file exists"
        stat:
            path: "/etc/yum/yum-cron{{ (rhel7stig_auto_package_updates.frequency == 'hourly') | ternary('-hourly','')}}.conf"
        check_mode: no
        register: yum_cron_config_file

      - name: "MEDIUM | RHEL-07-020260 | PATCH | Vendor packaged system security patches and updates must be installed and up to date. | Enable/disable automatic updates in the appropriate yum-cron.conf file."
        lineinfile:
            dest: "/etc/yum/yum-cron{{ (rhel7stig_auto_package_updates.frequency == 'hourly') | ternary('-hourly','')}}.conf"
            regexp: "^apply_updates"
            line: "apply_updates = {{ (rhel7stig_auto_package_updates.enabled) | ternary('yes','no')}}"
            state: present
        when: yum_cron_config_file.stat.exists

      - name: "MEDIUM | RHEL-07-020260 | PATCH | Vendor packaged system security patches and updates must be installed and up to date. | Set update command to configured setting."
        lineinfile:
            dest: "/etc/yum/yum-cron{{ (rhel7stig_auto_package_updates.frequency == 'hourly') | ternary('-hourly','')}}.conf"
            regexp: "^update_cmd"
            line: "update_cmd = {{rhel7stig_auto_package_updates.update_cmd|default('minimal-security')}}"
            state: present
        when: yum_cron_config_file.stat.exists

      - name: "MEDIUM | RHEL-07-020260 | PATCH | Vendor packaged system security patches and updates must be installed and up to date. | Verify the yum-cron service exists"
        shell: "systemctl show yum-cron | grep LoadState | cut -d = -f 2"
        register: rhel_07_020260_yumcron_service_status
        changed_when: no
        check_mode: no

      - name: "MEDIUM | RHEL-07-020260 | PATCH | Vendor packaged system security patches and updates must be installed and up to date. | Set the yum-cron service state"
        service:
            name: yum-cron
            enabled: "{{ rhel7stig_auto_package_updates.enabled }}"
            state: "{{ (rhel7stig_auto_package_updates.enabled) | ternary(rhel7stig_service_started, 'stopped')}}"
        when: rhel_07_020260_yumcron_service_status.stdout == "loaded"

  when: rhel_07_020260
  tags:
      - RHEL-07-020260
      - packaging

- name: "MEDIUM | RHEL-07-020270 | The system must not have unnecessary accounts."
  block:
      - name: "MEDIUM | RHEL-07-020270 | AUDIT | The system must not have unnecessary accounts."
        command: "grep '^{{ item }}:' /etc/passwd"
        check_mode: no
        failed_when: rhel_07_020270_audit.rc > 1
        changed_when: rhel_07_020270_audit.rc == 0
        register: rhel_07_020270_audit
        with_items: "{{ rhel7stig_unnecessary_accounts }}"

      - name: "MEDIUM | RHEL-07-020270 | PATCH | The system must not have unnecessary accounts."
        user:
            name: "{{ item }}"
            state: absent
            remove: "{{ rhel7stig_remove_unnecessary_user_files }}"
        register: rhel_07_020270_patch
        with_items: "{{ rhel7stig_unnecessary_accounts }}"

      - name: "MEDIUM | RHEL-07-020270 | AUDIT | Re-parse /etc/passwd since it changed."
        include_tasks: parse_etc_passwd.yml
        vars:
            rhel7stig_passwd_tasks: "RHEL-07-020270"
        when: rhel_07_020270_patch is changed
  when: rhel_07_020270
  tags:
      - RHEL-07-020270

- name: "MEDIUM | RHEL-07-020320 | All files and directories must have a valid owner."
  block:
      - name: "MEDIUM | RHEL-07-020320 | AUDIT | All files and directories must have a valid owner."
        command: find "{{ item.mount }}" -xdev -nouser
        check_mode: no
        register: rhel_07_020320_audit
        failed_when: no
        changed_when: no
        when: item['device'].startswith('/dev') and not 'bind' in item['options']
        with_items: "{{ ansible_mounts }}"

      - name: "MEDIUM | RHEL-07-020320 | PATCH | All files and directories must have a valid owner."
        debug:
            msg: "Manual intervention is required -- missing owner on items in {{ item.item.mount }}: {{ item.stdout_lines | join(', ') }}"
        changed_when:
            - rhel7stig_audit_complex
        when:
            - item.stdout_lines is defined
            - item.stdout_lines | length > 0
        with_items: "{{ rhel_07_020320_audit.results }}"
  when:
      - rhel_07_020320
      - rhel7stig_complex
  tags:
      - RHEL-07-020320
      - complexity-high

- name: "MEDIUM | RHEL-07-020330 | All files and directories must have a valid group owner."
  block:
      - name: "MEDIUM | RHEL-07-020330 | AUDIT | All files and directories must have a valid group owner."
        command: find "{{ item.mount }}" -xdev -nogroup
        check_mode: no
        register: rhel_07_020330_audit
        failed_when: no
        changed_when: no
        when: item['device'].startswith('/dev') and not 'bind' in item['options']
        with_items: "{{ ansible_mounts }}"

      - name: "MEDIUM | RHEL-07-020330 | PATCH | All files and directories must have a valid group owner."
        debug:
            msg: "Manual intervention is required -- missing group on items in {{ item.item.mount }}: {{ item.stdout_lines | join(', ') }}"
        changed_when:
            - rhel7stig_audit_complex
        when:
            - item.stdout_lines is defined
            - item.stdout_lines | length > 0
        with_items: "{{ rhel_07_020330_audit.results }}"
  when:
      - rhel_07_020330
      - rhel7stig_complex
  tags:
      - RHEL-07-020330
      - complexity-high

- name: "MEDIUM | RHEL-07-020600 | PATCH | All local interactive users must have a home directory assigned in the /etc/passwd file."
  command: "true"
  changed_when: no
  when: rhel_07_020600
  tags:
      - RHEL-07-020600
      - notimplemented

- name: "MEDIUM | RHEL-07-020610 | PATCH | All local interactive user accounts, upon creation, must be assigned a home directory."
  lineinfile:
      dest: /etc/login.defs
      regexp: ^#?CREATE_HOME
      line: "CREATE_HOME {{rhel7stig_login_defaults.create_home|default('yes')}}"
  when: rhel_07_020610
  tags:
      - RHEL-07-020610
      - login
      - home

- name: "MEDIUM | RHEL-07-020620 | PATCH | All local interactive user home directories defined in the /etc/passwd file must exist."
  file:
      path: "{{ item.dir }}"
      state: directory
  with_items: "{{ rhel7stig_passwd }}"
  loop_control:
      label: "{{ rhel7stig_passwd_label }}"
  when:
      - rhel_07_020620
      - item.uid >= 1000
  tags:
      - RHEL-07-020620

- name: "MEDIUM | RHEL-07-020630 | PATCH | All local interactive user home directories must have mode 0750 or less permissive."
  file:
      path: "{{ item.dir }}"
      mode: "{{ rhel7stig_homedir_mode }}"
      state: directory
  with_items: "{{ rhel7stig_passwd }}"
  loop_control:
      label: "{{ rhel7stig_passwd_label }}"
  when:
      - rhel_07_020630
      - item.uid >= 1000
  tags:
      - RHEL-07-020630

- name: "MEDIUM | RHEL-07-020640 | PATCH | All local interactive user home directories must be owned by their respective users."
  file:
      path: "{{ item.dir }}"
      owner: "{{ item.id }}"
      state: directory
  with_items: "{{ rhel7stig_passwd }}"
  loop_control:
      label: "{{ rhel7stig_passwd_label }}"
  when:
      - rhel_07_020640
      - item.uid >= 1000
  tags:
      - RHEL-07-020640

- name: "MEDIUM | RHEL-07-020650 | PATCH | All local interactive user home directories must be group-owned by the home directory owners primary group."
  file:
      path: "{{ item.dir }}"
      group: "{{ item.gid }}"
      state: directory
  with_items: "{{ rhel7stig_passwd }}"
  loop_control:
      label: "{{ rhel7stig_passwd_label }}"
  when:
      - rhel_07_020650
      - item.uid >= 1000
  tags:
      - RHEL-07-020650

- name: "MEDIUM | RHEL-07-020660 | All files and directories contained in local interactive user home directories must be owned by the owner of the home directory."
  block:
      - name: "MEDIUM | RHEL-07-020660 | AUDIT | All files and directories contained in local interactive user home directories must be owned by the owner of the home directory."
        command: "{{ find_command_base }} -print -quit"
        check_mode: no
        changed_when: rhel_07_020660_audit.stdout != ""
        register: rhel_07_020660_audit
        with_items: "{{ rhel7stig_passwd }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - this_item.uid >= 1000
        vars:
            this_item: "{{ item }}"

      - name: "MEDIUM | RHEL-07-020660 | PATCH | All files and directories contained in local interactive user home directories must be owned by the owner of the home directory."
        command: "{{ find_command_base }} -exec chown {{ this_item.uid }} {} +"
        with_items: "{{ rhel_07_020660_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - item is changed
        vars:
            this_item: "{{ item.item }}"
  vars:
      find_command_base: 'find "{{ this_item.dir }}" -mindepth 1
             ( -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*" -type f ) -o
             -not -user {{ this_item.uid }}'
  when: rhel_07_020660
  tags:
      - RHEL-07-020660

- name: "MEDIUM | RHEL-07-020670 | All files and directories contained in local interactive user home directories must be group-owned by a group of which the home directory owner is a member."
  block:
      - name: "MEDIUM | RHEL-07-020670 | AUDIT | Get all GIDs for each user."
        command: id -G "{{ item.id }}"
        check_mode: no
        changed_when: no
        register: rhel_07_all_gid_audit
        with_items: "{{ rhel7stig_passwd }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"

      - name: "MEDIUM | RHEL-07-020670 | AUDIT | All files and directories contained in local interactive user home directories must be group-owned by a group of which the home directory owner is a member."
        command: "{{ find_command_base }} -print -quit"
        check_mode: no
        changed_when: rhel_07_020670_audit.stdout != ""
        register: rhel_07_020670_audit
        with_items: "{{ rhel_07_all_gid_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - this_item.uid >= 1000
        vars:
            this_item: "{{ item.item }}"
            this_result: "{{ item }}"

      - name: "MEDIUM | RHEL-07-020670 | PATCH | All files and directories contained in local interactive user home directories must be group-owned by a group of which the home directory owner is a member."
        command: "{{ find_command_base }} -exec chgrp {{ this_item.gid }} {} +"
        with_items: "{{ rhel_07_020670_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - item is changed
        vars:
            this_item: "{{ item.item.item }}"
            this_result: "{{ item.item }}"
  vars:
      find_command_base: 'find "{{ this_item.dir }}" -mindepth 1
              ( -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*" -type f ) -o
              -not -group {{ this_result.stdout.split(" ") | join(" -not -group ") }}'
  when: rhel_07_020670
  tags:
      - RHEL-07-020670

- name: "MEDIUM | RHEL-07-020680 | PATCH | All files and directories contained in local interactive user home directories must have mode 0750 or less permissive."
  command: "true"
  changed_when: no
  when: rhel_07_020680
  tags:
      - RHEL-07-020680
      - notimplemented

- name: "MEDIUM | RHEL-07-020690 | All local initialization files for interactive users must be owned by the home directory user or root."
  block:
      - name: "MEDIUM | RHEL-07-020690 | AUDIT | All local initialization files for interactive users must be owned by the home directory user or root."
        command: "{{ find_command_base }} -print -quit"
        check_mode: no
        changed_when: rhel_07_020690_audit.stdout != ""
        register: rhel_07_020690_audit
        with_items: "{{ rhel7stig_passwd }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - this_item.uid >= 1000
        vars:
            this_item: "{{ item }}"

      - name: "MEDIUM | RHEL-07-020690 | PATCH | All local initialization files for interactive users must be owned by the home directory user or root."
        command: "{{ find_command_base }} -exec chown {{ this_item.uid }} {} +"
        with_items: "{{ rhel_07_020690_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - item is changed
        vars:
            this_item: "{{ item.item }}"
  vars:
      find_command_base: 'find "{{ this_item.dir }}" -mindepth 1 -type f
              -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*"
              -not ( -user {{ this_item.uid }} -o -user root )'
  when: rhel_07_020690
  tags:
      - RHEL-07-020690

- name: "MEDIUM | RHEL-07-020700 | Local initialization files for local interactive users must be group-owned by the users primary group or root."
  block:
      - name: "MEDIUM | RHEL-07-020700 | AUDIT | Local initialization files for local interactive users must be group-owned by the users primary group or root."
        command: "{{ find_command_base }} -print -quit"
        check_mode: no
        changed_when: rhel_07_020700_audit.stdout != ""
        register: rhel_07_020700_audit
        with_items: "{{ rhel7stig_passwd }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - this_item.uid >= 1000
        vars:
            this_item: "{{ item }}"

      - name: "MEDIUM | RHEL-07-020700 | PATCH | Local initialization files for local interactive users must be group-owned by the users primary group or root."
        command: "{{ find_command_base }} -exec chgrp {{ this_item.gid }} {} +"
        with_items: "{{ rhel_07_020700_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when:
            - item is changed
        vars:
            this_item: "{{ item.item }}"
  vars:
      find_command_base: 'find "{{ this_item.dir }}" -mindepth 1 -type f
              -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*"
              -not ( -group {{ this_item.gid }} -o -group root )'
  when: rhel_07_020700
  tags:
      - RHEL-07-020700

- name: "MEDIUM | RHEL-07-020710 | PATCH | All local initialization files must have mode 0740 or less permissive."
  command: "true"
  changed_when: no
  when: rhel_07_020710
  tags:
      - RHEL-07-020710
      - notimplemented

- name: "MEDIUM | RHEL-07-020720 | PATCH | All local initialization files must have mode 0740 or less permissive."
  command: "true"
  changed_when: no
  when: rhel_07_020720
  tags:
      - RHEL-07-020720
      - notimplemented

- name: "MEDIUM | RHEL-07-020730 | PATCH | Local initialization files must not execute world-writable programs."
  command: "true"
  changed_when: no
  when: rhel_07_020730
  tags:
      - RHEL-07-020730
      - notimplemented

- name: "MEDIUM | RHEL-07-020900 | AUDIT | All system device files must be correctly labeled to prevent unauthorized modification."
  block:
      - name: "MEDIUM | RHEL-07-020900 | AUDIT | All system device files must be correctly labeled to prevent unauthorized modification."
        command: find {{ rhel7stig_local_mounts | join(' ') }} -xdev ( -context *:device_t:* -o -context *:unlabeled_t:* ) ( -type c -o -type b ) -printf '%p %Z\n'
        changed_when: no
        check_mode: no
        register: rhel_07_020900_audit

      - name: "MEDIUM | RHEL-07-020900 | AUDIT | All system device files must be correctly labeled to prevent unauthorized modification."
        debug:
            msg: "{{ rhel_07_020900_audit.stdout_lines }}"
        changed_when:
            - rhel7stig_audit_complex
        when:
            - rhel_07_020900_audit.stdout_lines | length > 0

  when:
      - rhel_07_020900
      - rhel7stig_complex
      - ansible_selinux.status == "enabled"
  tags:
      - RHEL-07-020900
      - complexity-high

- name: "MEDIUM | RHEL-07-021000 | PATCH | File systems that contain user home directories must be mounted to prevent files with the setuid and setgid bit set from being executed."
  mount:
      path: /home
      state: mounted
      src: "{{ home_mount.device }}"
      fstype: "{{ home_mount.fstype }}"
      opts: "{{ home_mount.options }},nosuid"
  when:
      - rhel_07_021000
      - ansible_mounts | selectattr('mount', 'match', '^/home$') | list | length != 0
      - "'nosuid' not in home_mount.options"
  vars:
      home_mount: "{{ ansible_mounts | json_query('[?mount == `/home`] | [0]') }}"
  tags:
      - RHEL-07-021000

- name: "MEDIUM | RHEL-07-021010 | PATCH | File systems that are used with removable media must be mounted to prevent files with the setuid and setgid bit set from being executed."
  command: "true"
  changed_when: no
  when: rhel_07_021010
  tags:
      - RHEL-07-021010
      - notimplemented

- name: "MEDIUM | RHEL-07-021020 | PATCH | File systems that are being imported via Network File System (NFS) must be mounted to prevent files with the setuid and setgid bit set from being executed."
  mount:
      path: "{{ item }}"
      src: "{{ ansible_mounts | json_query(device_query) }}"
      fstype: "{{ ansible_mounts | json_query(fstype_query) }}"
      opts: "{{ ansible_mounts | json_query(options_query) }},nosuid"
      state: mounted
  vars:
      device_query: '[?mount == `{{ item }}`] | [0].device'
      fstype_query: '[?mount == `{{ item }}`] | [0].fstype'
      options_query: '[?mount == `{{ item }}`] | [0].options'
  with_items: "{{ rhel7stig_nfs_mounts }}"
  when:
      - rhel_07_021020
      - "'nosuid' not in (ansible_mounts | json_query(options_query))"
  tags:
      - RHEL-07-021020

- name: "MEDIUM | RHEL-07-021021 | PATCH | File systems that are being imported via Network File System (NFS) must be mounted to prevent binary files from being executed."
  mount:
      path: "{{ item }}"
      src: "{{ ansible_mounts | json_query(device_query) }}"
      fstype: "{{ ansible_mounts | json_query(fstype_query) }}"
      opts: "{{ ansible_mounts | json_query(options_query) }},noexec"
      state: mounted
  vars:
      device_query: '[?mount == `{{ item }}`] | [0].device'
      fstype_query: '[?mount == `{{ item }}`] | [0].fstype'
      options_query: '[?mount == `{{ item }}`] | [0].options'
  with_items: "{{ rhel7stig_nfs_mounts }}"
  when:
      - rhel_07_021021
      - "'noexec' not in (ansible_mounts | json_query(options_query))"
  tags:
      - RHEL-07-021021

- name: "MEDIUM | RHEL-07-021030 | PATCH | All world-writable directories must be group-owned by root, sys, bin, or an application group."
  block:
      - name: "MEDIUM | RHEL-07-021030 | AUDIT | All world-writable directories must be group-owned by root, sys, bin, or an application group."
        command: find {{ rhel7stig_local_mounts | join(' ') }} -xdev -type d -perm -002 -gid +999
        changed_when: rhel_07_021030_audit.stdout != ""
        check_mode: no
        register: rhel_07_021030_audit

      - name: "MEDIUM | RHEL-07-021030 | PATCH | All world-writable directories must be group-owned by root, sys, bin, or an application group."
        file:
            path: "{{ item }}"
            group: root
        check_mode: "{{ rhel7stig_disruptive_check_mode }}"
        with_items: "{{ rhel_07_021030_audit.stdout_lines }}"

  when:
      - rhel_07_021030
      - rhel7stig_disruptive
  tags:
      - RHEL-07-021030
      - disruption-high

- name: "MEDIUM | RHEL-07-021040 | PATCH | The umask must be set to 077 for all local interactive user accounts."
  command: "true"
  changed_when: no
  when: rhel_07_021040
  tags:
      - RHEL-07-021040
      - notimplemented

- name: "MEDIUM | RHEL-07-021100 | PATCH | Cron logging must be implemented."
  lineinfile:
      path: /etc/rsyslog.conf
      state: present
      regexp: '^cron\.\*[ \t]+/var/log/cron$'
      line: 'cron.*                                                  /var/log/cron'
      insertafter: '#### RULES ####'
  register: result
  failed_when:
      - result is failed
      - result.rc != 257
  when: rhel_07_021100
  tags:
      - RHEL-07-021100

- name: |
        MEDIUM | RHEL-07-021110 | PATCH | If the cron.allow file exists it must be owned by root.
        MEDIUM | RHEL-07-021120 | PATCH | If the cron.allow file exists it must be group-owned by root.
  block:
      - name: "MEDIUM | RHEL-07-021110, RHEL-07-021120 | PATCH | Check if cron.allow file exists"
        stat:
            path: /etc/cron.allow
        register: cron_allow_file_check

      - name: "MEDIUM | RHEL-07-021110, RHEL-07-021120 | PATCH | Set cron.allow file owner and group-owner to root"
        file:
            dest: /etc/cron.allow
            state: file
            owner: root
            group: root
            mode: 0600
        when: cron_allow_file_check.stat.exists
  when:
      - rhel_07_021110
      - rhel_07_021120
  tags:
      - RHEL-07-021110
      - RHEL-07-021120
      - cron

- block:
      - name: "MEDIUM | RHEL-07-021300 | PATCH | Kernel core dumps must be disabled unless needed."
        shell: "systemctl show kdump | grep LoadState | cut -d = -f 2"
        register: rhel_07_021300_kdump_service_status
        changed_when: no
        check_mode: no

      - name: "MEDIUM | RHEL-07-021300 | PATCH | Kernel core dumps must be disabled unless needed."
        service:
            name: kdump
            enabled: no
            state: stopped
        when:
            - rhel_07_021300_kdump_service_status.stdout == "loaded"
            - not rhel7stig_kdump_required
  when: rhel_07_021300
  tags:
      - RHEL-07-021300

- name: "MEDIUM | RHEL-07-021620 | PATCH | The file integrity tool must use FIPS 140-2 approved cryptographic hashes for validating file contents and directories."
  block:
      - name: "Replace sha256+sha512 entries with sha512"
        replace:
            path: /etc/aide.conf
            regexp: '([A-Z]+ = .*)(sha256\+sha512)(.*)'
            replace: '\1sha512\3'
        register: rhel_07_021620_sha256_512_result
        notify: "{{ rhel7stig_aide_handler }}"

      - name: "Replace sha256 entries with sha512"
        replace:
            path: /etc/aide.conf
            regexp: '([A-Z]+ = .*)(sha256)(.*)'
            replace: '\1sha512\3'
        register: rhel_07_021620_sha256_result
        notify: "{{ rhel7stig_aide_handler }}"

  when: rhel_07_021620
  tags:
      - aide
      - RHEL-07-021620

- name: "MEDIUM | RHEL-07-021700 | PATCH | The system must not allow removable media to be used as the boot loader unless approved."
  command: "true"
  changed_when: no
  when: rhel_07_021700
  tags:
      - RHEL-07-021700
      - notimplemented

- name: "MEDIUM | RHEL-07-030010 | PATCH | The operating system must shut down upon audit processing failure, unless availability is an overriding concern. If availability is a concern, the system must alert the designated staff (System Administrator [SA] and Information System Security Officer [ISSO] at a minimum) in the event of an audit processing failure."
  lineinfile:
      path: /etc/audit/rules.d/audit.rules
      regexp: "^-f "
      line: "-f {{ rhel7stig_auditd_failure_flag }}"
  notify: update running audit failure mode
  when: rhel_07_030010
  tags:
      - RHEL-07-030010

- name: "MEDIUM | RHEL-07-030300 | PATCH | The operating system must off-load audit records onto a different system or media from the system being audited."
  command: "true"
  changed_when: no
  when: rhel_07_030300
  tags:
      - RHEL-07-030300
      - notimplemented

- name: "MEDIUM | RHEL-07-030310 | PATCH | The operating system must encrypt the transfer of audit records off-loaded onto a different system or media from the system being audited."
  lineinfile:
      path: /etc/audisp/audisp-remote.conf
      regexp: ^enable_krb5 +=
      line: enable_krb5 = yes
  when: rhel_07_030310
  tags:
      - RHEL-07-030310

- name: "MEDIUM | RHEL-07-030320 | PATCH | The audit system must take appropriate action when the audit storage volume is full."
  lineinfile:
      path: /etc/audisp/audisp-remote.conf
      regexp: ^disk_full_action +=
      line: "disk_full_action = {{ rhel7stig_audisp_disk_full_action }}"
  when: rhel_07_030320
  tags:
      - RHEL-07-030320

- name: "MEDIUM | RHEL-07-030321 | PATCH | The audit system must take appropriate action when there is an error sending audit records to a remote system."
  lineinfile:
      path: /etc/audisp/audisp-remote.conf
      regexp: ^network_failure_action +=
      line: "network_failure_action = {{ rhel7stig_audisp_network_failure_action }}"
  when: rhel_07_030321
  tags:
      - RHEL-07-030321

- name: "MEDIUM | RHEL-07-030330 | PATCH | The operating system must immediately notify the System Administrator (SA) and Information System Security Officer ISSO (at a minimum) when allocated audit record storage volume reaches 75% of the repository maximum audit record storage capacity."
  lineinfile:
      path: /etc/audit/auditd.conf
      regexp: ^space_left +=
      line: "space_left = {{ [rhel7stig_auditd_space_left|int, 51] | min }}"
  when: rhel_07_030330
  tags:
      - auditd
      - RHEL-07-030330

- name: "MEDIUM | RHEL-07-030340 | PATCH | The operating system must immediately notify the System Administrator (SA) and Information System Security Officer (ISSO) (at a minimum) via email when the threshold for the repository maximum audit record storage capacity is reached."
  lineinfile:
      path: /etc/audit/auditd.conf
      regexp: ^space_left_action +=
      line: "space_left_action = email"
  register: rhel7stig_auditd_space_left_action_result
  failed_when:
      - rhel7stig_auditd_space_left_action_result is failed
      - rhel7stig_auditd_space_left_action_result.rc != 257
  when: rhel_07_030340
  tags:
      - RHEL-07-030340

- name: "MEDIUM | RHEL-07-030350 | PATCH | The operating system must immediately notify the System Administrator (SA) and Information System Security Officer (ISSO) (at a minimum) when the threshold for the repository maximum audit record storage capacity is reached."
  lineinfile:
      path: /etc/audit/auditd.conf
      regexp: ^action_mail_acct +=
      line: "action_mail_acct = {{ rhel7stig_auditd_mail_acct }}"
  register: rhel7stig_auditd_action_mail_acct_result
  failed_when:
      - rhel7stig_auditd_action_mail_acct_result is failed
      - rhel7stig_auditd_action_mail_acct_result.rc != 257
  when: rhel_07_030350
  tags:
      - RHEL-07-030350

- name: "MEDIUM | RHEL-07-030360 | PATCH | All privileged function executions must be audited."
  block:
      - name: "MEDIUM | RHEL-07-030360 | AUDIT | All privileged function executions must be audited. (find suid/sgid programs)"
        command: find {{ rhel7stig_local_mounts | join(' ') }} -xdev -type f ( -perm -4000 -o -perm -2000 )
        check_mode: no
        changed_when: no
        register: rhel_07_030360_audit

      - name: "MEDIUM | RHEL-07-030360 | All privileged function executions must be audited."
        lineinfile:
            path: "/etc/audit/rules.d/rhel7stig_suid_sgid_commands.rules"
            create: yes
            owner: root
            group: root
            mode: 0600
            line: "-a always,exit -F path={{ item }} -F perm=x -F auid>=1000 -F auid!=4294967295 -k setuid/setgid"
            state: present
        with_items: "{{ rhel_07_030360_audit.stdout_lines }}"
  when: rhel_07_030360
  tags:
      - RHEL-07-030360

- name: "MEDIUM | Auditing system calls"
  include_tasks: audit_system_call.yml
  with_items:
      - id: "030370"
        call: "chown"
        key: "perm_mod"
      - id: "030380"
        call: "fchown"
        key: "perm_mod"
      - id: "030390"
        call: "lchown"
        key: "perm_mod"
      - id: "030400"
        call: "fchownat"
        key: "perm_mod"
      - id: "030410"
        call: "chmod"
        key: "perm_mod"
      - id: "030420"
        call: "fchmod"
        key: "perm_mod"
      - id: "030430"
        call: "fchmodat"
        key: "perm_mod"
      - id: "030440"
        call: "setxattr"
        key: "perm_mod"
      - id: "030450"
        call: "fsetxattr"
        key: "perm_mod"
      - id: "030460"
        call: "lsetxattr"
        key: "perm_mod"
      - id: "030470"
        call: "removexattr"
        key: "perm_mod"
      - id: "030480"
        call: "fremovexattr"
        key: "perm_mod"
      - id: "030490"
        call: "lremovexattr"
        key: "perm_mod"
      - id: "030500"
        call: "creat"
        extra_fields: "-F exit=-EPERM"
        key: "access"
      - id: "030500"
        call: "creat"
        extra_fields: "-F exit=-EACCES"
        key: "access"
      - id: "030510"
        call: "open"
        extra_fields: "-F exit=-EPERM"
        key: "access"
      - id: "030510"
        call: "open"
        extra_fields: "-F exit=-EACCES"
        key: "access"
      - id: "030520"
        call: "openat"
        extra_fields: "-F exit=-EPERM"
        key: "access"
      - id: "030520"
        call: "openat"
        extra_fields: "-F exit=-EACCES"
        key: "access"
      - id: "030530"
        call: "open_by_handle_at"
        extra_fields: "-F exit=-EPERM"
        key: "access"
      - id: "030530"
        call: "open_by_handle_at"
        extra_fields: "-F exit=-EACCES"
        key: "access"
      - id: "030540"
        call: "truncate"
        extra_fields: "-F exit=-EACCES"
        key: "access"
      - id: "030540"
        call: "truncate"
        extra_fields: "-F exit=-EPERM"
        key: "access"
      - id: "030550"
        call: "ftruncate"
        extra_fields: "-F exit=-EACCES"
        key: "access"
      - id: "030550"
        call: "ftruncate"
        extra_fields: "-F exit=-EPERM"
        key: "access"
      - id: "030740"
        call: "mount"
        key: "privileged-mount"
      - id: "030819"
        call: "create_module"
        include_all_auids: yes
        key: "module-change"
      - id: "030820"
        call: "init_module"
        include_all_auids: yes
        key: "module-change"
      - id: "030821"
        call: "finit_module"
        include_all_auids: yes
        key: "module-change"
      - id: "030830"
        call: "delete_module"
        include_all_auids: yes
        key: "module-change"
      - id: "030880"
        call: "rename"
        key: "delete"
      - id: "030890"
        call: "renameat"
        key: "delete"
      - id: "030900"
        call: "rmdir"
        key: "delete"
      - id: "030910"
        call: "unlink"
        key: "delete"
      - id: "030920"
        call: "unlinkat"
        key: "delete"
  tags:
      - audit-rules

- name: "MEDIUM | Auditing commands"
  include_tasks: audit_command.yml
  with_items:
      - id: "030560"
        path: "/usr/sbin/semanage"
        key: "privileged-priv_change"
      - id: "030570"
        path: "/usr/sbin/setsebool"
        key: "privileged-priv_change"
      - id: "030580"
        path: "/usr/bin/chcon"
        key: "privileged-priv_change"
      - id: "030590"
        path: "/usr/sbin/setfiles"
        key: "privileged-priv_change"
      - id: "030630"
        path: "/usr/bin/passwd"
        key: "privileged-passwd"
      - id: "030640"
        path: "/usr/sbin/unix_chkpwd"
        key: "privileged-passwd"
      - id: "030650"
        path: "/usr/bin/gpasswd"
        key: "privileged-passwd"
      - id: "030660"
        path: "/usr/bin/chage"
        key: "privileged-passwd"
      - id: "030670"
        path: "/usr/sbin/userhelper"
        key: "privileged-passwd"
      - id: "030680"
        path: "/usr/bin/su"
        key: "privileged-priv_change"
      - id: "030690"
        path: "/usr/bin/sudo"
        key: "privileged-priv_change"
      - id: "030710"
        path: "/usr/bin/newgrp"
        key: "privileged-priv_change"
      - id: "030720"
        path: "/usr/bin/chsh"
        key: "privileged-priv_change"
      - id: "030730"
        path: "/usr/bin/sudoedit"
        key: "privileged-priv_change"
      - id: "030740"
        path: "/usr/bin/mount"
        key: "privileged-mount"
      - id: "030740"
        path: "/usr/bin/mount"
        key: "privileged-mount"
      - id: "030750"
        path: "/usr/bin/umount"
        key: "privileged-mount"
      - id: "030760"
        path: "/usr/sbin/postdrop"
        key: "privileged-postfix"
      - id: "030770"
        path: "/usr/sbin/postqueue"
        key: "privileged-postfix"
      - id: "030780"
        path: "/usr/libexec/openssh/ssh-keysign"
        key: "privileged-ssh"
      - id: "030800"
        path: "/usr/bin/crontab"
        key: "privileged-cron"
      - id: "030810"
        path: "/usr/sbin/pam_timestamp_check"
        key: "privileged-pam"
      - id: "030840"
        path: "/usr/sbin/insmod"
        trivial: yes
        key: "module-change"
      - id: "030850"
        path: "/usr/sbin/rmmod"
        trivial: yes
        key: "module-change"
      - id: "030860"
        path: "/usr/sbin/modprobe"
        trivial: yes
        key: "module-change"
  tags:
      - audit-rules

- name: "MEDIUM | Auditing files"
  include_tasks: audit_file.yml
  with_items:
      - id: "030600"
        path: "/var/log/tallylog"
        description: "successful/unsuccessful account access count events"
        key: "logins"
      - id: "030610"
        path: "/var/run/faillock"
        description: "unsuccessful account access events"
        key: "logins"
      - id: "030620"
        path: "/var/log/lastlog"
        description: "successful account access events"
        key: "logins"
      - id: "030700"
        path: "/etc/sudoers"
        description: "modifications to sudoers"
        key: "privileged-actions"
      - id: "030700"
        path: "/etc/sudoers.d/"
        description: "modifications to sudoers"
        key: "privileged-actions"
      - id: "030870"
        path: "/etc/passwd"
        description: "account creations, modifications, disabling, and termination events that affect /etc/passwd"
        key: "identity"
      - id: "030871"
        path: "/etc/group"
        description: "account creations, modifications, disabling, and termination events that affect /etc/group"
        key: "identity"
      - id: "030872"
        path: "/etc/gshadow"
        description: "account creations, modifications, disabling, and termination events that affect /etc/gshadow"
        key: "identity"
      - id: "030873"
        path: "/etc/shadow"
        description: "account creations, modifications, disabling, and termination events that affect /etc/shadow"
        key: "identity"
      - id: "030874"
        path: "/etc/security/opasswd"
        description: "account creations, modifications, disabling, and termination events that affect /etc/security/opasswd"
        key: "identity"
  tags:
      - audit-rules

- name: "MEDIUM | RHEL-07-031000 | PATCH | The system must send rsyslog output to a log aggregation server."
  blockinfile:
      path: /etc/rsyslog.conf
      state: present
      block: |
          $ActionQueueFileName rhel-07-031000  # unique name prefix for spool files
          $ActionQueueMaxDiskSpace 1g    # 1gb space limit (use as much as possible)
          $ActionQueueSaveOnShutdown on  # save messages to disk on shutdown
          $ActionQueueType LinkedList    # run asynchronously
          $ActionResumeRetryCount -1     # infinite retries if host is down
          # remote host is: name/ip:port, e.g. 192.168.0.1:514, port optional
          *.* @@{{ rhel7stig_log_aggregation_server }}
      insertafter: EOF
  register: result
  failed_when:
      - result is failed
      - result.rc != 257
  when:
      - rhel_07_031000
      - rhel7stig_log_aggregation_server is defined
  tags:
      - RHEL-07-031000
      - rsyslog

- name: "MEDIUM | RHEL-07-031010 | PATCH | The rsyslog daemon must not accept log messages from other servers unless the server is being used for log aggregation."
  replace:
      path: /etc/rsyslog.conf
      regexp: '({{ item }})'
      replace: '#\1'
  with_items:
      - '^(\$ModLoad imtcp)'
      - '^(\$ModLoad imudp)'
      - '^(\$UDPServerRun)'
      - '^(\$InputTCPServerRun)'
  when:
      - rhel_07_031010
      - not rhel7stig_system_is_log_aggregator
  register: result
  failed_when:
      - result is failed
      - result.rc != 257
  tags:
      - RHEL-07-031010
      - rsyslog

- name: "MEDIUM | RHEL-07-032010 | AUDIT | The system must update the DoD-approved virus scan program every seven days or more frequently."
  block:
      - name: "MEDIUM | RHEL-07-032010 | AUDIT | The system must update the DoD-approved virus scan program every seven days or more frequently."
        shell: "{{ rhel7stig_av_status_command }}"
        changed_when: no
        check_mode: no
        register: rhel_07_032010_audit

      - name: "MEDIUM | RHEL-07-032010 | AUDIT | The system must update the DoD-approved virus scan program every seven days or more frequently."
        debug:
            msg: "{{ rhel_07_032010_audit.stdout_lines }}"
        changed_when:
            - rhel7stig_audit_complex
        when:
            - rhel_07_032010_audit.stdout_lines | length > 0

  when:
      - rhel_07_032010
      - rhel7stig_complex
  tags:
      - RHEL-07-032010
      - complexity-high

- name: "MEDIUM | RHEL-07-040100 | PATCH | The host must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
  command: "true"
  changed_when: no
  when: rhel_07_040100
  tags:
      - RHEL-07-040100
      - notimplemented

- name: "MEDIUM | RHEL-07-040110 | PATCH | A FIPS 140-2 approved cryptographic algorithm must be used for SSH communications."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?Ciphers"
      line: Ciphers aes128-ctr,aes192-ctr,aes256-ctr
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040110
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040110
      - ssh

- name: "MEDIUM | RHEL-07-040160 | PATCH | All network connections associated with a communication session must be terminated at the  the session or after 10 minutes of inactivity from the user at a command prompt, except to fulfill documented and validated mission requirements."
  blockinfile:
      create: yes
      mode: 0644
      dest: "{{ item.dest }}"
      state: "{{ item.state }}"
      marker: "# {mark} ANSIBLE MANAGED"
      block: |
        # Set session timeout - STIG ID RHEL-07-040160
        TMOUT={{rhel7stig_shell_session_timeout.timeout}}
        readonly TMOUT
        export TMOUT
  with_items:
      - dest: "{{ rhel7stig_shell_session_timeout.file }}"
        state: present
      - dest: /etc/profile
        state: "{{ (rhel7stig_shell_session_timeout.file == '/etc/profile') | ternary('present', 'absent') }}"
  when: rhel_07_040160
  tags:
      - RHEL-07-040160
      - profile

- name: "MEDIUM | RHEL-07-040170 | PATCH | The Standard Mandatory DoD Notice and Consent Banner must be displayed immediately prior to, or as part of, remote access logon prompts."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?Banner"
      line: Banner /etc/issue
      validate: /usr/sbin/sshd -tf %s
  notify: restart sshd
  when:
      - rhel_07_040170
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040170
      - ssh
      - dod_logon_banner

- name: "MEDIUM | RHEL-07-040180 | The operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) authentication communications."
  block:
      - name: "MEDIUM | RHEL-07-040180 | AUDIT | The operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) authentication communications."
        command: grep -i useldapauth /etc/sysconfig/authconfig
        check_mode: no
        register: rhel_07_040180_audit
        failed_when: no
        # todo only run this if authconfig is installed, or the file exists
        # do we want to create it?
        # failed_when: rhel_07_040180_audit.rc > 1
        changed_when:
            - rhel_07_040180_audit.rc == 1
            - not rhel7stig_skip_for_travis

      - name: "MEDIUM | RHEL-07-040180 | PATCH | The operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) authentication communications."
        command: "true"
        changed_when: no
        when: "'yes' in rhel_07_040180_audit.stdout"
  when: rhel_07_040180
  tags:
      - RHEL-07-040180
      - ldap
      - notimplemented

- name: "MEDIUM | RHEL-07-040190 | PATCH | The operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) communications."
  command: "true"
  changed_when: no
  when: rhel_07_040190
  tags:
      - RHEL-07-040190
      - notimplemented

- name: "MEDIUM | RHEL-07-040200 | PATCH | The operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) communications."
  command: "true"
  changed_when: no
  when: rhel_07_040200
  tags:
      - RHEL-07-040200
      - notimplemented

- name: "MEDIUM | RHEL-07-040201 | PATCH | The operating system must implement virtual address space randomization."
  sysctl:
      name: kernel.randomize_va_space
      value: 2
      state: present
      reload: "{{ rhel7stig_sysctl_reload }}"
      sysctl_set: yes
      ignoreerrors: yes
  when: rhel_07_040201
  tags:
      - RHEL-07-040201
      - sysctl

- name: "MEDIUM | RHEL-07-040300 | PATCH | All networked systems must have SSH installed."
  yum:
      name:
          - openssh-clients
          - openssh-server
      state: present
  when:
      - rhel_07_040300
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040300
      - ssh

- name: "MEDIUM | RHEL-07-040310 | PATCH | All networked systems must use SSH for confidentiality and integrity of transmitted and received information as well as information during preparation for transmission."
  service:
      name: sshd
      state: "{{ rhel7stig_service_started }}"
      enabled: yes
  when:
      - rhel_07_040310
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040310
      - ssh

- name: "MEDIUM | RHEL-07-040320 | PATCH | All network connections associated with SSH traffic must terminate at the end of the session or after 10 minutes of inactivity, except to fulfill documented and validated mission requirements."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?ClientAliveInterval"
      line: ClientAliveInterval {{ rhel7stig_ssh_session_timeout }}
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040320
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040320
      - ssh

- name: "MEDIUM | RHEL-07-040330 | PATCH | The SSH daemon must not allow authentication using RSA rhosts authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?RhostsRSAAuthentication"
      line: RhostsRSAAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040330
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040330
      - ssh

- name: "MEDIUM | RHEL-07-040340 | PATCH | All network connections associated with SSH traffic must terminate after a period of inactivity."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?ClientAliveCountMax"
      line: ClientAliveCountMax 0
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040340
      - rhel7stig_ssh_required
      - ansible_distribution_version is not version_compare('7.4', '>=') or
        rhel7stig_workaround_for_disa_benchmark or
        rhel7stig_workaround_for_ssg_benchmark
  tags:
      - RHEL-07-040340
      - ssh

- name: "MEDIUM | RHEL-07-040350 | PATCH | The SSH daemon must not allow authentication using rhosts authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?IgnoreRhosts"
      line: IgnoreRhosts yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040350
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040350
      - ssh

- name: "MEDIUM | RHEL-07-040360 | PATCH | The system must display the date and time of the last successful account logon upon an SSH logon."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?PrintLastLog"
      line: PrintLastLog yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040360
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040360
      - ssh

- name: "MEDIUM | RHEL-07-040370 | PATCH | The system must not permit direct logons to the root account using remote access via SSH."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?PermitRootLogin"
      line: PermitRootLogin no
      insertafter: '(?i)^#?authentication'
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040370
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040370
      - ssh

- name: "MEDIUM | RHEL-07-040380 | PATCH | The SSH daemon must not allow authentication using known hosts authentication."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?IgnoreUserKnownHosts"
      line: IgnoreUserKnownHosts yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040380
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040380
      - ssh

- name: "MEDIUM | RHEL-07-040400 | PATCH | The SSH daemon must be configured to only use Message Authentication Codes (MACs) employing FIPS 140-2 approved cryptographic hash algorithms."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?MACs"
      line: MACs hmac-sha2-256,hmac-sha2-512
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040400
      - rhel7stig_ssh_required
  tags:
      - ssh
      - RHEL-07-040400

- name: "MEDIUM | RHEL-07-040410 | The SSH public host key files must have mode 0644 or less permissive."
  block:
      - name: "MEDIUM | RHEL-07-040410 | AUDIT | The SSH public host key files must have mode 0644 or less permissive."
        find:
            paths: /etc/ssh
            recurse: yes
            file_type: file
            patterns: 'ssh_host*_key.pub'
            hidden: true
        failed_when: no
        changed_when: no
        register: rhel_07_040410_audit

      - name: "MEDIUM | RHEL-07-040410 | PATCH | The SSH public host key files must have mode 0644 or less permissive."
        file:
            dest: "{{ item.path }}"
            mode: u-x,go-wx
            state: file
        with_items: "{{ rhel_07_040410_audit.files | default([]) }}"
  when:
      - rhel_07_040410
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040410
      - ssh

- name: "MEDIUM | RHEL-07-040420 | The SSH private host key files must have mode 0600 or less permissive."
  block:
      - name: "MEDIUM | RHEL-07-040420 | AUDIT | The SSH private host key files must have mode 0600 or less permissive."
        find:
            paths: /etc/ssh
            recurse: yes
            file_type: file
            patterns: 'ssh_host*_key'
            hidden: true
        failed_when: no
        changed_when: no
        register: rhel_07_040420_audit

      - name: "MEDIUM | RHEL-07-040420 | PATCH | The SSH private host key files must have mode 0600 or less permissive."
        file:
            dest: "{{ item.path }}"
            mode: u-x,go-rwx
            state: file
        with_items: "{{ rhel_07_040420_audit.files | default([]) }}"
  when:
      - rhel_07_040420
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040420
      - ssh

- name: "MEDIUM | RHEL-07-040430 | PATCH | The SSH daemon must not permit Generic Security Service Application Program Interface (GSSAPI) authentication unless needed."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?GSSAPIAuthentication"
      line: GSSAPIAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040430
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040430
      - ssh

- name: "MEDIUM | RHEL-07-040440 | PATCH | The SSH daemon must not permit Kerberos authentication unless needed."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?KerberosAuthentication"
      line: KerberosAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040440
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040440
      - ssh

- name: "MEDIUM | RHEL-07-040450 | PATCH | The SSH daemon must perform strict mode checking of home directory configuration files."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?StrictModes"
      line: StrictModes yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040450
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040450
      - ssh

- name: "MEDIUM | RHEL-07-040460 | PATCH | The SSH daemon must use privilege separation."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?UsePrivilegeSeparation"
      line: UsePrivilegeSeparation sandbox
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040460
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040460
      - ssh

- name: "MEDIUM | RHEL-07-040470 | PATCH | The SSH daemon must not allow compression or must only allow compression after successful authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?Compression"
      line: Compression no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  when:
      - rhel_07_040470
      - rhel7stig_ssh_required
  tags:
      - RHEL-07-040470
      - ssh

- block:
      - name: "MEDIUM | RHEL-07-040500 | PATCH | The operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        yum:
            name: chrony
            state: absent

      - name: "MEDIUM | RHEL-07-040500 | PATCH | The operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        yum:
            name: ntp
            state: present

      - name: "MEDIUM | RHEL-07-040500 | PATCH | The operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        lineinfile:
            create: yes
            dest: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].conf }}"
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
        notify: restart {{ rhel7stig_time_service }}
        with_items: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].lines }}"
  when:
      - rhel7stig_time_service == 'ntpd'
      - rhel_07_040500
  tags:
      - RHEL-07-040500
      - ntp
      - ntpd

- block:
      - name: "MEDIUM | RHEL-07-040500 | PATCH | The operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        yum:
            name: ntp
            state: absent

      - name: "MEDIUM | RHEL-07-040500 | PATCH | The operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        yum:
            name: chrony
            state: present

      - name: "MEDIUM | RHEL-07-040500 | PATCH | The operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        replace:
            dest: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].conf }}"
            regexp: '^server \S+( \w+)?$'
        notify: restart {{ rhel7stig_time_service }}
  when:
      - rhel7stig_time_service == 'chronyd'
      - rhel_07_040500
  tags:
      - RHEL-07-040500
      - chronyd

- name: "MEDIUM | RHEL-07-040500 | PATCH | The operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
  blockinfile:
      insertbefore: BOF
      dest: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].conf }}"
      block: "{{ rhel7stig_time_service_configs[rhel7stig_time_service].block }}"
      state: present
  notify: restart {{ rhel7stig_time_service }}
  when:
      - rhel7stig_time_service == 'chronyd'
      - rhel_07_040500
  tags:
      - RHEL-07-040500
      - chronyd

- name: "MEDIUM | RHEL-07-040510 | PATCH | The operating system must protect against or limit the effects of Denial of Service (DoS) attacks by validating the operating system is implementing rate-limiting measures on impacted network interfaces."
  command: "true"
  changed_when: no
  when: rhel_07_040510
  tags:
      - RHEL-07-040510
      - firewall
      - notimplemented

- name: "MEDIUM | RHEL-07-040520 | PATCH | The operating system must enable an application firewall, if available."
  yum:
      name: "{{ rhel7stig_firewall_service }}"
      state: present
  when: rhel_07_040520
  tags:
      - RHEL-07-040520
      - firewall

- name: "MEDIUM | RHEL-07-040520 | PATCH | The system must use a local firewall."
  service:
      name: "{{ rhel7stig_firewall_service }}"
      state: "{{ rhel7stig_service_started }}"
      enabled: yes
  # XXX: fix this.  The above task should work just fine in a chroot, but
  # fails for some reason when the chroot is also a container.
  ignore_errors: "{{ rhel7stig_system_is_chroot and rhel7stig_system_is_container }}"
  when: rhel_07_040520
  tags:
      - RHEL-07-040520
      - firewall

- name: "MEDIUM | RHEL-07-040610 | PATCH | The system must not forward Internet Protocol version 4 (IPv4) source-routed packets."
  sysctl:
      name: net.ipv4.conf.all.accept_source_route
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040610
  tags:
      - RHEL-07-040610
      - ipv4

- name: "MEDIUM | RHEL-07-040620 | PATCH | The system must not forward Internet Protocol version 4 (IPv4) source-routed packets by default."
  sysctl:
      name: net.ipv4.conf.default.accept_source_route
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040620
  tags:
      - RHEL-07-040620
      - ipv4

- name: "MEDIUM | RHEL-07-040630 | PATCH | The system must not respond to Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) echoes sent to a broadcast address."
  sysctl:
      name: net.ipv4.icmp_echo_ignore_broadcasts
      state: present
      value: 1
      sysctl_set: yes
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040630
  tags:
      - RHEL-07-040630
      - ipv4

- name: "MEDIUM | RHEL-07-040640 | PATCH | The system must ignore to Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages."
  sysctl:
      name: net.ipv4.conf.default.accept_redirects
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040640
  tags:
      - RHEL-07-040640
      - ipv4

- name: "MEDIUM | RHEL-07-040641 | PATCH | The system must ignore Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages."
  sysctl:
      name: net.ipv4.conf.all.accept_redirects
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040641
  tags:
      - RHEL-07-040641
      - ipv4

- name: "MEDIUM | RHEL-07-040650 | PATCH |  The system must not allow interfaces to perform Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirects by default."
  sysctl:
      name: net.ipv4.conf.default.send_redirects
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040650
  tags:
      - RHEL-07-040650
      - ipv4

- name: "MEDIUM | RHEL-07-040660 | PATCH | The system must not send Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirects."
  sysctl:
      name: net.ipv4.conf.all.send_redirects
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040660
  tags:
      - RHEL-07-040660
      - ipv4

- block:
      - name: "MEDIUM | RHEL-07-040670 | PATCH | Network interfaces must not be in promiscuous mode."
        shell: "ip link | grep -i promisc | cut -d ':' -f 2"
        check_mode: no
        failed_when: no
        changed_when: rhel_07_040670_promisc_check.stdout != ''
        ignore_errors: yes
        register: rhel_07_040670_promisc_check

      - name: "MEDIUM | RHEL-07-040670 | PATCH | Network interfaces must not be in promiscuous mode."
        shell: "ip link set dev {{ item }} promisc off"
        with_items: "{{ rhel_07_040670_promisc_check.stdout_lines }}"

  when:
      - rhel_07_040670
      - not rhel7stig_net_promisc_mode_required
  tags:
      - RHEL-07-040670

- block:
      - name: "MEDIUM | RHEL-07-040680 | AUDIT | Check if postfix is installed."
        command: rpm -q postfix
        failed_when: no
        check_mode: no
        changed_when: no
        register: rhel_07_040680_rpm_audit

      - name: "MEDIUM | RHEL-07-040680 | AUDIT | The system must be configured to prevent unrestricted mail relaying."
        command: "/usr/sbin/postconf -n smtpd_client_restrictions"
        check_mode: no
        changed_when: no
        register: rhel_07_040680_postconf_audit
        when: rhel_07_040680_rpm_audit.rc == 0

      - name: "MEDIUM | RHEL-07-040680 | PATCH | The system must be configured to prevent unrestricted mail relaying."
        command: "/usr/sbin/postconf -e 'smtpd_client_restrictions=permit_mynetworks, reject'"
        when:
            - rhel_07_040680_rpm_audit.rc == 0
            - rhel_07_040680_postconf_audit.stdout != 'smtpd_client_restrictions = permit_mynetworks, reject'

  tags:
      - RHEL-07-040680

- name: "MEDIUM | RHEL-07-040720 | PATCH | If the Trivial File Transfer Protocol (TFTP) server is required, the TFTP daemon must be configured to operate in secure mode."
  lineinfile:
      path: /etc/xinetd.d/tftp
      regexp: "(?i)^.*server_args.*="
      line: "\tserver_args\t\t= -s /var/lib/tftpboot"
      insertafter: "\tserver\t\t\t="
      state: present
  register: result
  failed_when:
      - result is failed
      - result.rc != 257
  when:
      - rhel7stig_tftp_required
      - rhel_07_040720
  tags:
      - RHEL-07-040720

- name: "MEDIUM | RHEL-07-040730 | PATCH | An X Window display manager must not be installed unless approved."
  yum:
      name:
          - "@x11"
          - xorg-x11-server-common
      state: absent
  when:
      - not rhel7stig_gui
      - rhel_07_040730
  tags:
      - RHEL-07-040730
      - x11

- name: "MEDIUM | RHEL-07-040740 | PATCH | The system must not be performing packet forwarding unless the system is a router."
  sysctl:
      name: net.ipv4.ip_forward
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when:
      - not rhel7stig_system_is_router
      - rhel_07_040740
  tags:
      - RHEL-07-040740
      - ipv4

- name: "MEDIUM | RHEL-07-040750 | PATCH | The Network File System (NFS) must be configured to use RPCSEC_GSS."
  command: "true"
  changed_when: no
  when: rhel_07_040750
  tags:
      - RHEL-07-040750
      - notimplemented

- name: "MEDIUM | RHEL-07-040810 | PATCH | The system's access control program must be configured to grant or deny system access to specific hosts and services."
  command: "true"
  changed_when: no
  when: rhel_07_040810
  tags:
      - RHEL-07-040810
      - notimplemented

- name: "MEDIUM | RHEL-07-040820 | PATCH | The system must not have unauthorized IP tunnels configured."
  yum:
      name:
          - libreswan
      state: absent
  when: rhel_07_040820
  tags:
      - RHEL-07-040820

- name: "MEDIUM | RHEL-07-040830 | PATCH | The system must not forward IPv6 source-routed packets."
  sysctl:
      name: net.ipv6.conf.all.accept_source_route
      state: present
      value: 0
      reload: "{{ rhel7stig_sysctl_reload }}"
      ignoreerrors: yes
  when: rhel_07_040830
  tags:
      - RHEL-07-040830
      - ipv6

- block:
      - name: "MEDIUM | RHEL-07-041001 | PATCH | The operating system must have the required packages for multifactor authentication installed."
        yum:
            name:
                - esc
                - authconfig-gtk
            state: present
        when: rhel7stig_gui

      - name: "MEDIUM | RHEL-07-041001 | PATCH | The operating system must have the required packages for multifactor authentication installed."
        yum:
            name: pam_pkcs11
            state: present

  when: rhel_07_041001
  tags:
      - RHEL-07-041001
      - multifactor

- name: "MEDIUM | RHEL-07-041002 | The operating system must implement multifactor authentication for access to privileged accounts via pluggable authentication modules (PAM)."
  block:
      - name: "MEDIUM | RHEL-07-041002 | AUDIT | Check if pam service is configured in sssd file"
        command: 'grep -E "^\s*services\s*=.*pam" /etc/sssd/sssd.conf'
        check_mode: no
        changed_when:
            - sssd_services_check.rc == 1
            - not rhel7stig_skip_for_travis
        failed_when: no
        # todo: only run if sssd installed and config file present
        # failed_when: sssd_services_check.rc > 1
        register: sssd_services_check

      - name: "MEDIUM | RHEL-07-041002 | PATCH | The operating system must implement multifactor authentication for access to privileged accounts via pluggable authentication modules (PAM)."
        debug:
            msg: "WARNING: SSSD is in use and /etc/sssd/sssd.conf is not configured to use the PAM service (services = nss, pam)"
        changed_when:
            - rhel7stig_audit_complex
        when: sssd_services_check.rc == 1
  when:
      - rhel7stig_auth_settings.use_sssd
      - rhel7stig_complex
      - rhel_07_041002
  tags:
      - RHEL-07-041002
      - complexity-high
      - sssd

- name: "MEDIUM | RHEL-07-041003 | PATCH | The operating system must implement certificate status checking for PKI authentication."
  command: "true"
  changed_when: no
  when: rhel_07_041003
  tags:
      - RHEL-07-041003
      - notimplemented

- name: "MEDIUM | RHEL-07-041010 | Wireless network adapters must be disabled."
  block:
      - name: "MEDIUM | RHEL-07-041010 | AUDIT | check if nmcli command is available"
        command: rpm -q NetworkManager
        args:
            warn: no
        check_mode: no
        changed_when: no
        register: rhel_07_nmcli_available
        failed_when: no

      - name: "MEDIUM | RHEL-07-041010 | AUDIT | check if wifi is enabled"
        command: nmcli radio wifi
        register: rhel_07_wifi_enabled
        check_mode: no
        changed_when: rhel_07_wifi_enabled.stdout != "disabled"
        when: rhel_07_nmcli_available.rc == 0

      - name: "MEDIUM | RHEL-07-041010 | PATCH | Wireless network adapters must be disabled."
        command: nmcli radio wifi off
        when: rhel_07_wifi_enabled is changed
  when: rhel_07_041010
  tags:
      - RHEL-07-041010
